<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ å¦™è›™å®¸çš„ç†±è¡€æˆ°å ´ ğŸ”¥</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; color: #fff; padding: 20px; margin: 0; overflow-x: hidden; }
        .container { max-width: 900px; margin: 0 auto; padding-top: 20px; position: relative; }
        
        /* Navbar */
        .navbar { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; background: #16213e; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #0f3460; gap: 10px; }
        .user-section { display: flex; align-items: center; gap: 15px; width: 100%; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #f1c40f; object-fit: cover; }
        .user-stats { flex: 1; }
        .user-name { font-weight: bold; color: #4cc9f0; }
        .money-badge { color: #f1c40f; font-size: 0.9em; margin-left: 10px; }
        
        /* ç©å®¶è¡€æ¢ */
        .player-hp-box { width: 100%; background: #333; height: 10px; border-radius: 5px; margin-top: 5px; overflow: hidden; position: relative; }
        .player-hp-fill { height: 100%; background: #2ecc71; width: 100%; transition: width 0.3s; }
        .player-hp-text { font-size: 0.8em; color: #ccc; margin-left: 5px; }

        .btn-group-nav { display: flex; gap: 10px; }
        .btn-logout { background: transparent; border: 1px solid #e74c3c; color: #e74c3c; padding: 5px 15px; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .btn-logout:hover { background: #e74c3c; color: white; }
        .btn-shop { background: #f1c40f; border: none; color: #000; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; background: #0f3460; border: none; color: #aaa; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: #e94560; color: white; transform: translateY(-3px); }
        .game-section { display: none; }
        .game-section.active { display: block; }

        /* Cards */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .card { background: #0f3460; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.5); position: relative; }
        .card-img { width: 100%; height: 150px; object-fit: cover; background: #fff; }
        .card-body { padding: 10px; }
        .card-title { margin: 0; font-weight: bold; color: #fff; }
        .hp-bar-bg { background: #333; height: 8px; border-radius: 4px; margin: 8px 0; overflow: hidden; }
        .hp-bar-fill { background: #e74c3c; height: 100%; width: 100%; transition: width 0.3s; }
        
        .btn-attack { width: 100%; background: #c0392b; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
        .btn-attack:active { transform: scale(0.95); }

        /* Floating Damage */
        .floating-damage { position: absolute; color: #ffeb3b; font-weight: bold; font-size: 24px; pointer-events: none; animation: floatUp 0.8s ease-out forwards; text-shadow: 2px 2px 0 #000; z-index: 100; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 50% { transform: translateY(-30px) scale(1.5); opacity: 1; } 100% { transform: translateY(-60px) scale(1); opacity: 0; } }
        .shaking { animation: shake 0.5s; border: 2px solid red; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 20% { transform: translate(-3px, 0px); } 40% { transform: translate(1px, -1px); } 60% { transform: translate(-3px, 1px); } 80% { transform: translate(-1px, -1px); } 100% { transform: translate(0, 0); } }

        /* Battle Log */
        .battle-log-panel { background: #16213e; border: 2px solid #0f3460; border-radius: 10px; height: 200px; padding: 10px; overflow-y: auto; margin-top: 20px; }
        .log-entry { font-size: 0.9em; border-bottom: 1px solid #333; padding: 4px 0; }

        /* Gacha Animation */
        .gacha-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
        .pokeball { width: 100px; height: 100px; border-radius: 50%; background: white; border: 5px solid #333; position: relative; animation: shake-ball 1s infinite; }
        .pokeball::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%; background: #e74c3c; border-bottom: 5px solid #333; border-radius: 50px 50px 0 0; }
        .pokeball::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; background: white; border: 4px solid #333; border-radius: 50%; z-index: 2; }
        @keyframes shake-ball { 0% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 50% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); } }
        .gacha-result { display: none; text-align: center; animation: pop-in 0.5s; }
        @keyframes pop-in { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        .gacha-img { width: 200px; height: 200px; object-fit: contain; border-radius: 10px; border: 4px solid #f1c40f; box-shadow: 0 0 30px #f1c40f; }

        /* Gacha Box */
        .gacha-box { text-align: center; padding: 40px; background: #16213e; border-radius: 15px; border: 2px dashed #f1c40f; }
        .gacha-btn { background: linear-gradient(45deg, #f1c40f, #d35400); color: white; border: none; padding: 15px 40px; font-size: 1.5em; border-radius: 50px; cursor: pointer; box-shadow: 0 0 20px rgba(241, 196, 15, 0.5); }

        @media (max-width: 768px) { .game-area { flex-direction: column-reverse; } .user-section { flex-direction: column; align-items: flex-start; } .user-avatar { width: 40px; height: 40px; } }
    </style>
</head>
<body>

<div class="container">
    <div class="navbar">
        <div class="user-section">
            <img id="my-avatar" class="user-avatar" src="">
            <div class="user-stats">
                <div class="user-name"><span id="player-name">è¼‰å…¥ä¸­...</span> <span class="money-badge">ğŸ’° <span id="player-money">0</span></span></div>
                <div class="player-hp-box">
                    <div id="my-hp-bar" class="player-hp-fill" style="width: 100%;"></div>
                </div>
                <div id="my-hp-text" class="player-hp-text">HP: 100/100</div>
            </div>
        </div>
        <div class="btn-group-nav">
            <button class="btn-shop" onclick="switchTab('shop')">ğŸ›’ å•†åº—</button>
            <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" id="btn-wild" onclick="switchTab('wild')">ğŸŒ² é‡å¤–æ¢éšª</button>
        <button class="tab-btn" id="btn-arena" onclick="switchTab('arena')">ğŸŸï¸ ç©å®¶ç«¶æŠ€å ´</button>
        <button class="tab-btn" id="btn-shop" onclick="switchTab('shop')">ğŸ›’ æ‰­è›‹ä¸­å¿ƒ</button>
    </div>

    <div id="tab-wild" class="game-section active">
        <div id="monster-list" class="card-grid"></div>
    </div>

    <div id="tab-arena" class="game-section">
        <div id="player-list" class="card-grid"></div>
    </div>

    <div id="tab-shop" class="game-section">
        <div class="gacha-box">
            <h2 style="color:#f1c40f;">ğŸŒŸ å‚³èªªæ‰­è›‹æ©Ÿ ğŸŒŸ</h2>
            <p>æ¶ˆè€— 200 Gï¼Œéš¨æ©Ÿç²å¾—å¼·åŠ›å¯¶å¯å¤¢ï¼(æ•¸å€¼ä¿ç•™)</p>
            <button class="gacha-btn" onclick="playGacha()">ğŸ”® å¬å–š (200G)</button>
            <br><br>
            <button onclick="buyHeal()" style="background:#27ae60; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">ğŸ’Š é†«é™¢è£œè¡€ (50G)</button>
        </div>
    </div>

    <div class="battle-log-panel" id="battle-log"></div>
</div>

<div class="gacha-overlay" id="gacha-overlay">
    <div class="pokeball" id="pokeball-anim"></div>
    <div class="gacha-result" id="gacha-result">
        <h2 style="color:#f1c40f;">âœ¨ ç²å¾—æ–°å¤¥ä¼´ï¼ âœ¨</h2>
        <img id="gacha-img" class="gacha-img" src="">
        <h3 id="gacha-name"></h3>
        <button onclick="closeGacha()" style="margin-top:20px; padding:10px 30px; border-radius:5px; border:none; cursor:pointer; font-weight:bold;">å¤ªæ£’äº†ï¼</button>
    </div>
</div>

<script>
    // --------------------------------------------------------
    // âš ï¸ è¨­å®šå€ï¼šè«‹å°‡é€™è£¡æ”¹æˆä½ çš„ Zeabur ç¶²å€
    const ZEABUR_DOMAIN = 'mwtpokemons.zeabur.app'; 
    // --------------------------------------------------------

    const API_URL = `https://${ZEABUR_DOMAIN}/api/v1`;
    const WS_URL = `wss://${ZEABUR_DOMAIN}/ws`;

    let myId = 0;
    let myAttack = 10;
    let myHp = 100;
    let myMaxHp = 100;

    const token = localStorage.getItem('token');
    if (!token) window.location.href = 'login.html';
    else updateUserInfo();

    function logout() { localStorage.clear(); window.location.href = 'login.html'; }

    // --- Tab åˆ‡æ› ---
    function switchTab(tabName) {
        document.querySelectorAll('.game-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
        document.getElementById(`btn-${tabName}`).classList.add('active');
        if(tabName=='wild') fetchMonsters();
        if(tabName=='arena') fetchPlayers();
    }

    // --- è³‡æ–™è®€å– ---
    async function updateUserInfo() {
        try {
            const res = await fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                const user = await res.json();
                myId = user.id;
                myAttack = user.attack;
                myHp = user.hp;
                myMaxHp = user.max_hp;

                // æ›´æ–° UI
                document.getElementById('player-name').innerText = `${user.username} (Lv.${user.level})`;
                document.getElementById('player-money').innerText = user.money;
                document.getElementById('my-avatar').src = user.pokemon_image || 'https://via.placeholder.com/50';
                
                // æ›´æ–°è‡ªå·±è¡€æ¢
                const hpPct = Math.max(0, (user.hp / user.max_hp) * 100);
                document.getElementById('my-hp-bar').style.width = `${hpPct}%`;
                document.getElementById('my-hp-bar').style.background = hpPct < 30 ? '#e74c3c' : '#2ecc71';
                document.getElementById('my-hp-text').innerText = `HP: ${user.hp}/${user.max_hp}`;
            }
        } catch (e) { console.error(e); }
    }

    async function fetchMonsters() {
        const res = await fetch(`${API_URL}/items/`);
        const data = await res.json();
        // ğŸ”¥ æ’åºï¼šå›ºå®šä½ç½®ï¼Œé¿å…äº‚è·³
        data.sort((a, b) => a.id - b.id);
        renderList('monster-list', data, 'monster');
    }

    async function fetchPlayers() {
        const res = await fetch(`${API_URL}/auth/all`);
        const data = await res.json();
        // éæ¿¾æ‰è‡ªå·±ï¼Œä¸”ä¾ç…§ ID æ’åº
        const others = data.filter(u => u.id !== myId).sort((a, b) => a.id - b.id);
        renderList('player-list', others, 'player');
    }

    // --- æ¸²æŸ“å¡ç‰‡ ---
    function renderList(elementId, items, type) {
        const container = document.getElementById(elementId);
        container.innerHTML = '';
        if(items.length === 0) {
            container.innerHTML = `<p style="text-align:center; width:100%">æš«ç„¡ç›®æ¨™...</p>`;
            return;
        }

        items.forEach(item => {
            const name = item.name || item.username;
            const img = item.image_url || item.pokemon_image || 'https://via.placeholder.com/200';
            const hpPct = Math.max(0, (item.hp / item.max_hp) * 100);
            const isDead = item.hp <= 0 ? 'dead' : '';
            const itemId = item.id;
            const currentHp = item.hp;
            
            // æ ¹æ“šé¡å‹æ±ºå®šæŒ‰éˆ•åŠŸèƒ½
            let btnHtml = '';
            if (type === 'monster') {
                btnHtml = `<button class="btn-attack" onclick="attackMonster(${itemId}, ${currentHp}, '${name}')">âš”ï¸ è¨ä¼</button>`;
            } else {
                btnHtml = `<button class="btn-attack" style="background:#8e44ad" onclick="attackPlayer(${itemId}, '${name}')">ğŸ¥Š æ±ºé¬¥</button>`;
            }

            // HTML çµæ§‹ (ID ç”¨æ–¼é£„å‚·å®šä½)
            container.innerHTML += `
                <div class="card ${isDead}" id="card-${type}-${itemId}">
                    <img src="${img}" class="card-img">
                    <div class="card-body">
                        <div><b>${name}</b> <small style="float:right">ATK: ${item.attack}</small></div>
                        <div class="hp-bar-bg"><div class="hp-bar-fill" style="width:${hpPct}%"></div></div>
                        <small>${item.hp} / ${item.max_hp}</small>
                        ${btnHtml}
                    </div>
                </div>
            `;
        });
    }

    // --- æ”»æ“Šæ€ªç¸ (ä¿®å¾©ï¼šç›´æ¥è®€å– DOM æ•¸å­—æˆ–ç°¡å–®è¨ˆç®—) ---
    async function attackMonster(id, hpFromCard, name) {
        // ğŸ”¥ ä¿®å¾©ç§’æ®º Bugï¼š
        // èˆŠå¯«æ³•æ˜¯ä¾è³´ onclick åƒæ•¸ï¼Œé€™åƒæ•¸ä¸æœƒè®Šã€‚
        // æˆ‘å€‘é€™è£¡ç›´æ¥ä¾è³´å¾Œç«¯é‚è¼¯ï¼Œå‰ç«¯åªè² è²¬é€å‡ºã€Œè¨ˆç®—å¥½çš„æ–°è¡€é‡ã€ã€‚
        // æ­£ç¢ºåšæ³•ï¼šè®€å–ç©å®¶ç•¶å‰æ”»æ“ŠåŠ›ï¼Œè¨ˆç®—å‚·å®³
        
        // å‚·å®³å…¬å¼
        const isCrit = Math.random() < 0.3;
        const randomBonus = Math.floor(Math.random() * (myAttack * 0.5));
        const dmg = isCrit ? (myAttack + randomBonus) * 2 : (myAttack + randomBonus);
        
        // ç‚ºäº†é¿å… onclick åƒæ•¸éæ™‚çš„å•é¡Œï¼Œæˆ‘å€‘æ‡‰è©²é‡æ–° fetch æˆ–å¾ DOM è®€å–ï¼Œ
        // ä½†ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘é€™è£¡å‡è¨­å‚³å…¥çš„ hpFromCard æ˜¯èˆŠçš„ï¼Œæˆ‘å€‘æ”¹ç”¨å¾Œç«¯å›æ‡‰ä¾†æ›´æ–°ã€‚
        // æ›´å¥½çš„æ–¹å¼ï¼šå‰ç«¯ç¶­è­·ä¸€å€‹ state mapã€‚é€™è£¡æˆ‘å€‘ç”¨ç°¡å–®çš„ã€Œé æ‰£ã€é¡¯ç¤ºã€‚
        
        // å¾ DOM å–å¾—ç•¶å‰è¡€é‡ (æœ€æº–ç¢º)
        const card = document.getElementById(`card-monster-${id}`);
        // ç°¡å–®è§£ææ–‡å­—ï¼Œæˆ–æ˜¯ç›´æ¥ä¿¡ä»»æœ¬æ¬¡æ“ä½œ
        // é€™è£¡æˆ‘å€‘åšä¸€å€‹å¤§è†½çš„å‡è¨­ï¼šå°±ç”¨å‚³é€²ä¾†çš„åƒæ•¸æ¸›ï¼Œä½†é  WebSocket å¿«é€Ÿä¿®æ­£
        // æˆ–è€…ï¼šæˆ‘å€‘ç›´æ¥é€ damage çµ¦å¾Œç«¯ (ä½†æˆ‘å€‘å¾Œç«¯åªæœ‰ update hp ä»‹é¢)
        
        // æˆ‘å€‘æ”¹ç”¨ï¼šå…ˆ fetch è©²æ€ªç¸æœ€æ–°è¡€é‡ -> è¨ˆç®— -> update
        try {
            const getRes = await fetch(`${API_URL}/items/${id}`);
            const monster = await getRes.json();
            
            if(monster.hp <= 0) return; // å·²æ­»

            let newHp = Math.max(0, monster.hp - dmg);

            // è¦–è¦ºç‰¹æ•ˆ
            showFloatingDamage(`card-monster-${id}`, dmg, isCrit);
            card.classList.remove('shaking');
            void card.offsetWidth;
            card.classList.add('shaking');

            // é€å‡ºæ›´æ–°
            await fetch(`${API_URL}/items/${id}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ hp: newHp })
            });
            
            // æ›´æ–°è‡ªå·± (å¯èƒ½è¢«åæ“Šæ‰£è¡€äº†)
            updateUserInfo();

        } catch (e) { console.error(e); }
    }

    // --- æ”»æ“Šç©å®¶ (PVP) ---
    async function attackPlayer(targetId, name) {
        try {
            const res = await fetch(`${API_URL}/shop/pvp/${targetId}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            
            // è¦–è¦ºç‰¹æ•ˆ (PVP å›ºå®šé£„å‚·é¡¯ç¤º ??)
            showFloatingDamage(`card-player-${targetId}`, "PVP", true);
            
            if (!res.ok) alert(data.detail);
            
            // æ›´æ–°è‡ªå·± (å¯èƒ½ç²å¾—ç¶“é©—/éŒ¢)
            updateUserInfo();
        } catch (e) { console.error(e); }
    }

    // --- æ‰­è›‹ ---
    async function playGacha() {
        // 1. æ’­æ”¾å‹•ç•«
        document.getElementById('gacha-overlay').style.display = 'flex';
        document.getElementById('pokeball-anim').style.display = 'block';
        document.getElementById('gacha-result').style.display = 'none';

        // 2. å‘¼å«å¾Œç«¯ (æ¨¡æ“¬ç­‰å¾… 2 ç§’)
        setTimeout(async () => {
            try {
                const res = await fetch(`${API_URL}/shop/gacha`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (!res.ok) {
                    closeGacha();
                    alert(data.detail);
                    return;
                }

                // 3. é¡¯ç¤ºçµæœ
                document.getElementById('pokeball-anim').style.display = 'none';
                document.getElementById('gacha-result').style.display = 'block';
                document.getElementById('gacha-name').innerText = data.user.pokemon_name;
                document.getElementById('gacha-img').src = data.user.pokemon_image;
                
                updateUserInfo(); // æ›´æ–°å¤§é ­è²¼

            } catch (e) {
                closeGacha();
                alert("é€£ç·šå¤±æ•—");
            }
        }, 2000);
    }

    function closeGacha() {
        document.getElementById('gacha-overlay').style.display = 'none';
    }

    async function buyHeal() {
        const res = await fetch(`${API_URL}/shop/heal`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if(res.ok) {
            alert("è£œè¡€æˆåŠŸï¼");
            updateUserInfo();
        } else {
            alert("é‡‘å¹£ä¸è¶³æˆ–ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    // --- è¦–è¦ºå·¥å…· ---
    function showFloatingDamage(elementId, value, isCrit) {
        const card = document.getElementById(elementId);
        if (!card) return;
        const rect = card.getBoundingClientRect();
        const floatEl = document.createElement('div');
        floatEl.className = 'floating-damage';
        floatEl.innerText = isCrit ? `ğŸ’¥ ${value}` : `-${value}`;
        if (isCrit) { floatEl.style.fontSize = '36px'; floatEl.style.color = '#e74c3c'; }
        const randomX = Math.floor(Math.random() * 60) - 30;
        floatEl.style.left = `${rect.left + rect.width / 2 + randomX}px`;
        floatEl.style.top = `${rect.top + rect.height / 3}px`;
        document.body.appendChild(floatEl);
        setTimeout(() => { floatEl.remove(); }, 800);
    }

    function addLog(html) {
        const box = document.getElementById('battle-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = html;
        box.prepend(entry);
    }

    // --- WebSocket ---
    const socket = new WebSocket(WS_URL);
    socket.onmessage = (e) => {
        addLog(`ğŸ“¡ ${e.data}`);
        fetchMonsters();
        fetchPlayers();
        updateUserInfo();
    };
    setInterval(() => { if(socket.readyState===1) socket.send("ping"); }, 30000);

</script>
</body>
</html>