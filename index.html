<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ å¦™è›™å®¸çš„ç†±è¡€æˆ°å ´ ğŸ”¥</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; color: #fff; padding: 20px; margin: 0; overflow-x: hidden; }
        .container { max-width: 900px; margin: 0 auto; padding-top: 20px; position: relative; }
        
        /* --- é ‚éƒ¨å°èˆªåˆ— --- */
        .navbar { display: flex; justify-content: space-between; align-items: center; background: #16213e; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #0f3460; }
        .user-info { color: #4cc9f0; font-weight: bold; font-size: 1.1em; display: flex; align-items: center; gap: 15px; }
        .money-badge { color: #f1c40f; background: rgba(241, 196, 15, 0.1); padding: 4px 10px; border-radius: 20px; border: 1px solid #f1c40f; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        
        .btn-group-nav { display: flex; gap: 10px; }
        .btn-logout { background: transparent; border: 1px solid #e74c3c; color: #e74c3c; padding: 5px 15px; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .btn-logout:hover { background: #e74c3c; color: white; }
        .btn-shop { background: #f1c40f; border: none; color: #000; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-shop:hover { background: #d4ac0d; }

        h1 { text-align: center; color: #e94560; text-shadow: 0 0 10px #e94560; margin-bottom: 30px; }

        /* --- æˆ°é¬¥ä½ˆå±€ --- */
        .game-area { display: flex; gap: 20px; align-items: flex-start; }
        .card-grid { flex: 2; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .battle-log-panel { flex: 1; background: #16213e; border: 2px solid #0f3460; border-radius: 10px; height: 500px; padding: 15px; overflow-y: auto; position: sticky; top: 20px; }
        .log-title { text-align: center; color: #4cc9f0; margin-top: 0; border-bottom: 1px solid #4cc9f0; padding-bottom: 10px; }
        .log-entry { margin-bottom: 8px; font-size: 0.9em; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .log-crit { color: #ffeb3b; font-weight: bold; }
        .log-heal { color: #2ecc71; }
        .log-die { color: #e74c3c; font-weight: bold; }

        /* --- å¡ç‰‡èˆ‡å‹•ç•« --- */
        .card { background: #0f3460; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-5px); border: 2px solid #e94560; }
        .shaking { animation: shake 0.5s; border: 2px solid red; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 10% { transform: translate(-1px, -2px); } 20% { transform: translate(-3px, 0px); } 30% { transform: translate(3px, 2px); } 40% { transform: translate(1px, -1px); } 50% { transform: translate(-1px, 2px); } 60% { transform: translate(-3px, 1px); } 70% { transform: translate(3px, 1px); } 80% { transform: translate(-1px, -1px); } 90% { transform: translate(1px, 2px); } 100% { transform: translate(1px, -2px); } }
        .dead { filter: grayscale(100%); opacity: 0.6; pointer-events: none; }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #fff; }
        .card-body { padding: 15px; }
        .card-title { font-size: 1.3em; margin: 0; color: #fff; font-weight: bold; }
        .hp-text { float: right; font-size: 0.9em; color: #ccc; }
        .hp-bar-bg { background: #333; height: 12px; border-radius: 6px; margin: 10px 0; overflow: hidden; border: 1px solid #555; }
        .hp-bar-fill { background: linear-gradient(90deg, #e74c3c, #c0392b); height: 100%; width: 100%; transition: width 0.3s ease-out; }
        
        .btn-group { display: flex; gap: 5px; }
        button.action-btn { flex: 1; padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-attack { background: linear-gradient(to bottom, #e74c3c, #c0392b); }
        .btn-attack:active { transform: scale(0.95); }
        .btn-heal { background: linear-gradient(to bottom, #2ecc71, #27ae60); }
        .btn-heal:active { transform: scale(0.95); }
        
        /* --- é£„å‚·æ•¸å­—ç‰¹æ•ˆ --- */
        .floating-damage {
            position: absolute;
            color: #ffeb3b;
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            text-shadow: 2px 2px 0 #000;
            z-index: 100;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-30px) scale(1.5); opacity: 1; }
            100% { transform: translateY(-60px) scale(1); opacity: 0; }
        }

        /* --- å•†åº—é¢æ¿ --- */
        .shop-panel {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #16213e;
            border: 2px solid #f1c40f;
            padding: 20px;
            border-radius: 15px;
            z-index: 1000;
            width: 320px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .shop-item {
            background: #0f3460;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .shop-item-info { display: flex; flex-direction: column; gap: 4px; }
        .shop-item-name { font-weight: bold; color: #f1c40f; }
        .shop-item-desc { font-size: 0.8em; color: #ccc; }
        .shop-buy-btn {
            background: #f1c40f;
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            min-width: 60px;
        }
        .shop-buy-btn:hover { background: #d4ac0d; }
        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        }

        @media (max-width: 768px) { .game-area { flex-direction: column-reverse; } .battle-log-panel { width: 100%; height: 200px; } }
    </style>
</head>
<body>

<div class="container">
    <div class="navbar">
        <div class="user-info">
            <span id="player-name">è¼‰å…¥ä¸­...</span>
            <span class="money-badge">ğŸ’° <span id="player-money">0</span></span>
        </div>
        <div class="btn-group-nav">
            <button class="btn-shop" onclick="toggleShop()">ğŸ›’ å•†åº—</button>
            <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>

    <h1>âš”ï¸ å¦™è›™å®¸çš„ç†±è¡€æˆ°å ´ âš”ï¸</h1>
    
    <div class="game-area">
        <div id="monster-list" class="card-grid">
            <div style="text-align:center; width:100%; color:#888;">æ­£åœ¨å°‹æ‰¾å°æ‰‹...</div>
        </div>
        <div class="battle-log-panel">
            <h3 class="log-title">ğŸ“œ æˆ°é¬¥ç´€éŒ„</h3>
            <div id="battle-log"></div>
        </div>
    </div>
</div>

<div class="overlay" id="shop-overlay" onclick="toggleShop()"></div>
<div class="shop-panel" id="shop-panel">
    <h2 style="text-align:center; color:#f1c40f; margin-top:0;">ğŸ›’ é“å…·å•†åº—</h2>
    <div id="shop-items-container">
        </div>
    <button onclick="toggleShop()" style="width:100%; background:#e74c3c; margin-top:15px; padding:10px; border:none; border-radius:5px; color:white; font-weight:bold; cursor:pointer;">é—œé–‰</button>
</div>

<script>
    // --------------------------------------------------------
    // âš ï¸ è¨­å®šå€ï¼šè«‹å°‡é€™è£¡æ”¹æˆä½ çš„ Zeabur ç¶²å€
    const ZEABUR_DOMAIN = 'mwtpokemons.zeabur.app'; 
    // --------------------------------------------------------

    const API_URL = `https://${ZEABUR_DOMAIN}/api/v1/items/`;
    const AUTH_URL = `https://${ZEABUR_DOMAIN}/api/v1/auth/me`;
    const SHOP_URL = `https://${ZEABUR_DOMAIN}/api/v1/shop/buy/`;
    const WS_URL = `wss://${ZEABUR_DOMAIN}/ws`;

    // ğŸ”¥ å…¨åŸŸè®Šæ•¸ï¼šæš«å­˜ç©å®¶æ”»æ“ŠåŠ› (é è¨­ 20)
    let currentUserAttack = 20;

    // --- 1. é–€ç¦èˆ‡åˆå§‹è¼‰å…¥ ---
    const token = localStorage.getItem('token');
    
    if (!token) {
        window.location.href = 'login.html';
    } else {
        updateUserInfo();
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'login.html';
    }

    // æ›´æ–°ç©å®¶è³‡è¨Š (ç­‰ç´š & é‡‘å¹£ & æ”»æ“ŠåŠ›)
    async function updateUserInfo() {
        try {
            const res = await fetch(AUTH_URL, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const user = await res.json();
                document.getElementById('player-name').innerText = `${user.username} (Lv.${user.level})`;
                document.getElementById('player-money').innerText = user.money;
                
                // ğŸ”¥ é—œéµï¼šæ›´æ–°æ”»æ“ŠåŠ›è®Šæ•¸
                currentUserAttack = user.attack;
            }
        } catch (e) { console.error(e); }
    }

    // --- 2. WebSocket é€£ç·š (å«å¿ƒè·³) ---
    let socket;
    function connectWebSocket() {
        socket = new WebSocket(WS_URL);

        socket.onopen = () => {
            console.log("WebSocket é€£ç·šæˆåŠŸ");
            addLog("âœ… å·²é€£ç·šåˆ°å³æ™‚æˆ°å ´ï¼");
            
            // å¿ƒè·³æ©Ÿåˆ¶
            setInterval(() => {
                if (socket.readyState === WebSocket.OPEN) socket.send("ping");
            }, 30000);
        };

        socket.onmessage = (event) => {
            const msg = event.data;
            addLog(`<span style="color: #4cc9f0;">ğŸ“¡ [å³æ™‚] ${msg}</span>`);
            fetchMonsters(); 
            updateUserInfo(); // æ›´æ–°è‡ªå·± (å¯èƒ½å‡ç´šæˆ–è³ºéŒ¢äº†)
        };

        socket.onclose = () => {
            console.log("é€£ç·šæ–·é–‹ï¼Œå˜—è©¦é‡é€£...");
            setTimeout(connectWebSocket, 3000);
        };
    }
    connectWebSocket();

    // --- 3. éŠæˆ²é‚è¼¯ ---
    fetchMonsters();

    async function fetchMonsters() {
        const container = document.getElementById('monster-list');
        try {
            const res = await fetch(API_URL);
            if (!res.ok) throw new Error('é€£ç·šå¤±æ•—');
            const monsters = await res.json();
            
            container.innerHTML = ''; 
            if (monsters.length === 0) {
                container.innerHTML = '<p>åœ°åœ–ä¸Šæ²’æœ‰æ€ªç¸ï¼Œå¿«å» Swagger UI å¬å–šï¼</p>';
                return;
            }
            monsters.forEach(m => renderCard(container, m));
        } catch (err) {
            console.error(err);
            container.innerHTML = `<p style="color:red">ä¼ºæœå™¨é€£ç·šå¤±æ•—</p>`;
        }
    }

    async function playerAttack(id, currentHp, name) {
        if (currentHp <= 0) return; 

        // ğŸ”¥ å‚·å®³å…¬å¼ï¼šåŸºç¤æ”»æ“ŠåŠ› + (0 ~ åŸºç¤æ”»æ“ŠåŠ› çš„äº‚æ•¸)
        // é€™æ¨£è²·è—¥æ°´åŠ æ”»æ“ŠåŠ›å¾Œï¼Œå‚·å®³å°±æœƒé¡¯è‘—æå‡ï¼
        const randomBonus = Math.floor(Math.random() * currentUserAttack);
        const baseDamage = currentUserAttack + randomBonus;

        const isCrit = Math.random() < 0.3; 
        const damage = isCrit ? baseDamage * 2 : baseDamage;
        let newHp = Math.max(0, currentHp - damage);
        
        // è¦–è¦º
        const card = document.getElementById(`card-${id}`);
        card.classList.remove('shaking');
        void card.offsetWidth; 
        card.classList.add('shaking');
        showFloatingDamage(`card-${id}`, damage, isCrit);

        // æˆ°å ±
        const logMsg = isCrit 
            ? `ğŸ’¥ çˆ†æ“Šï¼ä½ å° [${name}] é€ æˆäº† ${damage} é»å·¨é‡å‚·å®³ï¼`
            : `ğŸ—¡ï¸ ä½ æ”»æ“Šäº† [${name}]ï¼Œé€ æˆ ${damage} é»å‚·å®³ã€‚`;
        addLog(logMsg);

        if (newHp === 0) {
            addLog(`<span class="log-die">ğŸ’€ [${name}] è¢«ä½ æ“Šæ•—äº†ï¼(ç²å¾—é‡‘å¹£ï¼ç­‰å¾…è½‰ç”Ÿ...)</span>`);
            card.classList.add('dead');
        }

        updateCardUI(id, newHp);
        updateButtonParams(id, newHp, name);

        try {
            await fetch(API_URL + id, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify({ hp: newHp })
            });
        } catch (e) { console.error("åŒæ­¥å¤±æ•—", e); }
    }

    async function playerHeal(id, currentHp, maxHp, name) {
        if (currentHp >= maxHp || currentHp <= 0) return;
        const heal = 30;
        let newHp = Math.min(maxHp, currentHp + heal);
        
        addLog(`âœ¨ æ²»ç™’ï¼å›å¾© ${heal} é»ç”Ÿå‘½ã€‚`);
        showFloatingDamage(`card-${id}`, heal, false, true);

        updateCardUI(id, newHp, maxHp);
        updateButtonParams(id, newHp, name, maxHp);

        await fetch(API_URL + id, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify({ hp: newHp })
        });
    }

    // --- 4. å•†åº—ç³»çµ± ---
    const SHOP_ITEMS = [
        { id: 'potion', name: 'å¤§è£œè—¥ ğŸ’Š', price: 50, desc: 'å›å¾© 50 HP' },
        { id: 'str_potion', name: 'åŠ›é‡è—¥åŠ‘ âš”ï¸', price: 200, desc: 'æ”»æ“Š +5' },
        { id: 'life_gem', name: 'ç”Ÿå‘½å¯¶çŸ³ ğŸ’', price: 500, desc: 'MaxHP +50' }
    ];

    function toggleShop() {
        const panel = document.getElementById('shop-panel');
        const overlay = document.getElementById('shop-overlay');
        const isClosed = panel.style.display === 'none' || panel.style.display === '';
        
        if (isClosed) {
            renderShop();
            panel.style.display = 'block';
            overlay.style.display = 'block';
        } else {
            panel.style.display = 'none';
            overlay.style.display = 'none';
        }
    }

    function renderShop() {
        const container = document.getElementById('shop-items-container');
        container.innerHTML = '';
        SHOP_ITEMS.forEach(item => {
            container.innerHTML += `
                <div class="shop-item">
                    <div class="shop-item-info">
                        <span class="shop-item-name">${item.name}</span>
                        <span class="shop-item-desc">${item.desc}</span>
                    </div>
                    <button class="shop-buy-btn" onclick="buyItem('${item.id}', ${item.price})">
                        $${item.price}
                    </button>
                </div>
            `;
        });
    }

    async function buyItem(itemId, price) {
        const currentMoney = parseInt(document.getElementById('player-money').innerText);
        if (currentMoney < price) {
            alert("é‡‘å¹£ä¸è¶³ï¼å¿«å»æ‰“æ€ªè³ºéŒ¢ï¼");
            return;
        }

        try {
            const res = await fetch(`${SHOP_URL}${itemId}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) {
                const err = await res.json();
                alert(err.detail || "è³¼è²·å¤±æ•—");
                return;
            }

            const user = await res.json();
            alert("è³¼è²·æˆåŠŸï¼");
            updateUserInfo(); 
            toggleShop(); 

        } catch (e) {
            console.error(e);
            alert("è³¼è²·å¤±æ•—");
        }
    }

    // --- UI å·¥å…· ---
    function showFloatingDamage(elementId, value, isCrit, isHeal = false) {
        const card = document.getElementById(elementId);
        if (!card) return;
        const rect = card.getBoundingClientRect();
        const floatEl = document.createElement('div');
        floatEl.className = 'floating-damage';
        floatEl.innerText = isHeal ? `+${value}` : (isCrit ? `ğŸ’¥ ${value}` : `-${value}`);
        if (isCrit) { floatEl.style.fontSize = '36px'; floatEl.style.color = '#e74c3c'; } 
        else if (isHeal) { floatEl.style.color = '#2ecc71'; }
        const randomX = Math.floor(Math.random() * 60) - 30;
        floatEl.style.left = `${rect.left + rect.width / 2 + randomX}px`;
        floatEl.style.top = `${rect.top + rect.height / 3}px`;
        document.body.appendChild(floatEl);
        setTimeout(() => { floatEl.remove(); }, 800);
    }

    function renderCard(container, m) {
        const hpPercent = Math.max(0, (m.hp / m.max_hp) * 100);
        const img = m.image_url || 'https://via.placeholder.com/300x200?text=Monster';
        const isDead = m.hp <= 0 ? 'dead' : '';
        const hpColor = hpPercent < 30 ? '#e74c3c' : (hpPercent < 60 ? '#f1c40f' : '#2ecc71');

        container.innerHTML += `
            <div class="card ${isDead}" id="card-${m.id}">
                <img src="${img}" class="card-img">
                <div class="card-body">
                    <div><span class="card-title">${m.name}</span> <span class="hp-text" id="hp-text-${m.id}">${m.hp}/${m.max_hp}</span></div>
                    <div class="hp-bar-bg"><div class="hp-bar-fill" id="hp-bar-${m.id}" style="width: ${hpPercent}%; background:${hpColor}"></div></div>
                    <div class="btn-group">
                        <button class="action-btn btn-attack" onclick="playerAttack(${m.id}, ${m.hp}, '${m.name}')">ğŸ‘Š æ”»æ“Š</button>
                        <button class="action-btn btn-heal" onclick="playerHeal(${m.id}, ${m.hp}, ${m.max_hp}, '${m.name}')">ğŸ’– æ²»ç™’</button>
                    </div>
                </div>
            </div>`;
    }

    function updateCardUI(id, hp, maxHp) {
        const bar = document.getElementById(`hp-bar-${id}`);
        const text = document.getElementById(`hp-text-${id}`);
        if (!bar) return;
        const currentMax = parseInt(text.innerText.split('/')[1]);
        const percent = (hp / currentMax) * 100;
        bar.style.width = `${percent}%`;
        text.innerText = `${hp}/${currentMax}`;
        if (percent < 30) bar.style.background = '#e74c3c';
        else if (percent < 60) bar.style.background = '#f1c40f';
        else bar.style.background = '#2ecc71';
    }

    function updateButtonParams(id, newHp, name, maxHp) {
       const card = document.getElementById(`card-${id}`);
       if (!card) return;
       const btnAttack = card.querySelector('.btn-attack');
       const btnHeal = card.querySelector('.btn-heal');
       btnAttack.onclick = () => playerAttack(id, newHp, name);
       if(maxHp) btnHeal.onclick = () => playerHeal(id, newHp, maxHp, name);
    }

    function addLog(html) {
        const box = document.getElementById('battle-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = html;
        box.prepend(entry);
    }
</script>

</body>
</html>