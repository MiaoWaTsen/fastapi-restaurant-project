<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ï¸ å¯¶å¯å¤¢å¤§äº‚é¬¥ V2.5.1 (å®Œæ•´å±•é–‹ç‰ˆ) âš¡ï¸</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        [v-cloak] { display: none; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; color: #fff; padding: 20px; padding-bottom: 120px; user-select: none; }
        .container { max-width: 900px; margin: 0 auto; position: relative; }
        
        /* Navbar */
        .navbar { display: flex; justify-content: space-between; align-items: center; background: #16213e; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #0f3460; }
        .user-info { display: flex; gap: 15px; width: 100%; }
        .user-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #f1c40f; object-fit: cover; }
        .user-stats { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .stat-block { background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 5px; }
        .stat-title { font-size: 0.9em; color: #aaa; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .bar-container { width: 100%; background: #333; height: 8px; border-radius: 4px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .hp-fill { background: linear-gradient(90deg, #e74c3c, #c0392b); } 
        .pet-xp-fill { background: linear-gradient(90deg, #3498db, #2980b9); } 
        .player-xp-fill { background: linear-gradient(90deg, #f1c40f, #d35400); }
        .bar-text { font-size: 0.75em; color: #ccc; display: flex; justify-content: space-between; margin-top: 1px; }
        .atk-val { color: #f1c40f; font-weight: bold; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px; background: #0f3460; border: none; color: #aaa; cursor: pointer; border-radius: 8px; font-weight: bold; min-width: 80px; transition:0.2s; display:flex; flex-direction:column; align-items:center; justify-content: center; }
        .tab-btn.active { background: #e94560; color: white; transform: translateY(-3px); }

        /* Cards & Grid */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .card { background: #0f3460; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; border: 1px solid transparent; transition:0.2s; position: relative; }
        .card:hover { border-color: #f1c40f; transform: translateY(-5px); }
        .card-img { width: 100%; height: 120px; object-fit: contain; background: #222; border-radius: 5px; }
        
        /* Buttons */
        .btn-action { width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #c0392b; color: white; }
        .btn-small { width: 48%; padding: 5px; font-size: 0.9em; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; color: white; }
        .btn-disabled { background: #555 !important; cursor: not-allowed; opacity: 0.6; pointer-events: none; }
        .btn-logout { background: #95a5a6; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; color: white; font-size: 0.8em; }

        /* Shop Gacha Buttons */
        .btn-gacha { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 10px; color: white; font-weight: bold; font-size: 1.1em; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn-gacha:hover { transform: translateY(-3px); }
        .gacha-normal { background: linear-gradient(90deg, #3498db, #2980b9); }
        .gacha-medium { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        .gacha-high { background: linear-gradient(90deg, #e67e22, #d35400); }
        .gacha-candy { background: linear-gradient(90deg, #e91e63, #c2185b); }
        .gacha-golden { background: linear-gradient(90deg, #f1c40f, #f39c12); color: #000; text-shadow: 0px 0px 2px white; }

        /* Quests */
        .quest-card { text-align: left; margin-bottom: 10px; border-left: 5px solid #aaa; padding: 15px; background:#1e2a38; transition: 0.3s; }
        .quest-completed { border-left-color: #2ecc71; background: #1b261b; }
        .quest-golden { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #000 !important; border-left: 5px solid #fff; box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
        .quest-golden h4, .quest-golden p { color: #000 !important; font-weight: bold; }

        /* Box Items */
        .box-item.active { border: 2px solid #f1c40f; }
        .iv-tag { position: absolute; top: 5px; right: 5px; background: #f1c40f; color: black; padding: 2px 5px; border-radius: 3px; font-size: 0.7em; font-weight: bold; }
        
        /* Battle Overlay */
        .battle-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 15, 30, 0.98); z-index: 2000; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto;}
        .battle-header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .battle-arena { display: flex; justify-content: space-between; width: 100%; max-width: 800px; height: 350px; align-items: flex-end; position: relative; margin-top: 20px;}
        .fighter { width: 40%; text-align: center; position: relative; transition: 0.1s; }
        .fighter img { width: 100%; height: 180px; object-fit: contain; drop-shadow: 0 10px 10px rgba(0,0,0,0.5); }
        
        .fighter-stats { background: rgba(0,0,0,0.6); padding: 5px; border-radius: 5px; margin-top: 5px; text-align: left; border: 1px solid #444; }
        .fighter-name { font-weight: bold; font-size: 1.1em; margin-bottom: 2px; }
        .fighter-val { display: flex; justify-content: space-between; font-size: 0.8em; color: #ccc; }
        .fighter-buff { color: #f1c40f; font-size: 0.8em; height: 1.2em; font-weight: bold; text-align: center; margin-bottom: 2px; }

        /* Animations */
        .shake-hit { animation: shake 0.4s; }
        .flash-red { animation: flashRed 0.3s; }
        .flash-heal { animation: flashGreen 0.5s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-15px); } 75% { transform: translateX(15px); } 100% { transform: translateX(0); } }
        @keyframes flashRed { 0% { filter: sepia(1) hue-rotate(-50deg) saturate(5); } 100% { filter: none; } }
        @keyframes flashGreen { 0% { filter: sepia(1) hue-rotate(90deg) saturate(3); } 100% { filter: none; } }
        
        /* Floating Text */
        .floating-text { position: absolute; font-size: 2.5em; font-weight: bold; animation: floatUp 1.5s forwards; pointer-events: none; text-shadow: 2px 2px 0 #000; z-index: 3000; white-space: nowrap; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 80% { opacity: 1; } 100% { transform: translateY(-80px) scale(1.1); opacity: 0; } }
        
        /* Battle Timer */
        .timer-bar { width: 100%; height: 8px; background: #333; margin-top: 10px; border-radius: 4px; overflow: hidden; position: relative; }
        .timer-fill { height: 100%; background: #f1c40f; transition: width 1s linear; }
        .timer-text { position: absolute; top: -20px; right: 0; font-size: 0.9em; color: #aaa; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #16213e; border: 3px solid #f1c40f; padding: 30px; border-radius: 20px; text-align: center; width: 350px; position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 1.5em; color: #f1c40f; margin-bottom: 20px; }
        .btn-yes { background: #27ae60; padding: 10px 20px; border:none; color:white; border-radius:5px; cursor:pointer; margin:5px; }
        
        /* Chat */
        .chat-room { background: #1e2a38; border-radius: 10px; padding: 15px; height: 65vh; display: flex; flex-direction: column; border: 1px solid #333; }
        .chat-msgs { flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; text-align: left; }
        .chat-msg-item { margin-bottom: 5px; font-size: 0.95em; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 3px; }
        .chat-input-area { display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 12px; border-radius: 5px; border: none; background: #333; color: white; }
        
        /* Tables & Details */
        .rate-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .rate-table th, .rate-table td { border: 1px solid #444; padding: 5px; font-size: 0.9em; text-align:left; }
        .skills-grid { width:100%; max-width:600px; margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:15px; }
        .btn-skill { padding: 15px; font-size: 1.1em; background: #3498db; color: white; border: none; border-radius: 10px; cursor: pointer; transition: 0.2s; position:relative; }
        .btn-skill:active { transform: scale(0.95); }
        .btn-shield { background: #f1c40f; color: black; font-weight: bold; }
        .btn-skill small { display: block; font-size: 0.7em; opacity: 0.8; }
        .detail-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333; }
        
        /* Pokedex */
        .pokedex-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .pokedex-item { background: #222; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        .pokedex-item:hover { transform: scale(1.05); border: 1px solid #f1c40f; }
        .pokedex-img { width: 100%; height: 80px; object-fit: contain; }
        .pokedex-unknown { filter: brightness(0); opacity: 0.7; }
        .pokedex-owned { border: 2px solid #f1c40f; }
        
        /* Misc */
        .gacha-anim { font-size: 5em; animation: bounce 1s infinite; margin-bottom: 20px; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .lobby-bar { text-align:center; padding:10px; background:#2c3e50; color:white; border-radius:5px; margin-bottom:15px; border:1px solid #f39c12; }
    </style>
</head>
<body>

<div id="loading" style="text-align:center; padding:50px; color:#aaa;">Loading...</div>

<div id="app" class="container" v-cloak>
    <div v-if="!user" style="text-align:center; padding-top:100px;">
        <h1 style="color:#e94560">å¯¶å¯å¤¢å¤§äº‚é¬¥ V2.5.1</h1>
        <p>å®Œæ•´å…¨åŠŸèƒ½ç‰ˆ</p>
        <button class="btn-action" @click="logout">å‰å¾€ç™»å…¥é é¢</button>
        <br><br>
        <button style="background:transparent; border:1px solid #aaa; color:#aaa; padding:5px;" @click="initAdmin">ğŸ‘‘ åˆå§‹åŒ–ç®¡ç†å“¡</button>
    </div>

    <div v-else>
        <div v-if="showGachaAnim" class="modal-overlay">
            <div style="text-align:center;">
                <div class="gacha-anim">ğŸ”®</div>
                <h2 style="color:white;">æŠ½çä¸­...</h2>
            </div>
        </div>
        
        <div v-if="gachaResult" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-title">ğŸ‰ æ­å–œç²å¾—ï¼</div>
                <img :src="getMonImage(gachaResult.prize.name)" style="width:120px; height:120px; object-fit:contain; margin:10px auto; display:block;">
                <h3 style="color:#f1c40f; font-size:1.5em; margin:10px 0;">{{ gachaResult.prize.name }}</h3>
                <p>IV: {{ gachaResult.prize.iv }}</p>
                <div style="margin-top:20px;"><button class="btn-yes" @click="gachaResult=null">å¤ªæ£’äº†</button></div>
            </div>
        </div>
        
        <div v-if="showBattleResult" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-title">ğŸ† æˆ°é¬¥å‹åˆ©ï¼</div>
                <p style="white-space: pre-wrap; line-height: 1.6; font-size:1.2em;">{{ battleResultMsg }}</p>
                <div style="margin-top:20px;"><button class="btn-yes" @click="showBattleResult=false">ç¢ºå®š</button></div>
            </div>
        </div>

        <div v-if="raidVictory" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-title">ğŸ‰ åœ˜é«”æˆ°å‹åˆ©ï¼ ğŸ‰</div>
                <p>è«‹é¸æ“‡æ‚¨çš„çå‹µ (ä¸‰é¸ä¸€)ï¼š</p>
                <div style="display:flex; justify-content:center; gap:20px; margin-top:20px;">
                    <div v-for="i in 3" :key="i" @click="claimRaidReward(i)" style="cursor:pointer; transition:0.2s; background:#2c3e50; padding:15px; border-radius:10px;">
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" style="width:60px;">
                        <div style="margin-top:5px;">é»æ“Šé–‹å•Ÿ</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="isRaidDead" class="modal-overlay" style="background:rgba(50,0,0,0.9);">
            <div class="modal-box" style="border: 3px solid #e74c3c;">
                <div class="modal-title" style="color:#e74c3c;">ğŸ’€ ä½ å·²ç¶“æ­»äº¡</div>
                <h2 style="font-size:4em; margin:10px 0; color:#fff;">{{ raidDeadTimer }}</h2>
                <p>ç§’å¾Œå°‡è¢«è¸¢å‡ºå¤§å»³...</p>
                <button class="btn-action" style="background:#27ae60; margin-top:20px; padding:15px;" @click="reviveRaid">
                    ğŸ’Š è³¼è²·å¾©æ´» (500G)
                </button>
            </div>
        </div>

        <div v-if="viewMon" class="modal-overlay" @click.self="viewMon=null">
            <div class="modal-box">
                <div class="modal-title">{{ viewMon.name }} 
                    <span v-if="viewMon.lv" style="font-size:0.6em; color:#aaa;">(Lv.{{ viewMon.lv }})</span>
                </div>
                
                <div style="text-align:center; margin:10px 0;">
                    <img :src="viewMon.img_src" style="width:120px; height:120px; object-fit:contain;">
                </div>

                <div v-if="viewMon.iv" style="text-align:center; margin-bottom:15px;">
                    <span style="background:#f1c40f; color:black; padding:2px 8px; border-radius:5px; font-weight:bold;">IV: {{ viewMon.iv }}</span>
                </div>
                
                <div class="detail-row"><span>â¤ï¸ æœ€å¤§è¡€é‡</span><b>{{ viewMon.hp_val }}</b></div>
                <div class="detail-row"><span>âš”ï¸ æ”»æ“ŠåŠ›</span><b>{{ viewMon.atk_val }}</b></div>
                <div v-if="!viewMon.is_demo" class="detail-row"><span>âœ¨ ç¶“é©—å€¼</span><span>{{ viewMon.exp }}</span></div>
                
                <div style="margin-top:15px; text-align:left;">
                    <h4>âš¡ æŠ€èƒ½çµ„</h4>
                    <div v-for="skill in getMonSkills(viewMon.name)" :key="skill" style="background:#222; padding:5px; margin-bottom:5px; border-radius:5px;">
                        <b style="color:#3498db">{{ skill }}</b> <small style="color:#aaa;">{{ getSkillDesc(skill) }}</small>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn-yes" style="flex:1; background:#7f8c8d" @click="viewMon=null">é—œé–‰</button>
                    <template v-if="!viewMon.is_demo">
                        <button class="btn-yes" style="flex:1; background:#e67e22;" @click="useCandy(viewMon.uid)">ğŸ¬ é¤µç³–</button>
                        <button class="btn-yes" style="flex:1;" @click="swapMon(viewMon.uid); viewMon=null;">å‡ºæˆ°</button>
                        <button class="btn-yes" style="flex:1; background:#c0392b;" @click="releaseMon(viewMon.uid)">âŒ æ”¾ç”Ÿ</button>
                    </template>
                </div>
            </div>
        </div>
        
        <div v-if="newsState.show" class="modal-overlay">
            <div class="modal-box" style="text-align:left;">
                <div class="modal-title" style="text-align:center;">ğŸ“¢ V2.5.1 æ›´æ–°å…¬å‘Š</div>
                <ul>
                    <li><b>ğŸš€ ç­‰ç´šä¸Šé™æå‡</b>ï¼šé–‹æ”¾è‡³ Lv.30ï¼</li>
                    <li><b>ğŸŒ² å…¨æ–°é‡æ€ª</b>ï¼šé—œéƒ½åœ°å€å¤§é‡å¯¶å¯å¤¢ç™»å ´ (å…­å°¾ã€è€¿é¬¼ç­‰)ã€‚</li>
                    <li><b>âš–ï¸ æ•¸å€¼å¹³è¡¡</b>ï¼šèª¿æ•´äº†å‡ç´šæˆé•·æ›²ç·šèˆ‡é‡æ€ªå¼·åº¦ã€‚</li>
                </ul>
                <div style="text-align:center; margin-top:15px;">
                    <button class="btn-yes" @click="closeNews">æˆ‘çŸ¥é“äº†</button>
                </div>
            </div>
        </div>

        <div v-if="showRates" class="modal-overlay" @click.self="showRates=false">
            <div class="modal-box" style="width: 400px; max-height:80vh;">
                <div class="modal-title">ğŸ“Š æ‰­è›‹æ©Ÿç‡è¡¨</div>
                <div style="overflow-y:auto; max-height:60vh;">
                    <div v-for="(pool, name) in gachaRates" :key="name" style="margin-bottom: 15px;">
                        <h4 style="color: #f1c40f; border-bottom: 1px solid #555;">{{ name }}</h4>
                        <table class="rate-table">
                            <tr v-for="item in pool" :key="item.name">
                                <td>{{ item.name }}</td>
                                <td style="text-align: right;">{{ item.rate }}%</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <button class="btn-yes" style="width: 100%; margin-top: 10px;" @click="showRates=false">é—œé–‰</button>
            </div>
        </div>

        <div v-if="inLobby" class="lobby-bar">
            <span style="font-size:1.2em; margin-right:20px;">âš ï¸ æˆ°é¬¥æº–å‚™ä¸­...</span>
            <span style="font-size:1.5em; color:#f1c40f; font-family:monospace;">{{ lobbyTimer }}s</span>
        </div>

        <div class="navbar">
            <div class="user-info">
                <img :src="user.pokemon_image" class="user-avatar">
                <div class="user-stats">
                    <div class="stat-block">
                        <div class="stat-title"><span>{{ user.username }} (Lv.{{ user.level }})</span><span>ğŸ’° {{ user.money }}</span></div>
                        <div class="bar-container"><div class="bar-fill player-xp-fill" :style="{ width: playerXpPercent + '%' }"></div></div>
                        <div class="bar-text"><span>Trainer XP</span><span>{{ user.exp }}/{{ getReqXp(user.level) }}</span></div>
                    </div>
                    <div class="stat-block">
                        <div class="stat-title">
                            <span>{{ user.pokemon_name }} (Lv.{{ user.pet_level }})</span>
                            <span class="atk-val">ATK: {{ currentAtkMe }} (IV: {{ currentPetIV }})</span>
                        </div>
                        <div class="bar-container"><div class="bar-fill hp-fill" :style="{ width: hpPercent(user) + '%' }"></div></div>
                        <div class="bar-text"><span>HP: {{ user.hp }}/{{ user.max_hp }}</span></div>
                        <div class="bar-container" style="margin-top:4px;"><div class="bar-fill pet-xp-fill" :style="{ width: petXpPercent(user) + '%' }"></div></div>
                    </div>
                </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:5px;">
                <button class="btn-logout" @click="dailyCheckin">ğŸ“… ç°½åˆ°</button>
                <button class="btn-logout" @click="logout">ç™»å‡º</button>
            </div>
        </div>

        <div v-if="battle.active && !inLobby" class="battle-overlay">
            <div class="battle-header">
                <h2 style="color:#f1c40f; margin:0;">
                    {{ battle.mode === 'raid' ? 'ğŸ”¥ åœ˜é«”æˆ°' : (battle.mode === 'wild' ? 'ğŸŒ² é‡å¤–æ¢éšª' : 'âš”ï¸ PVP') }}
                </h2>
                <button class="btn-small" style="width:auto; background:#7f8c8d; padding:5px 10px;" @click="forceCloseBattle">é€ƒè·‘</button>
            </div>

            <div v-if="battle.mode === 'wild'" style="width:100%; max-width:600px; position:relative;">
                <div class="timer-bar">
                    <div class="timer-fill" :style="{width: (turnTimer/10)*100 + '%', background: turnTimer < 3 ? '#e74c3c' : '#f1c40f'}"></div>
                </div>
                <div class="timer-text">å›åˆ: {{ turnTimer }}s</div>
            </div>

            <div class="battle-arena">
                <div class="fighter" id="player-fighter">
                    <img :src="user.pokemon_image" :class="{'shake-hit': battle.shakeMe}">
                    <div class="fighter-stats">
                        <div class="fighter-name" style="color:#3498db;">{{ user.username }}</div>
                        <div class="fighter-buff">
                            <span v-if="battle.atkBuff > 1">âš”ï¸ ATK +{{ Math.round((battle.atkBuff-1)*100) }}%</span>
                            <span v-if="battle.shieldActive">ğŸ›¡ï¸ è­·ç›¾</span>
                        </div>
                        <div class="bar-container"><div class="bar-fill hp-fill" :style="{width: hpPercent(user) + '%'}"></div></div>
                        <div class="fighter-val">
                            <span>HP: {{ user.hp }}/{{ user.max_hp }}</span>
                            <span style="color:#f1c40f;">ATK: {{ Math.floor(user.attack * (battle.atkBuff || 1.0)) }}</span>
                        </div>
                    </div>
                </div>

                <div class="fighter" id="enemy-fighter">
                    <img :src="battle.target.image_url || battle.target.pokemon_image" :class="{'shake-hit': battle.shakeTarget}">
                    <div class="fighter-stats">
                        <div class="fighter-name" style="color:#e74c3c;">{{ battle.target.name || battle.target.username }}</div>
                        <div class="fighter-buff"></div>
                        <div class="bar-container"><div class="bar-fill hp-fill" :style="{width: (battle.target.hp/battle.target.max_hp)*100 + '%'}"></div></div>
                        <div class="fighter-val">
                            <span>HP: {{ battle.target.hp }}/{{ battle.target.max_hp }}</span>
                            <span style="color:#f1c40f;">ATK: {{ battle.target.attack }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="skills-grid">
                <button v-for="skill in mySkills" :key="skill" class="btn-skill" 
                        :class="{'btn-disabled': isEnemyTurn}" 
                        @click="doSkillAttack(skill)" 
                        :disabled="isEnemyTurn">
                    {{ skill }} <small>{{ getSkillDesc(skill) }}</small>
                </button>
                
                <button v-if="battle.mode === 'wild'" class="btn-skill btn-shield" 
                        :class="{'btn-disabled': isEnemyTurn}" 
                        @click="useShield" 
                        :disabled="shieldUses <= 0 || isEnemyTurn">
                    ğŸ›¡ï¸ é˜²è­·ç›¾ <small>å‰© {{ shieldUses }} æ¬¡</small>
                </button>
                
                <button v-else-if="battle.mode === 'raid'" class="btn-skill btn-shield" 
                        style="background:#e91e63;"
                        :class="{'btn-disabled': isEnemyTurn}" 
                        @click="useMedKit" 
                        :disabled="shieldUses <= 0 || isEnemyTurn">
                    ğŸ’Š é†«ç™‚åŒ… <small>å‰© {{ shieldUses }} æ¬¡</small>
                </button>
                
                <button v-else class="btn-skill" style="background:#27ae60" 
                        @click="doHeal" 
                        :class="{'btn-disabled': isEnemyTurn}" 
                        :disabled="isEnemyTurn">
                    ğŸ’Š é†«ç™‚åŒ… <small>å›å¾©20%</small>
                </button>
            </div>
        </div>

        <div class="tabs" v-if="!battle.active">
            <button class="tab-btn" :class="{active: tab=='wild'}" @click="tab='wild'">ğŸŒ² é‡å¤–</button>
            <button class="tab-btn" :class="{active: tab=='arena'}" @click="tab='arena'">ğŸŸï¸ ç«¶æŠ€</button>
            <button class="tab-btn" :class="{active: tab=='box'}" @click="tab='box'">ğŸ“¦ ç›’å­</button>
            <button class="tab-btn" :class="{active: tab=='bag'}" @click="tab='bag'">ğŸ’ èƒŒåŒ…</button>
            <button class="tab-btn" :class="{active: tab=='pokedex'}" @click="tab='pokedex'">ğŸ“– åœ–é‘‘</button>
            <button class="tab-btn" :class="{active: tab=='leaderboard'}" @click="tab='leaderboard'">ğŸ† æ’è¡Œ</button>
            <button class="tab-btn" :class="{active: tab=='raid'}" @click="tab='raid'">ğŸ”¥ åœ˜é«”æˆ°</button>
            <button class="tab-btn" :class="{active: tab=='quest'}" @click="tab='quest'">ğŸ“œ ä»»å‹™</button>
            <button class="tab-btn" :class="{active: tab=='shop'}" @click="tab='shop'">ğŸ›’ å•†åº—</button>
            <button class="tab-btn" :class="{active: tab=='gamble'}" @click="tab='gamble'">ğŸ° è³­å ´</button>
            <button class="tab-btn" :class="{active: tab=='chat'}" @click="tab='chat'">ğŸ’¬ èŠå¤©</button>
            <button class="tab-btn" :class="{active: tab=='social'}" @click="tab='social'">ğŸ‘¥ å¥½å‹</button>
        </div>

        <div v-if="!battle.active">
            
            <div v-if="tab=='wild'">
                <h3>ğŸŒ² é¸æ“‡æ¢éšªå€åŸŸ</h3>
                <div style="margin-bottom:15px; background:#2c3e50; padding:10px; border-radius:8px;">
                    <label>ç­‰ç´šé¸æ“‡ï¼š</label>
                    <select v-model="selectedWildLevel" @change="fetchWildList" style="padding:5px; background:#16213e; color:white; border:none;">
                        <option v-for="n in user.level" :value="n">Lv. {{ n }}</option>
                    </select>
                </div>
                <div class="card-grid">
                    <div v-for="m in wildList" :key="m.name" class="card">
                        <img :src="m.image_url" class="card-img">
                        <div style="margin-top:5px;">
                            <b>{{ m.name }}</b><br>
                            <small>Lv.{{ m.level }} | HP:{{m.hp}}</small><br>
                            <button class="btn-small" style="background:#c0392b" @click="startWildBattle(m)">æˆ°é¬¥</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="tab=='raid'">
                <h3>ğŸ”¥ å‚³èªªåœ˜é«”æˆ° (08/14/18/21/22/23 é»)</h3>
                <div v-if="raidState.active" class="card" style="border:2px solid #e74c3c; background:#2c0b0e;">
                    <h2>Boss: {{ raidState.boss_name }}</h2>
                    <img :src="raidState.image" style="width:120px; height:120px;">
                    <div v-if="raidState.status === 'LOBBY'" style="color:#f1c40f; margin:10px 0;">
                        â³ æº–å‚™ä¸­... 00åˆ†æº–æ™‚é–‹æ‰“
                    </div>
                    <div v-else>
                        <div class="bar-container" style="height:20px;"><div class="hp-fill" :style="{width: (raidState.hp/raidState.max_hp)*100 + '%'}"></div></div>
                        <p>HP: {{ raidState.hp }} / {{ raidState.max_hp }}</p>
                    </div>
                    
                    <button v-if="raidState.status=='ENDED'" class="btn-action" style="background:#f1c40f; color:black;" @click="raidVictory=true">
                        ğŸ é ˜å–çå‹µ
                    </button>
                    
                    <button v-else-if="canJoinLobby || raidState.status=='FIGHTING'" class="btn-action" @click="joinRaid">
                        åŠ å…¥æˆ°é¬¥ (1000G)
                    </button>
                    <button v-else class="btn-disabled btn-action">å°šæœªé–‹æ”¾</button>
                </div>
                <div v-else class="card">
                    ç›®å‰æ²’æœ‰åœ˜é«”æˆ° (08/14/18/21/22/23 é»)
                </div>
            </div>

            <div v-if="tab=='quest'">
                <h3>ğŸ“œ å†’éšªä»»å‹™ (è‡ªå‹•è£œä½ç³»çµ±)</h3>
                <div v-if="quests.length === 0" style="color:#aaa; text-align:center;">ç›®å‰æ²’æœ‰ä»»å‹™ï¼Œè«‹é‡æ–°æ•´ç†é é¢...</div>
                <div v-for="q in quests" :key="q.id" class="card quest-card" 
                     :class="{'quest-golden': q.type=='GOLDEN', 'quest-completed': q.now >= q.req}">
                    <h4>
                        <span v-if="q.type=='GOLDEN'">âœ¨</span> 
                        {{ q.target_display || q.target }}
                        <span v-if="q.type=='GOLDEN'">âœ¨</span>
                    </h4>
                    
                    <div class="bar-container" style="height:12px; margin:10px 0; background:rgba(0,0,0,0.3);">
                        <div class="bar-fill" 
                             :style="{ width: Math.min(100, (q.now/q.req)*100) + '%', background: q.now >= q.req ? '#2ecc71' : (q.type=='GOLDEN' ? '#fff' : '#f1c40f') }">
                        </div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <p style="margin:2px 0;">é€²åº¦ï¼š{{ q.now }} / {{ q.req }}</p>
                            <p style="margin:2px 0; font-size:0.9em; opacity:0.8;">
                                çå‹µï¼š{{ q.type=='GOLDEN' ? 'âœ¨ é»ƒé‡‘ç³–æœ x1' : (q.gold + 'G / ' + q.xp + ' XP') }}
                            </p>
                        </div>
                        <button v-if="Number(q.now) >= Number(q.req)" class="btn-action" style="width:120px; background:#2ecc71;" @click="claimQuest(q.id)">ğŸ é ˜å–çå‹µ</button>
                        <button v-else class="btn-action" style="width:120px; background:#e74c3c; font-size:0.8em; opacity:0.8;" @click="abandonQuest(q.id)">æ›´æ› (-1000G)</button>
                    </div>
                </div>
            </div>

            <div v-if="tab=='box'">
                <h3>ğŸ“¦ å¯¶å¯å¤¢ç›’å­ ({{ box.length }}/25)</h3>
                <div class="card-grid">
                    <div v-for="p in box" :key="p.uid" class="card" :class="{active: p.uid === user.active_pokemon_uid}" @click="viewBoxMon(p)" :style="{borderColor: p.uid === user.active_pokemon_uid ? '#f1c40f' : 'transparent'}">
                        <span class="iv-tag">IV: {{ p.iv }}</span>
                        <b>{{ p.name }}</b><div>Lv.{{ p.lv }}</div>
                    </div>
                </div>
            </div>
            
            <div v-if="tab=='shop'">
                <h3>ğŸ›’ æ‰­è›‹å•†åº— <button style="font-size:0.6em; background:#555; border:none; color:white; padding:3px;" @click="showRates=true">ğŸ“Š æ©Ÿç‡</button></h3>
                <button class="btn-gacha gacha-normal" @click="playGacha('normal')"><span>ğŸ”® åˆç´šæ‰­è›‹</span> <span>1500G</span></button>
                <button class="btn-gacha gacha-medium" @click="playGacha('medium')"><span>ğŸ”µ ä¸­ç´šæ‰­è›‹</span> <span>3000G</span></button>
                <button class="btn-gacha gacha-high" @click="playGacha('high')"><span>ğŸŸ£ é«˜ç´šæ‰­è›‹</span> <span>10000G</span></button>
                <button class="btn-gacha gacha-candy" @click="playGacha('candy')"><span>ğŸ¬ ç³–æœæ‰­è›‹</span> <span>12 Candy</span></button>
                <button class="btn-gacha gacha-golden" @click="playGacha('golden')"><span>âœ¨ é»ƒé‡‘æ‰­è›‹</span> <span>3 Golden</span></button>
                <br>
                <button class="btn-action" style="background:#27ae60" @click="buyHeal">ğŸ’Š è£œè¡€ (50G)</button>
                <div class="card" style="margin-top:15px; border-color:#aaa;">
                    <h4>ğŸ å…Œæ›ç¢¼</h4>
                    <div style="display:flex; gap:5px;">
                        <input v-model="promoCode" placeholder="è¼¸å…¥åºè™Ÿ" style="flex:1; padding:8px; border-radius:5px; border:none;">
                        <button class="btn-action" style="margin-top:0; width:80px;" @click="redeemCode">å…Œæ›</button>
                    </div>
                </div>
            </div>
            
            <div v-if="tab=='bag'">
                <div class="card">
                    <h3>ğŸ’ é“å…·èƒŒåŒ…</h3>
                    <div class="card-grid">
                        <div class="card" style="background:#2c3e50;"><div style="font-size:2em;">ğŸ¬</div><b>ç¥å¥‡ç³–æœ</b><div style="font-size:1.2em; color:#f1c40f;">{{ inventory.candy || 0 }}</div></div>
                        <div class="card" style="background:#2c3e50;"><div style="font-size:2em;">âœ¨</div><b>é»ƒé‡‘ç³–æœ</b><div style="font-size:1.2em; color:#f1c40f;">{{ inventory.golden_candy || 0 }}</div></div>
                        <div class="card" style="background:#2c3e50;"><div style="font-size:2em;">ğŸ’Š</div><b>æˆé•·ç³–æœ</b><div style="font-size:1.2em; color:#f1c40f;">{{ inventory.growth_candy || 0 }}</div></div>
                    </div>
                </div>
            </div>

            <div v-if="tab=='gamble'">
                <div class="card" style="text-align:center; border:2px solid #f39c12;">
                    <h3>ğŸ° å¹¸é‹è³­å ´</h3>
                    <input type="number" v-model.number="gambleAmount" placeholder="è¼¸å…¥é‡‘é¡" style="padding:10px; width:100px; border-radius:5px; border:none;">
                    <button class="btn-action" style="margin-top:10px; background:#f39c12; color:black;" @click="doGamble">ä¸‹æ³¨ï¼</button>
                </div>
            </div>

            <div v-if="tab=='social'">
                <h3>ğŸ‘¥ å¥½å‹èˆ‡ç®¡ç†</h3>
                <div v-if="friendRequests.length > 0" class="card" style="margin-bottom:15px; border:1px solid #f1c40f;">
                    <h4 style="color:#f1c40f;">ğŸ”” å¥½å‹é‚€è«‹</h4>
                    <div v-for="req in friendRequests" :key="req.request_id" style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding:5px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <img :src="req.pokemon_image" style="width:30px; height:30px; border-radius:50%;">
                            <span>{{ req.username }}</span>
                        </div>
                        <button class="btn-small" style="width:60px; background:#2ecc71;" @click="acceptFriend(req.request_id)">æ¥å—</button>
                    </div>
                </div>

                <div v-if="friends.length > 0">
                    <h4>æˆ‘çš„å¥½å‹</h4>
                    <div class="card-grid">
                        <div v-for="f in friends" :key="f.id" class="card">
                            <img :src="f.pokemon_image" style="width:50px; height:50px; border-radius:50%; margin-bottom:5px;">
                            <b>{{ f.username }}</b>
                            <button class="btn-small" style="width:100%; margin-top:5px; background:#f39c12" v-if="f.can_gift" @click="sendGift(f.id)">ğŸ é€ç¦®</button>
                        </div>
                    </div>
                </div>
                <div v-else class="card">æš«ç„¡å¥½å‹</div>
            </div>

            <div v-if="tab=='leaderboard'">
                <div class="card">
                    <h3>ğŸ† å…¨æœæ’è¡Œæ¦œ</h3>
                    <div style="margin-bottom:10px;">
                        <label>æ’åºæ–¹å¼ï¼š</label>
                        <select v-model="leaderboardType" @change="fetchLeaderboard" style="padding:5px; background:#16213e; color:white; border:none;">
                            <option value="level">ç­‰ç´š (Level)</option>
                            <option value="collection">åœ–é‘‘å®Œæˆç‡ (Collection)</option>
                            <option value="money">è²¡å¯Œ (Gold)</option>
                        </select>
                    </div>
                    <table v-if="leaderboardData.length > 0" style="width:100%; border-collapse:collapse; margin-top:10px;">
                        <tr style="border-bottom:1px solid #555; text-align:left;">
                            <th style="padding:5px;">æ’å</th>
                            <th>ç©å®¶</th>
                            <th>æ•¸å€¼</th>
                        </tr>
                        <tr v-for="r in leaderboardData" :key="r.rank" style="border-bottom:1px solid #333;">
                            <td style="padding:8px;">
                                <span v-if="r.rank==1">ğŸ¥‡</span><span v-else-if="r.rank==2">ğŸ¥ˆ</span><span v-else-if="r.rank==3">ğŸ¥‰</span><span v-else>{{ r.rank }}</span>
                            </td>
                            <td><img :src="r.img" style="width:20px; height:20px; vertical-align:middle; border-radius:50%;"> {{ r.username }}</td>
                            <td>{{ r.value }}</td>
                        </tr>
                    </table>
                    <div v-else style="padding:20px; text-align:center; color:#aaa;">æš«ç„¡æ’è¡Œè³‡æ–™æˆ–è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <div v-if="tab=='pokedex'">
                <div class="card">
                    <h3>ğŸ“– å¯¶å¯å¤¢åœ–é‘‘</h3>
                    <div class="bar-container" style="margin-bottom:10px;">
                        <div class="bar-fill player-xp-fill" :style="{width: pokedexPercent + '%'}"></div>
                    </div>
                    <p>æ”¶é›†é€²åº¦: {{ pokedexPercent }}%</p>
                    <div class="pokedex-grid">
                        <div v-for="p in pokedexList" :key="p.name" class="pokedex-item" 
                             :class="{'pokedex-owned': p.owned}"
                             v-if="p.is_obtainable"
                             @click="viewPokedexEntry(p)">
                            <img :src="p.img" class="pokedex-img" :class="{'pokedex-unknown': !p.owned}">
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="tab=='arena'">
                <h3>ğŸŸï¸ ç·šä¸Šç©å®¶</h3>
                <div class="card-grid">
                    <div v-for="p in players" :key="p.id" class="card" :style="{opacity: p.is_online ? 1 : 0.5}">
                        <img :src="p.pokemon_image" class="card-img">
                        <div style="margin-top:5px;">
                            <b>{{ p.username }}</b>
                            <span v-if="p.is_online" style="color:#2ecc71; font-size:0.8em;">â— åœ¨ç·š</span>
                            <span v-else style="color:#95a5a6; font-size:0.8em;">â— é›¢ç·š</span>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button v-if="p.is_online" class="btn-small" style="background:#c0392b" @click="sendInvite(p)">æ±ºé¬¥</button>
                                <button v-else class="btn-small btn-disabled" disabled>æ±ºé¬¥</button>
                                <button class="btn-small" style="background:#27ae60" @click="addFriend(p.id)">åŠ å¥½å‹</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="tab=='chat'">
                <h3>ğŸ’¬ ä¸–ç•Œé »é“</h3>
                <div class="chat-room">
                    <div class="chat-msgs" id="chat-box">
                        <div v-for="m in chatMsgs" class="chat-msg-item">{{ m }}</div>
                        <div v-if="chatMsgs.length === 0" style="color:#aaa; text-align:center;">ç›®å‰æ²’æœ‰è¨Šæ¯ï¼Œèªªé»ä»€éº¼å§ï¼</div>
                    </div>
                    <div class="chat-input-area">
                        <input v-model="chatInput" class="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." @keyup.enter="sendChat">
                        <button class="btn-action" style="margin-top:0; width:80px; background:#e94560;" @click="sendChat">é€å‡º</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, computed, watch, onUpdated } = Vue;
    const API_URL = `https://mwtpokemons.zeabur.app/api/v1`;
    const WS_URL = `wss://mwtpokemons.zeabur.app/ws`;
    
    // ğŸ”¥ XP è¡¨æ›´æ–°ï¼šLv.1-30 ğŸ”¥
    const LEVEL_XP_MAP = {
        1: 50, 2: 150, 3: 300, 4: 500, 5: 800, 6: 1300, 7: 2000, 8: 3000, 9: 5000,
        10: 7000, 11: 9000, 12: 11000, 13: 13000, 14: 15000, 15: 17000, 16: 19000,
        17: 21000, 18: 23000, 19: 25000, 20: 27000, 21: 29000, 22: 31000, 23: 33000, 24: 35000, 25: 37000,
        26: 42000, 27: 47000, 28: 52000, 29: 57000, 30: 62000 
    };

    createApp({
        setup() {
            const user = ref(null);
            const token = localStorage.getItem('token');
            const tab = ref('wild'); 
            const box = computed(() => { if(!user.value || !user.value.pokemon_storage) return []; try { return JSON.parse(user.value.pokemon_storage); } catch(e) { return []; } });
            const inventory = computed(() => { if(!user.value) return {}; try { return JSON.parse(user.value.inventory); } catch(e) { return {}; } });
            const currentPetIV = computed(() => { if(!user.value) return 0; const p = box.value.find(x => x.uid === user.value.active_pokemon_uid); return p ? p.iv : 50; });
            
            // ğŸ”¥ æ›´æ–° XP è¨ˆç®—ï¼šä½¿ç”¨æŸ¥è¡¨æ³• ğŸ”¥
            const getReqXp = (lv) => { 
                if (lv >= 30) return 999999999;
                return LEVEL_XP_MAP[lv] || 62000;
            };

            const playerXpPercent = computed(() => user.value ? Math.min(100, (user.value.exp / getReqXp(user.value.level)) * 100) : 0);
            const hpPercent = (u) => { if (!u || !u.max_hp) return 0; return Math.min(100, (u.hp / u.max_hp) * 100); };
            const petXpPercent = (u) => { if (!u) return 0; const req = getReqXp(u.pet_level); return Math.min(100, (u.pet_exp / req) * 100); };
            const currentAtkMe = computed(() => user.value ? user.value.attack : 0);
            
            const battle = ref({ active: false, mode: 'wild', target: null, shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false });
            const raidState = ref({ active: false, hp: 0, max_hp: 0, boss_name: '', status: 'IDLE', image: '', my_status: {}, attack_counter: 0 });
            const lastBossAttackCount = ref(0);
            const inLobby = ref(false);
            const lobbyTimer = ref(15);
            const leaderboardData = ref([]);
            const leaderboardType = ref("level");
            const newsState = ref({ show: false });
            const chatMsgs = ref([]);
            const chatInput = ref("");
            const gambleAmount = ref(100);
            const promoCode = ref("");
            const selectedWildLevel = ref(1);
            const wildList = ref([]);
            const showRates = ref(false);
            const showGachaAnim = ref(false);
            const gachaResult = ref(null);
            const showBattleResult = ref(false);
            const battleResultMsg = ref("");
            const quests = ref([]);
            const players = ref([]);
            const friends = ref([]);
            const friendRequests = ref([]);
            const selectedMon = ref(null);
            const viewMon = ref(null);
            const skillData = ref({});
            const mySkills = ref(["æ’æ“Š", "æ’æ“Š", "æ’æ“Š"]);
            const shieldUses = ref(2);
            const pokedexList = ref([]);
            const pokedexPercent = ref(0);
            const pokedexMap = ref({});
            const turnTimer = ref(10);
            const isEnemyTurn = ref(false);
            let timerInterval = null;
            const raidVictory = ref(false);
            const isRaidDead = ref(false);
            const raidDeadTimer = ref(5);
            let deadInterval = null;

            // ğŸ”¥ æ›´æ–°æ‰­è›‹æ©Ÿç‡æ–‡å­— ğŸ”¥
            const gachaRates = {
                "ğŸ”® åˆç´š (1500G)": [{name: "å¦™è›™ç¨®å­/å°ç«é¾/å‚‘å°¼é¾œ/å…­å°¾/æ¯›è¾®ç¾Š", rate: 5}, {name: "ä¼Šå¸ƒ/çš®å¡ä¸˜/çš®çš®/èƒ–ä¸/å¤§è”¥é´¨", rate: 10}, {name: "å‘†å‘†ç¸/å¯é”é´¨", rate: 12.5}],
                "ğŸ”µ ä¸­ç´š (3000G)": [{name: "å¾¡ä¸‰å®¶/ä¼Šå¸ƒ/çš®å¡ä¸˜/å‘†å‘†ç¸...", rate: 10}, {name: "å¡æ¯”ç¸", rate: 5}, {name: "å‰åˆ©è›‹/æ‹‰æ™®æ‹‰æ–¯/é€²åŒ–å‹", rate: 3}],
                "ğŸŸ£ é«˜ç´š (10000G)": [{name: "å¡æ¯”ç¸/å‰åˆ©è›‹", rate: 20}, {name: "å¹¸ç¦è›‹/æ‹‰æ™®æ‹‰æ–¯/é€²åŒ–å‹", rate: 10}, {name: "å¿«é¾/è€¿é¬¼", rate: 5}],
                "ğŸ¬ ç³–æœ (12 Candy)": [{name: "ä¼Šå¸ƒ/çš®å¡ä¸˜", rate: 20}, {name: "é€²åŒ–å‹/å¡æ¯”ç¸/å‰åˆ©è›‹", rate: 10}, {name: "å¹¸ç¦è›‹", rate: 4}, {name: "æ‹‰æ™®æ‹‰æ–¯/å¿«é¾", rate: 3}],
                "âœ¨ é»ƒé‡‘ (3 Golden)": [{name: "å¡æ¯”ç¸", rate: 30}, {name: "å‰åˆ©è›‹", rate: 35}, {name: "å¹¸ç¦è›‹", rate: 20}, {name: "æ‹‰æ™®æ‹‰æ–¯/å¿«é¾/è€¿é¬¼", rate: 5}]
            };

            // ğŸ”¥ æ›´æ–°æŠ€èƒ½å°æ‡‰è¡¨ ğŸ”¥
            const SKILL_MAP = {
                "å°æ‹‰é”": ["æŠ“", "å‡ºå¥‡ä¸€æ“Š", "æ’æ“Š"], "æ³¢æ³¢": ["æŠ“", "å•„", "ç‡•è¿”"], "çƒˆé›€": ["æŠ“", "å•„", "ç‡•è¿”"], "é˜¿æŸè›‡": ["æ¯’é‡", "æ¯’æ“Š", "ç·ŠæŸ"], "ç“¦æ–¯å½ˆ": ["æ¯’é‡", "æ¯’é‡", "æ’æ“Š"], "æµ·æ˜Ÿæ˜Ÿ": ["æ°´æ§", "å¹»è±¡å…‰ç·š", "æ’æ“Š"], "è§’é‡‘é­š": ["æ°´æ§", "å¹»è±¡å…‰ç·š", "æ³¥å·´å°„æ“Š"], "èµ°è·¯è‰": ["ç¨®å­ç‚¸å½ˆ", "æ’æ“Š", "æ¯’æ“Š"], "ç©¿å±±é¼ ": ["æŠ“", "æ³¥å·´å°„æ“Š", "æ³¥å·´ç‚¸å½ˆ"], "èšŠé¦™èŒèšª": ["é›™å€å¥‰é‚„", "å†°å‡å…‰æŸ", "æ°´æ§"], "å°ç£æ€ª": ["é›»æ“Š", "æ”¾é›»", "æ’æ“Š"], "å¡æ‹‰å¡æ‹‰": ["æ³¥å·´å°„æ“Š", "æ³¥å·´ç‚¸å½ˆ", "æŒ–æ´"], "å–µå–µ": ["æŠ“", "å‡ºå¥‡ä¸€æ“Š", "æ’æ“Š"], "ç‘ªç‘™æ°´æ¯": ["æ°´æ§", "æ°´æµå°¾", "ç·ŠæŸ"], "æµ·åˆºé¾": ["æ°´æ§", "æ°´æµå°¾", "é€†é±—"], "èšŠé¦™å‹‡å£«": ["é›™å€å¥‰é‚„", "å†°å‡å…‰æŸ", "æ°´æ§"], "æš´é¯‰é¾": ["æ°´æµå°¾", "å’¬ç¢", "ç ´å£å…‰ç·š"],
                "é›»æ“Šç¸": ["é›»å…‰", "é›»æ“Š", "ç˜‹ç‹‚ä¼ç‰¹"], "é´¨å˜´ç«ç¸": ["ç«èŠ±", "å™´å°„ç«ç„°", "å¤§å­—çˆ†ç‚"], "åŒ–çŸ³ç¿¼é¾": ["æŒ–æ´", "å²©çŸ³å°é–", "å‹‡é³¥çŒ›æ”»"], "æ€ªåŠ›": ["é›™å€å¥‰é‚„", "å²©çŸ³å°é–", "è¿‘èº«æˆ°"],
                "å¦™è›™ç¨®å­": ["è—¤é­", "ç¨®å­ç‚¸å½ˆ", "æ±¡æ³¥ç‚¸å½ˆ"], "å°ç«é¾": ["ç«èŠ±", "å™´å°„ç«ç„°", "å¤§å­—çˆ†ç‚"], "å‚‘å°¼é¾œ": ["æ°´æ§", "æ°´æµå™´å°„", "æ°´æµå°¾"], "å¦™è›™èŠ±": ["è—¤é­", "ç¨®å­ç‚¸å½ˆ", "æ±¡æ³¥ç‚¸å½ˆ"], "å™´ç«é¾": ["ç«èŠ±", "å™´å°„ç«ç„°", "å¤§å­—çˆ†ç‚"], "æ°´ç®­é¾œ": ["æ°´æ§", "æ°´æµå™´å°„", "æ°´æµå°¾"], "æ¯›è¾®ç¾Š": ["æ’æ“Š", "æ’’å¬Œ", "é›»æ“Š"], "çš®å¡ä¸˜": ["é›»å…‰", "æ”¾é›»", "é›»æ“Š"], "ä¼Šå¸ƒ": ["æ’æ“Š", "æŒ–æ´", "é«˜é€Ÿæ˜Ÿæ˜Ÿ"], "å…­å°¾": ["æ’æ“Š", "ç«èŠ±", "å™´å°„ç«ç„°"], "èƒ–ä¸": ["æ’æ“Š", "æ’’å¬Œ", "ç²¾ç¥å¼·å¿µ"], "çš®çš®": ["æ’æ“Š", "æ’’å¬Œ", "ç²¾ç¥å¼·å¿µ"], "å¤§è”¥é´¨": ["å•„", "è‘‰åˆƒ", "å‹‡é³¥çŒ›æ”»"], "å‘†å‘†ç¸": ["æ°´æ§", "å¹»è±¡å…‰ç·š", "æ°´æµå™´å°„"], "å¯é”é´¨": ["æ°´æ§", "å¹»è±¡å…‰ç·š", "æ°´æµå™´å°„"], "è€¿é¬¼": ["é©šåš‡", "æ±¡æ³¥ç‚¸å½ˆ", "æš—å½±çƒ"],
                "å¡æ¯”ç¸": ["æ³°å±±å£“é ‚", "åœ°éœ‡", "æ’æ“Š"], "å‰åˆ©è›‹": ["æŠ“", "ç²¾ç¥å¼·å¿µ", "æ’æ“Š"], "å¹¸ç¦è›‹": ["æŠ“", "ç²¾ç¥å¼·å¿µ", "æ’æ“Š"], "æ‹‰æ™®æ‹‰æ–¯": ["æ°´æ§", "æ°´æµå™´å°„", "å†°å‡å…‰æŸ"], "å¿«é¾": ["æŠ“", "é€†é±—", "å‹‡é³¥çŒ›æ”»"],
                "æ€¥å‡é³¥": ["å†°ç¤«", "å†°å‡å…‰æŸ", "å‹‡é³¥çŒ›æ”»"], "ç«ç„°é³¥": ["å™´å°„ç«ç„°", "å¤§å­—çˆ†ç‚", "å‹‡é³¥çŒ›æ”»"], "é–ƒé›»é³¥": ["é›»å…‰", "ç˜‹ç‹‚ä¼ç‰¹", "å‹‡é³¥çŒ›æ”»"], "è¶…å¤¢": ["å¿µåŠ›", "ç²¾ç¥å¼·å¿µ", "ç²¾ç¥æ’ƒç ´"], "å¤¢å¹»": ["å¿µåŠ›", "ç²¾ç¥å¼·å¿µ", "ç²¾ç¥æ’ƒç ´"]
            };

            const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };
            const getSkillDesc = (name) => { const s = skillData.value[name]; return s ? `${s.dmg}å‚· ${s.desc || ''}` : ''; };
            const getMonSkills = (name) => SKILL_MAP[name] || ["æ’æ“Š", "æ’æ“Š", "æ’æ“Š"];
            const closeNews = () => { newsState.value.show = false; sessionStorage.setItem('seenNews_v2500', 'true'); };
            
            // ğŸ”¥ æ•¸å€¼è¨ˆç®—ï¼šå‰ç«¯åŒæ­¥å¾Œç«¯ 1.08/1.06 é‚è¼¯ ğŸ”¥
            const calcStats = (mon) => { 
                const base = pokedexMap.value[mon.name] || { hp: 100, atk: 10 }; 
                const ivMult = 0.9 + ((mon.iv || 50) / 100) * 0.2; 
                // ç©å®¶æ•¸å€¼æˆé•·
                const hp = Math.floor(base.hp * ivMult * (1.08 ** ((mon.lv || 1) - 1))); 
                const atk = Math.floor(base.atk * ivMult * (1.06 ** ((mon.lv || 1) - 1)));
                return { hp, atk }; 
            };
            const viewBoxMon = (p) => { const base = pokedexMap.value[p.name]; if (!base) { alert(`è­¦å‘Šï¼šæ‰¾ä¸åˆ° [${p.name}] çš„è³‡æ–™`); return; } const stats = calcStats(p); viewMon.value = { ...p, hp_val: stats.hp, atk_val: stats.atk, img_src: base.img, is_demo: false }; };
            const viewPokedexEntry = (p) => { const base = pokedexMap.value[p.name]; viewMon.value = { name: p.name, iv: null, lv: null, exp: null, hp_val: base.hp, atk_val: base.atk, img_src: base.img, is_demo: true }; };
            const forceCloseBattle = () => { battle.value.active = false; isEnemyTurn.value = false; clearInterval(timerInterval); };
            const showFloatingText = (text, color='red', isEnemy=false) => { const arena = document.querySelector('.battle-arena'); if(!arena) return; const el = document.createElement('div'); el.className = 'floating-text'; el.innerText = text; el.style.color = color === 'gold' ? '#f1c40f' : (color === 'green' ? '#2ecc71' : '#e74c3c'); el.style.left = isEnemy ? '60%' : '20%'; el.style.top = '30%'; arena.appendChild(el); setTimeout(() => el.remove(), 1500); };
            const getMonImage = (name) => { const base = pokedexMap.value[name]; return base ? base.img : "https://via.placeholder.com/150"; };

            const updateInfo = async () => { try { const res = await fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { user.value = await res.json(); if(selectedWildLevel.value > user.value.level) selectedWildLevel.value = user.value.level; } else window.location.href = 'login.html'; } catch(e) {} };
            const fetchPokedex = async () => { try { const res = await fetch(`${API_URL.replace('/items','')}/shop/pokedex/all`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { const allMons = await res.json(); allMons.forEach(m => pokedexMap.value[m.name] = m); if(user.value) { const unlockedStr = (user.value.unlocked_monsters || "").split(","); const boxNames = box.value.map(p => p.name); pokedexList.value = allMons.map(m => ({ ...m, owned: unlockedStr.includes(m.name) || boxNames.includes(m.name) })); const ownedCount = pokedexList.value.filter(m => m.owned).length; pokedexPercent.value = Math.floor((ownedCount / allMons.length) * 100); } } } catch(e) { console.error("Pokedex error", e); } };
            const fetchPlayers = async () => { const res = await fetch(`${API_URL}/auth/all`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) players.value = await res.json(); };
            const fetchFriends = async () => { const res = await fetch(`${API_URL}/social/list`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) friends.value = await res.json(); const res2 = await fetch(`${API_URL}/social/requests`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res2.ok) friendRequests.value = await res2.json(); };
            const fetchQuests = async () => { const res = await fetch(`${API_URL}/quests/`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) quests.value = await res.json(); updateInfo(); };
            const fetchLeaderboard = async () => { const res = await fetch(`${API_URL}/social/leaderboard?type=${leaderboardType.value}`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) leaderboardData.value = await res.json(); };
            const fetchWildList = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/wild/list?level=${selectedWildLevel.value}`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) wildList.value = await res.json(); };
            const fetchSkillData = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/data/skills`); if(res.ok) skillData.value = await res.json(); };
            const initAdmin = async () => { try { const res = await fetch(`${API_URL}/social/admin/init`); const d = await res.json(); alert(d.message); } catch(e) {} };
            const updateMySkills = () => { if(!user.value || !box.value) return; const active = box.value.find(p => p.uid === user.value.active_pokemon_uid); if(active) mySkills.value = SKILL_MAP[active.name] || ["æ’æ“Š", "æ’æ“Š", "æ’æ“Š"]; };
            const releaseMon = async (uid) => { if(!confirm("ç¢ºå®šè¦æ”¾ç”Ÿé€™éš»å¯¶å¯å¤¢å—ï¼Ÿ(ç²å¾— 100 Gold)")) return; const res = await fetch(`${API_URL.replace('/items','')}/shop/box/action/release/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); if(res.ok) { alert(d.message); viewMon.value = null; updateInfo(); } else { alert(d.detail); } };

            const checkRaid = async () => {
                const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/status`, { headers: { 'Authorization': `Bearer ${token}` } });
                if(res.ok) {
                    const data = await res.json();
                    raidState.value = data;
                    if (data.attack_counter > lastBossAttackCount.value) { lastBossAttackCount.value = data.attack_counter; if (battle.value.active && battle.value.mode === 'raid') { battle.value.shakeMe = true; setTimeout(() => battle.value.shakeMe = false, 400); showFloatingText("-HP", "red"); updateInfo(); } }
                    if (data.my_status && data.my_status.dead_at) { if (!isRaidDead.value) { isRaidDead.value = true; raidDeadTimer.value = 5; deadInterval = setInterval(() => { raidDeadTimer.value--; if(raidDeadTimer.value <= 0) { clearInterval(deadInterval); alert("ä½ å·²è¢«è¸¢å‡ºåœ˜é«”æˆ°"); isRaidDead.value = false; battle.value.active = false; } }, 1000); } } else { if (isRaidDead.value) { isRaidDead.value = false; clearInterval(deadInterval); } }
                    if (data.status === 'ENDED' && data.my_status && !data.my_status.claimed && !raidVictory.value) { raidVictory.value = true; }
                }
            };

            const handleBattleWin = async () => {
                const safeName = encodeURIComponent(battle.value.target.raw_name);
                const tLv = battle.value.target.level; 
                const res = await fetch(`${API_URL.replace('/items','')}/shop/wild/attack?is_win=true&is_powerful=${battle.value.target.is_powerful||false}&target_name=${safeName}&target_level=${tLv}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                const d = await res.json();
                battleResultMsg.value = d.message; showBattleResult.value = true; battle.value.active = false; updateInfo(); setTimeout(fetchQuests, 500);
            };

            const startWildBattle = (target) => { 
                shieldUses.value = 2; 
                updateMySkills(); 
                
                let t = JSON.parse(JSON.stringify(target));
                if(Math.random() < 0.1) {
                    t.is_powerful = true;
                    t.raw_name = t.name; 
                    t.name = "ğŸ”¥ å¼·å¤§çš„ " + t.name;
                    t.hp = Math.floor(t.hp * 1.2);
                    t.max_hp = t.hp;
                    t.attack = Math.floor(t.attack * 1.2);
                } else {
                    t.is_powerful = false;
                    t.raw_name = t.name;
                }

                battle.value = { active: true, mode: 'wild', target: t, shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false }; 
                turnTimer.value = 10; isEnemyTurn.value = false; startTurnTimer(); 
            };
            
            const startTurnTimer = () => { clearInterval(timerInterval); turnTimer.value = 10; if (battle.value.mode !== 'wild') return; timerInterval = setInterval(() => { turnTimer.value--; if(turnTimer.value <= 0) { clearInterval(timerInterval); isEnemyTurn.value = true; showFloatingText("é€¾æ™‚!", "red"); setTimeout(enemyAttackPhase, 1000); } }, 1000); };
            
            const enemyAttackPhase = () => { 
                if(battle.value.shieldActive) { 
                    const reflectDmg = Math.floor(battle.value.target.attack * 0.15 * (0.95 + Math.random() * 0.1)); 
                    battle.value.target.hp -= reflectDmg; 
                    showFloatingText(`åå‚· ${reflectDmg}`, 'gold'); 
                    if (battle.value.target.hp <= 0 && battle.value.mode === 'wild') { clearInterval(timerInterval); handleBattleWin(); return; }
                    battle.value.shieldActive = false; isEnemyTurn.value = false; startTurnTimer(); 
                } else { 
                    const rawDmg = Math.floor(battle.value.target.attack * 0.2); 
                    const enemyDmg = Math.floor(rawDmg * (0.95 + Math.random() * 0.1)); 
                    user.value.hp = Math.max(0, user.value.hp - enemyDmg); 
                    battle.value.shakeMe = true; setTimeout(() => battle.value.shakeMe = false, 400); 
                    showFloatingText(`-${enemyDmg}`, 'red'); 
                    if(user.value.hp <= 0) { alert("ä½ è¢«æ‰“æ•—äº†..."); battle.value.active = false; fetch(`${API_URL.replace('/items','')}/shop/wild/attack?is_win=false`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); buyHeal(); } else { isEnemyTurn.value = false; startTurnTimer(); } 
                } 
            };
            
            const doSkillAttack = async (skillName) => { 
                if(isEnemyTurn.value) return; 
                if(!skillData.value[skillName]) return; 
                try { 
                    isEnemyTurn.value = true; 
                    clearInterval(timerInterval); 
                    const skill = skillData.value[skillName]; 
                    
                    if (skill.effect === 'buff_atk' && Math.random() < skill.prob) { battle.value.atkBuff = 1 + skill.val; showFloatingText(`ATK UP!`, 'gold'); } 
                    else if (skill.effect === 'heal' && Math.random() < skill.prob) { const healAmt = Math.floor(user.value.max_hp * skill.val); user.value.hp = Math.min(user.value.max_hp, user.value.hp + healAmt); showFloatingText(`+${healAmt}`, 'green'); } 
                    else if (skill.effect === 'debuff_atk') { showFloatingText(`é™æ”»!`, 'blue'); } // è¦–è¦ºæ•ˆæœ
                    
                    if (skill.effect === 'recoil') { const recoilDmg = Math.floor(user.value.max_hp * skill.val); user.value.hp = Math.max(0, user.value.hp - recoilDmg); showFloatingText(`åå‚· -${recoilDmg}`, 'red'); } 
                    
                    let rawDmg = Math.floor((user.value.attack / 100) * skill.dmg * battle.value.atkBuff); 
                    let dmg = Math.floor(rawDmg * (0.95 + Math.random() * 0.1)); 
                    if (dmg < 1) dmg = 1; 
                    
                    battle.value.shakeTarget = true; setTimeout(() => battle.value.shakeTarget = false, 400); 
                    showFloatingText(`-${dmg}`, 'red', true); 
                    
                    if(battle.value.mode === 'wild') { 
                        battle.value.target.hp = Math.max(0, battle.value.target.hp - dmg); 
                        if(battle.value.target.hp <= 0) { 
                            handleBattleWin(); 
                        } else { setTimeout(enemyAttackPhase, 1200); } 
                    } 
                    else if (battle.value.mode === 'raid') { 
                        const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/attack?damage=${dmg}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); 
                        const d = await res.json(); 
                        if(d.boss_hp !== undefined) battle.value.target.hp = d.boss_hp; 
                        setTimeout(() => { isEnemyTurn.value = false; startTurnTimer(); }, 800); 
                    } 
                } catch (e) { console.error(e); battle.value.active = false; } 
            };

            const playGacha = async (type) => { showGachaAnim.value = true; const res = await fetch(`${API_URL.replace('/items','')}/shop/gacha/${type}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); setTimeout(() => { showGachaAnim.value = false; gachaResult.value = d; updateInfo(); }, 2000); };
            const useShield = () => { if(shieldUses.value <= 0) return; shieldUses.value--; battle.value.shieldActive = true; isEnemyTurn.value = true; clearInterval(timerInterval); setTimeout(enemyAttackPhase, 1200); };
            const doHeal = async () => { const heal = Math.floor(user.value.max_hp * 0.2); user.value.hp = Math.min(user.value.max_hp, user.value.hp + heal); alert(`å›å¾©äº† ${heal} HP`); };
            const dailyCheckin = async () => { const res = await fetch(`${API_URL}/social/daily_checkin`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const swapMon = async (uid) => { await fetch(`${API_URL.replace('/items','')}/shop/box/swap/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); updateInfo(); };
            const useCandy = async (uid) => { const res = await fetch(`${API_URL.replace('/items','')}/shop/box/action/candy/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const doGamble = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/gamble?amount=${gambleAmount.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const sendChat = async () => { if(!chatInput.value) return; await fetch(`${API_URL}/social/chat/send?content=${chatInput.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); chatInput.value = ""; };
            const buyHeal = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/heal`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { alert("è£œè¡€æˆåŠŸ"); updateInfo(); } else alert("é‡‘å¹£ä¸è¶³"); };
            const redeemCode = async () => { const res = await fetch(`${API_URL}/social/redeem?code=${promoCode.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const sendGift = async (fid) => { const res = await fetch(`${API_URL}/social/gift/send/${fid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { alert("ç¦®ç‰©å·²ç™¼é€ï¼"); fetchFriends(); } else { const d = await res.json(); alert(d.detail); } };
            const sendInvite = async (p) => { await fetch(`${API_URL.replace('/items','')}/shop/duel/invite/${p.id}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); alert("å·²é‚€è«‹"); };
            const addFriend = async (uid) => { const res = await fetch(`${API_URL}/social/add/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); };
            const acceptFriend = async (reqId) => { await fetch(`${API_URL}/social/accept/${reqId}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); alert("å·²æ¥å—å¥½å‹ï¼"); fetchFriends(); };
            const joinRaid = async () => { if(confirm("æ”¯ä»˜ 1000G åŠ å…¥ï¼Ÿ")) { const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/join`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { battle.value = { active: true, mode: 'raid', target: { name: raidState.value.boss_name, hp: raidState.value.hp, max_hp: raidState.value.max_hp, image_url: raidState.value.image }, shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false }; shieldUses.value = 2; updateMySkills(); } else { const d = await res.json(); alert(d.detail); } } };
            const abandonQuest = async (qid) => { if(confirm("æ”¾æ£„éœ€æ¶ˆè€— 1000Gï¼Œç¢ºå®šå—ï¼Ÿ")) { await fetch(`${API_URL}/quests/abandon/${qid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); fetchQuests(); } };
            const claimQuest = async (qid) => { const res = await fetch(`${API_URL}/quests/claim/${qid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message); fetchQuests(); };
            
            const reviveRaid = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/revive`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); if (res.ok) { isRaidDead.value = false; clearInterval(deadInterval); updateInfo(); } else { const d = await res.json(); alert(d.detail); } };
            const claimRaidReward = async (choice) => { const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/claim?choice=${choice}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message); raidVictory.value = false; tab.value = 'wild'; updateInfo(); };
            const useMedKit = () => { if(shieldUses.value <= 0) return; shieldUses.value--; const healAmt = Math.floor(user.value.max_hp * 0.2); user.value.hp = Math.min(user.value.max_hp, user.value.hp + healAmt); alert(`ğŸ’Š é†«ç™‚åŒ…å›å¾©äº† ${healAmt} HP`); };
            const releaseMon = async (uid) => { if(!confirm("ç¢ºå®šè¦æ”¾ç”Ÿé€™éš»å¯¶å¯å¤¢å—ï¼Ÿ(ç²å¾— 100 Gold)")) return; const res = await fetch(`${API_URL.replace('/items','')}/shop/box/action/release/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); if(res.ok) { alert(d.message); viewMon.value = null; updateInfo(); } else { alert(d.detail); } };

            onUpdated(() => { const chatBox = document.getElementById('chat-box'); if(chatBox) chatBox.scrollTop = chatBox.scrollHeight; });
            onMounted(async () => { 
                document.getElementById('loading').style.display = 'none'; 
                if(!token) return window.location.href = 'login.html'; 
                if (!sessionStorage.getItem('seenNews_v2500')) newsState.value.show = true; 
                await fetchSkillData(); await fetchPokedex(); await updateInfo(); await fetchPokedex(); 
                updateMySkills(); fetchPlayers(); checkRaid(); setInterval(checkRaid, 3000); 
                setInterval(fetchPlayers, 10000);
                fetchQuests(); fetchWildList(); fetchLeaderboard();
                try { const ws = new WebSocket(`${WS_URL}?token=${token}`); ws.onmessage = (e) => { const msg = e.data; if(msg.startsWith("CHAT|")) { chatMsgs.value.push(msg.split("|")[1]); } }; } catch(e) { console.error("WS error", e); } 
            });

            const canJoinLobby = computed(() => raidState.value.status === 'LOBBY');

            return { 
                user, tab, box, players, friends, friendRequests, selectedMon, viewMon, battle, raidState, inLobby, lobbyTimer, 
                dailyCheckin, logout, playGacha, swapMon, useCandy, gambleAmount, doGamble, chatMsgs, chatInput, sendChat, 
                doSkillAttack, useShield, doHeal, buyHeal, promoCode, redeemCode, sendGift, joinRaid, 
                playerXpPercent, hpPercent, petXpPercent, currentAtkMe, quests, abandonQuest, claimQuest, 
                wildList, fetchWildList, startWildBattle, showRates, gachaRates, mySkills, shieldUses, 
                getSkillDesc, selectedWildLevel, calcStats, pokedexList, pokedexPercent, getReqXp, 
                showGachaAnim, gachaResult, showBattleResult, battleResultMsg, inventory, 
                leaderboardData, leaderboardType, fetchLeaderboard, initAdmin, newsState, closeNews, 
                currentPetIV, addFriend, acceptFriend, sendInvite, canJoinLobby, turnTimer, isEnemyTurn, 
                viewBoxMon, viewPokedexEntry, getMonSkills, forceCloseBattle, 
                raidVictory, isRaidDead, raidDeadTimer, reviveRaid, claimRaidReward, useMedKit, releaseMon, getMonImage
            };
        }
    }).mount('#app');
</script>
</body>
</html>