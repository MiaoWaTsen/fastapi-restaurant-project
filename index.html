<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ï¸ å¯¶å¯å¤¢å¤§äº‚é¬¥ âš¡ï¸</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; color: #fff; padding: 20px; margin: 0; overflow-x: hidden; }
        .container { max-width: 900px; margin: 0 auto; padding-top: 20px; }
        
        /* Navbar */
        .navbar { display: flex; justify-content: space-between; align-items: center; background: #16213e; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #0f3460; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #f1c40f; object-fit: cover; }
        .money-badge { color: #f1c40f; border: 1px solid #f1c40f; padding: 4px 10px; border-radius: 15px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; background: #0f3460; border: none; color: #aaa; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: #e94560; color: white; transform: translateY(-3px); }
        
        /* Game Area */
        .game-section { display: none; }
        .game-section.active { display: block; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        
        /* Battle Log */
        .battle-log-panel { background: #16213e; border: 2px solid #0f3460; border-radius: 10px; height: 200px; padding: 10px; overflow-y: auto; margin-top: 20px; }
        .log-entry { font-size: 0.9em; border-bottom: 1px solid #333; padding: 4px 0; }

        /* Card */
        .card { background: #0f3460; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.5); position: relative; }
        .card-img { width: 100%; height: 150px; object-fit: cover; background: #fff; }
        .card-body { padding: 10px; }
        .card-title { margin: 0; font-weight: bold; color: #fff; }
        .hp-bar-bg { background: #333; height: 8px; border-radius: 4px; margin: 8px 0; overflow: hidden; }
        .hp-bar-fill { background: #e74c3c; height: 100%; width: 100%; transition: width 0.3s; }
        
        /* Gacha */
        .gacha-box { text-align: center; padding: 40px; background: #16213e; border-radius: 15px; border: 2px dashed #f1c40f; }
        .gacha-btn { background: linear-gradient(45deg, #f1c40f, #d35400); color: white; border: none; padding: 15px 40px; font-size: 1.5em; border-radius: 50px; cursor: pointer; box-shadow: 0 0 20px rgba(241, 196, 15, 0.5); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .btn-attack { width: 100%; background: #c0392b; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="navbar">
        <div class="user-info">
            <img id="my-avatar" class="user-avatar" src="">
            <div>
                <div id="player-name">è¼‰å…¥ä¸­...</div>
                <div class="money-badge">ğŸ’° <span id="player-money">0</span></div>
            </div>
        </div>
        <button onclick="logout()" style="background:transparent; border:1px solid #666; color:#aaa; padding:5px 10px; border-radius:5px; cursor:pointer;">ç™»å‡º</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('wild')">ğŸŒ² é‡å¤–æ¢éšª</button>
        <button class="tab-btn" onclick="switchTab('arena')">ğŸŸï¸ ç©å®¶ç«¶æŠ€å ´</button>
        <button class="tab-btn" onclick="switchTab('shop')">ğŸ›’ å•†åº— & æ‰­è›‹</button>
    </div>

    <div id="tab-wild" class="game-section active">
        <div id="monster-list" class="card-grid"></div>
    </div>

    <div id="tab-arena" class="game-section">
        <div id="player-list" class="card-grid"></div>
    </div>

    <div id="tab-shop" class="game-section">
        <div class="gacha-box">
            <h2 style="color:#f1c40f;">ğŸŒŸ å‚³èªªæ‰­è›‹æ©Ÿ ğŸŒŸ</h2>
            <p>æ¶ˆè€— 200 Gï¼Œéš¨æ©Ÿç²å¾—å¼·åŠ›å¯¶å¯å¤¢ï¼</p>
            <button class="gacha-btn" onclick="playGacha()">ğŸ”® å¬å–š (200G)</button>
            <br><br>
            <button onclick="buyHeal()" style="background:#27ae60; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">ğŸ’Š é†«é™¢è£œè¡€ (50G)</button>
        </div>
    </div>

    <div class="battle-log-panel" id="battle-log"></div>
</div>

<script>
    const ZEABUR_DOMAIN = 'mwtpokemons.zeabur.app'; // âš ï¸ è«‹æ”¹ç¶²å€
    const BASE_URL = `https://${ZEABUR_DOMAIN}/api/v1`;
    const WS_URL = `wss://${ZEABUR_DOMAIN}/ws`;

    let myId = 0;
    const token = localStorage.getItem('token');
    if (!token) window.location.href = 'login.html';
    else updateUserInfo();

    function logout() { localStorage.clear(); window.location.href = 'login.html'; }

    // --- Tab åˆ‡æ› ---
    function switchTab(tabName) {
        document.querySelectorAll('.game-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
        // ç¬¨æ–¹æ³•ï¼šæ ¹æ“š Tab æ–‡å­—ä¾† active æŒ‰éˆ•
        if(tabName=='wild') fetchMonsters();
        if(tabName=='arena') fetchPlayers();
    }

    // --- è³‡æ–™è®€å– ---
    async function updateUserInfo() {
        const res = await fetch(`${BASE_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) {
            const user = await res.json();
            myId = user.id;
            document.getElementById('player-name').innerText = `${user.username} (Lv.${user.level})`;
            document.getElementById('player-money').innerText = user.money;
            document.getElementById('my-avatar').src = user.pokemon_image || 'https://via.placeholder.com/50';
        }
    }

    async function fetchMonsters() {
        const res = await fetch(`${BASE_URL}/items/`);
        const data = await res.json();
        renderList('monster-list', data, 'monster');
    }

    async function fetchPlayers() {
        const res = await fetch(`${BASE_URL}/auth/all`);
        const data = await res.json();
        // éæ¿¾æ‰è‡ªå·±
        const others = data.filter(u => u.id !== myId);
        renderList('player-list', others, 'player');
    }

    // --- æ¸²æŸ“å¡ç‰‡ (å…±ç”¨) ---
    function renderList(elementId, items, type) {
        const container = document.getElementById(elementId);
        container.innerHTML = '';
        items.forEach(item => {
            const name = item.name || item.username; // Monsterç”¨name, Userç”¨username
            const img = item.image_url || item.pokemon_image || 'https://via.placeholder.com/200';
            const hpPct = Math.max(0, (item.hp / item.max_hp) * 100);
            
            // æ”»æ“ŠæŒ‰éˆ•
            let actionBtn = '';
            if (type === 'monster') {
                actionBtn = `<button class="btn-attack" onclick="attackMonster(${item.id})">âš”ï¸ è¨ä¼</button>`;
            } else {
                actionBtn = `<button class="btn-attack" style="background:#8e44ad" onclick="attackPlayer(${item.id})">ğŸ¥Š æ±ºé¬¥</button>`;
            }

            container.innerHTML += `
                <div class="card">
                    <img src="${img}" class="card-img">
                    <div class="card-body">
                        <div><b>${name}</b> <small style="float:right">ATK: ${item.attack}</small></div>
                        <div class="hp-bar-bg"><div class="hp-bar-fill" style="width:${hpPct}%"></div></div>
                        <small>${item.hp} / ${item.max_hp}</small>
                        ${actionBtn}
                    </div>
                </div>
            `;
        });
    }

    // --- å‹•ä½œ ---
    async function attackMonster(id) {
        await fetch(`${BASE_URL}/items/${id}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ hp: 0 }) // é€™è£¡å·æ‡¶ï¼Œè®“å¾Œç«¯å»ç®—æ‰£è¡€ï¼Œå‰ç«¯åªè² è²¬è§¸ç™¼
            // æ›´å¥½çš„åšæ³•æ˜¯å‰ç«¯ç®—å¥½ hp å‚³éå»ï¼Œæˆ–è€…å¾Œç«¯æ–°å¢å°ˆå±¬ attack api
            // ç‚ºäº†ç›¸å®¹èˆŠé‚è¼¯ï¼Œæˆ‘å€‘é€™è£¡å…ˆç”¨ "éš¨æ©Ÿæ‰£è¡€" çš„æ–¹å¼
        });
        // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘é€™è£¡é‚„æ˜¯ç”¨èˆŠçš„ update ä»‹é¢ï¼Œä½†å› ç‚ºå¾Œç«¯æœ‰å»£æ’­ï¼Œæ‰€ä»¥ä¸éœ€æ‰‹å‹•æ›´æ–° UI
        // é€™è£¡éœ€è¦ç¨å¾®ä¿®æ”¹å¾Œç«¯é‚è¼¯æ‰èƒ½å®Œç¾æ”¯æ´å‰ç«¯åªé€ "æ”»æ“Šè¨Šè™Ÿ"ã€‚
        // æ—¢ç„¶æˆ‘å€‘ä¸æƒ³å‹•å¤ªå¤šå¾Œç«¯ï¼Œé€™è£¡æˆ‘å€‘æ¨¡æ“¬ä¸€ä¸‹ï¼š
        // å…ˆè®€å–æ€ªç¸ç›®å‰è¡€é‡ -> æ¸›å»æˆ‘çš„æ”»æ“ŠåŠ› -> å‚³å›æ–°è¡€é‡
        // (é€™éƒ¨åˆ†ç•™çµ¦ä½ ç•¶ç·´ç¿’ï¼ç›®å‰æŒ‰ä¸‹å»å¯èƒ½ä¸æœƒæ‰£è¡€ï¼Œå› ç‚º body å‚³äº† hp:0 æœƒç›´æ¥ç§’æ®º XD)
        // ä¿®æ­£ï¼šç‚ºäº†è®“éŠæˆ²èƒ½ç©ï¼Œæˆ‘å€‘è®“ update_item æ”¯æ´ "damage" åƒæ•¸æœƒæ›´å¥½ï¼Œ
        // ä½†ç¾åœ¨æˆ‘å€‘ç”¨æœ€ç°¡å–®çš„ï¼š
        // 1. å–å¾—æ€ªç¸ -> 2. è¨ˆç®— -> 3. PUT
        // é€™è£¡ç‚ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘å€‘ç›´æ¥å‘¼å«å¾Œç«¯ï¼Œè®“å¾Œç«¯è™•ç† (å‡è¨­å¾Œç«¯æœ‰æ”¹)
        
        // è‡¨æ™‚è§£æ³•ï¼šæˆ‘å€‘ç›´æ¥ç”¨èˆŠçš„é‚è¼¯ï¼Œå…ˆ fetch å–®éš» -> æ‰£è¡€ -> PUT
        const res = await fetch(`${BASE_URL}/items/${id}`);
        const m = await res.json();
        let newHp = Math.max(0, m.hp - 15); // å›ºå®šæ‰£ 15
        await fetch(`${BASE_URL}/items/${id}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ hp: newHp })
        });
    }

    async function attackPlayer(targetId) {
        await fetch(`${BASE_URL}/shop/pvp/${targetId}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
    }

    async function playGacha() {
        const res = await fetch(`${BASE_URL}/shop/gacha`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        alert(data.message || data.detail);
        updateUserInfo();
    }

    async function buyHeal() {
        const res = await fetch(`${BASE_URL}/shop/heal`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        alert("è£œè¡€æˆåŠŸï¼");
        updateUserInfo();
    }

    // --- WebSocket ---
    const socket = new WebSocket(WS_URL);
    socket.onmessage = (e) => {
        const box = document.getElementById('battle-log');
        box.innerHTML = `<div class="log-entry">ğŸ“¡ ${e.data}</div>` + box.innerHTML;
        // æ”¶åˆ°ä»»ä½•å»£æ’­éƒ½åˆ·æ–°æ‰€æœ‰åˆ—è¡¨
        fetchMonsters();
        fetchPlayers();
        updateUserInfo();
    };
    setInterval(() => { if(socket.readyState===1) socket.send("ping"); }, 30000);

</script>
</body>
</html>