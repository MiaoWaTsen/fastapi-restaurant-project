<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ï¸ å¯¶å¯å¤¢å¤§äº‚é¬¥ V2.0.17 (åœ–é‘‘ä¿®å¾©ç‰ˆ) âš¡ï¸</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        [v-cloak] { display: none; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; color: #fff; padding: 20px; padding-bottom: 120px; user-select: none; }
        .container { max-width: 900px; margin: 0 auto; position: relative; }
        .navbar { display: flex; justify-content: space-between; align-items: center; background: #16213e; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #0f3460; }
        .user-info { display: flex; gap: 15px; width: 100%; }
        .user-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #f1c40f; object-fit: cover; }
        .user-stats { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .stat-block { background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 5px; }
        .stat-title { font-size: 0.9em; color: #aaa; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .bar-container { width: 100%; background: #333; height: 8px; border-radius: 4px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .hp-fill { background: linear-gradient(90deg, #e74c3c, #c0392b); } 
        .pet-xp-fill { background: linear-gradient(90deg, #3498db, #2980b9); } 
        .player-xp-fill { background: linear-gradient(90deg, #f1c40f, #d35400); }
        .bar-text { font-size: 0.75em; color: #ccc; display: flex; justify-content: space-between; margin-top: 1px; }
        .atk-val { color: #f1c40f; font-weight: bold; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px; background: #0f3460; border: none; color: #aaa; cursor: pointer; border-radius: 8px; font-weight: bold; min-width: 80px; transition:0.2s; display:flex; flex-direction:column; align-items:center; justify-content: center; }
        .tab-btn.active { background: #e94560; color: white; transform: translateY(-3px); }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .card { background: #0f3460; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; border: 1px solid transparent; transition:0.2s; position: relative; }
        .card:hover { border-color: #f1c40f; transform: translateY(-5px); }
        .card-img { width: 100%; height: 120px; object-fit: contain; background: #222; border-radius: 5px; }
        
        .btn-action { width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #c0392b; color: white; }
        .btn-small { width: 48%; padding: 5px; font-size: 0.9em; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; color: white; }
        .btn-disabled { background: #555 !important; cursor: not-allowed; opacity: 0.6; pointer-events: none; }

        .btn-gacha { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 10px; color: white; font-weight: bold; font-size: 1.1em; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn-gacha:hover { transform: translateY(-3px); }
        .gacha-normal { background: linear-gradient(90deg, #3498db, #2980b9); }
        .gacha-medium { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        .gacha-high { background: linear-gradient(90deg, #e67e22, #d35400); }
        .gacha-candy { background: linear-gradient(90deg, #e91e63, #c2185b); }
        .gacha-golden { background: linear-gradient(90deg, #f1c40f, #f39c12); color: #000; text-shadow: 0px 0px 2px white; }

        .quest-card { text-align: left; margin-bottom: 10px; border-left: 5px solid #aaa; padding: 15px; background:#1e2a38; transition: 0.3s; }
        .quest-completed { border-left-color: #2ecc71; background: #1b261b; }
        .quest-golden { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #000 !important; border-left: 5px solid #fff; box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
        .quest-golden h4, .quest-golden p { color: #000 !important; font-weight: bold; }

        .box-item.active { border: 2px solid #f1c40f; }
        .iv-tag { position: absolute; top: 5px; right: 5px; background: #f1c40f; color: black; padding: 2px 5px; border-radius: 3px; font-size: 0.7em; font-weight: bold; }
        
        .battle-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 15, 30, 0.98); z-index: 2000; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto;}
        .battle-header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .battle-arena { display: flex; justify-content: space-between; width: 100%; max-width: 800px; height: 350px; align-items: flex-end; position: relative; margin-top: 20px;}
        .fighter { width: 40%; text-align: center; position: relative; transition: 0.1s; }
        .fighter img { width: 100%; height: 180px; object-fit: contain; drop-shadow: 0 10px 10px rgba(0,0,0,0.5); }
        
        .fighter-stats { background: rgba(0,0,0,0.6); padding: 5px; border-radius: 5px; margin-top: 5px; text-align: left; border: 1px solid #444; }
        .fighter-name { font-weight: bold; font-size: 1.1em; margin-bottom: 2px; }
        .fighter-val { display: flex; justify-content: space-between; font-size: 0.8em; color: #ccc; }
        .fighter-buff { color: #f1c40f; font-size: 0.8em; height: 1.2em; font-weight: bold; text-align: center; margin-bottom: 2px; }

        .shake-hit { animation: shake 0.4s; }
        .flash-red { animation: flashRed 0.3s; }
        .flash-heal { animation: flashGreen 0.5s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-15px); } 75% { transform: translateX(15px); } 100% { transform: translateX(0); } }
        @keyframes flashRed { 0% { filter: sepia(1) hue-rotate(-50deg) saturate(5); } 100% { filter: none; } }
        @keyframes flashGreen { 0% { filter: sepia(1) hue-rotate(90deg) saturate(3); } 100% { filter: none; } }
        
        .floating-text { position: absolute; font-size: 2em; font-weight: bold; animation: floatUp 1.5s forwards; pointer-events: none; text-shadow: 2px 2px 0 #000; z-index: 3000; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 80% { opacity: 1; } 100% { transform: translateY(-80px) scale(1.1); opacity: 0; } }
        
        .timer-bar { width: 100%; height: 8px; background: #333; margin-top: 10px; border-radius: 4px; overflow: hidden; position: relative; }
        .timer-fill { height: 100%; background: #f1c40f; transition: width 1s linear; }
        .timer-text { position: absolute; top: -20px; right: 0; font-size: 0.9em; color: #aaa; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 4000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #16213e; border: 3px solid #f1c40f; padding: 30px; border-radius: 20px; text-align: center; width: 350px; position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 1.5em; color: #f1c40f; margin-bottom: 20px; }
        .btn-yes { background: #27ae60; padding: 10px 20px; border:none; color:white; border-radius:5px; cursor:pointer; margin:5px; }
        
        .chat-room { background: #1e2a38; border-radius: 10px; padding: 15px; height: 65vh; display: flex; flex-direction: column; border: 1px solid #333; }
        .chat-msgs { flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; text-align: left; }
        .chat-msg-item { margin-bottom: 5px; font-size: 0.95em; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 3px; }
        .chat-input-area { display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 12px; border-radius: 5px; border: none; background: #333; color: white; }
        
        .rate-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .rate-table th, .rate-table td { border: 1px solid #444; padding: 5px; font-size: 0.9em; text-align:left; }
        .skills-grid { width:100%; max-width:600px; margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:15px; }
        .btn-skill { padding: 15px; font-size: 1.1em; background: #3498db; color: white; border: none; border-radius: 10px; cursor: pointer; transition: 0.2s; position:relative; }
        .btn-skill:active { transform: scale(0.95); }
        .btn-shield { background: #f1c40f; color: black; font-weight: bold; }
        .btn-skill small { display: block; font-size: 0.7em; opacity: 0.8; }
        .detail-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333; }
        .pokedex-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .pokedex-item { background: #222; border-radius: 8px; padding: 10px; text-align: center; }
        .pokedex-img { width: 100%; height: 80px; object-fit: contain; }
        .pokedex-unknown { filter: brightness(0); opacity: 0.7; }
        .pokedex-owned { border: 2px solid #f1c40f; }
        .gacha-anim { font-size: 5em; animation: bounce 1s infinite; margin-bottom: 20px; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    </style>
</head>
<body>

<div id="loading" style="text-align:center; padding:50px; color:#aaa;">Loading...</div>

<div id="app" class="container" v-cloak>
    <div v-if="!user" style="text-align:center; padding-top:100px;">
        <h1 style="color:#e94560">å¯¶å¯å¤¢å¤§äº‚é¬¥ V2.0.17</h1>
        <p>åœ–é‘‘ä¿®å¾©ç‰ˆ</p>
        <button class="btn-action" @click="logout">å‰å¾€ç™»å…¥é é¢</button>
        <br><br>
        <button style="background:transparent; border:1px solid #aaa; color:#aaa; padding:5px;" @click="initAdmin">ğŸ‘‘ åˆå§‹åŒ–ç®¡ç†å“¡</button>
    </div>

    <div v-else>
        <div v-if="showGachaAnim" class="modal-overlay">
            <div style="text-align:center;">
                <div class="gacha-anim">ğŸ”®</div>
                <h2 style="color:white;">æŠ½çä¸­...</h2>
            </div>
        </div>
        <div v-if="gachaResult" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-title">ğŸ‰ æ­å–œç²å¾—ï¼</div>
                <h3 style="color:#f1c40f; font-size:1.5em; margin:10px 0;">{{ gachaResult.prize.name }}</h3>
                <p>IV: {{ gachaResult.prize.iv }}</p>
                <div style="margin-top:20px;"><button class="btn-yes" @click="gachaResult=null">å¤ªæ£’äº†</button></div>
            </div>
        </div>
        <div v-if="showBattleResult" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-title">ğŸ† æˆ°é¬¥å‹åˆ©ï¼</div>
                <p style="white-space: pre-wrap; line-height: 1.6;">{{ battleResultMsg }}</p>
                <div style="margin-top:20px;"><button class="btn-yes" @click="showBattleResult=false">ç¢ºå®š</button></div>
            </div>
        </div>

        <div v-if="viewMon" class="modal-overlay" @click.self="viewMon=null">
            <div class="modal-box">
                <div class="modal-title">{{ viewMon.name }} <span style="font-size:0.6em; color:#aaa;">(Lv.{{ viewMon.lv }})</span></div>
                <div style="text-align:center; margin-bottom:15px;">
                    <span style="background:#f1c40f; color:black; padding:2px 8px; border-radius:5px; font-weight:bold;">IV: {{ viewMon.iv }}</span>
                </div>
                <div class="detail-row"><span>â¤ï¸ æœ€å¤§è¡€é‡</span><b>{{ calcStats(viewMon).hp }}</b></div>
                <div class="detail-row"><span>âš”ï¸ æ”»æ“ŠåŠ›</span><b>{{ calcStats(viewMon).atk }}</b></div>
                <div class="detail-row"><span>âœ¨ ç¶“é©—å€¼</span><span>{{ viewMon.exp }}</span></div>
                <div style="margin-top:15px; text-align:left;">
                    <h4>âš¡ æŠ€èƒ½çµ„</h4>
                    <div v-for="skill in getMonSkills(viewMon.name)" :key="skill" style="background:#222; padding:5px; margin-bottom:5px; border-radius:5px;">
                        <b style="color:#3498db">{{ skill }}</b> <small style="color:#aaa;">{{ getSkillDesc(skill) }}</small>
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn-yes" style="flex:1; background:#7f8c8d" @click="viewMon=null">é—œé–‰</button>
                    <button class="btn-yes" style="flex:1; background:#e67e22;" @click="useCandy(viewMon.uid)">ğŸ¬ é¤µç³– ({{ inventory.growth_candy || 0 }})</button>
                    <button class="btn-yes" style="flex:1;" @click="swapMon(viewMon.uid); viewMon=null;">å‡ºæˆ°</button>
                </div>
            </div>
        </div>
        
        <div v-if="newsState.show" class="modal-overlay">
            <div class="modal-box" style="text-align:left;">
                <div class="modal-title" style="text-align:center;">ğŸ“¢ V2.0.17 æ›´æ–°å…¬å‘Š</div>
                <ul>
                    <li><b>ğŸ“– åœ–é‘‘ä¿®å¾©</b>ï¼šç¾åœ¨åªè¦æ‚¨ç›’å­è£¡æœ‰çš„å¯¶å¯å¤¢ï¼Œåœ–é‘‘å°±æœƒé¡¯ç¤ºç‚ºå·²æ”¶é›†ï¼</li>
                    <li><b>ğŸ ä»»å‹™ä¿®å¾©</b>ï¼šä»»å‹™é€²åº¦èˆ‡æŒ‰éˆ•ç¾åœ¨æœƒæ›´å³æ™‚åœ°æ›´æ–°ã€‚</li>
                </ul>
                <div style="text-align:center; margin-top:15px;">
                    <button class="btn-yes" @click="closeNews">æˆ‘çŸ¥é“äº†</button>
                </div>
            </div>
        </div>

        <div v-if="inLobby" class="lobby-bar">
            <span style="font-size:1.2em; margin-right:20px;">âš ï¸ æˆ°é¬¥æº–å‚™ä¸­...</span>
            <span style="font-size:1.5em; color:#f1c40f; font-family:monospace;">{{ lobbyTimer }}s</span>
        </div>

        <div class="navbar">
            <div class="user-info">
                <img :src="user.pokemon_image" class="user-avatar">
                <div class="user-stats">
                    <div class="stat-block">
                        <div class="stat-title"><span>{{ user.username }} (Lv.{{ user.level }})</span><span>ğŸ’° {{ user.money }}</span></div>
                        <div class="bar-container"><div class="bar-fill player-xp-fill" :style="{ width: playerXpPercent + '%' }"></div></div>
                        <div class="bar-text"><span>Trainer XP</span><span>{{ user.exp }}/{{ getReqXp(user.level) }}</span></div>
                    </div>
                    <div class="stat-block">
                        <div class="stat-title">
                            <span>{{ user.pokemon_name }} (Lv.{{ user.pet_level }})</span>
                            <span class="atk-val">ATK: {{ currentAtkMe }} (IV: {{ currentPetIV }})</span>
                        </div>
                        <div class="bar-container"><div class="bar-fill hp-fill" :style="{ width: hpPercent(user) + '%' }"></div></div>
                        <div class="bar-text"><span>HP: {{ user.hp }}/{{ user.max_hp }}</span></div>
                        <div class="bar-container" style="margin-top:4px;"><div class="bar-fill pet-xp-fill" :style="{ width: petXpPercent(user) + '%' }"></div></div>
                    </div>
                </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:5px;">
                <button class="btn-logout" @click="dailyCheckin">ğŸ“… ç°½åˆ°</button>
                <button class="btn-logout" @click="logout">ç™»å‡º</button>
            </div>
        </div>

        <div v-if="battle.active && !inLobby" class="battle-overlay">
            <div class="battle-header">
                <h2 style="color:#f1c40f; margin:0;">
                    {{ battle.mode === 'raid' ? 'ğŸ”¥ åœ˜é«”æˆ°' : (battle.mode === 'wild' ? 'ğŸŒ² é‡å¤–æ¢éšª' : 'âš”ï¸ PVP') }}
                </h2>
                <button class="btn-small" style="width:auto; background:#7f8c8d; padding:5px 10px;" @click="battle.active=false">é€ƒè·‘</button>
            </div>

            <div v-if="battle.mode === 'wild'" style="width:100%; max-width:600px; position:relative;">
                <div class="timer-bar">
                    <div class="timer-fill" :style="{width: (turnTimer/10)*100 + '%', background: turnTimer < 3 ? '#e74c3c' : '#f1c40f'}"></div>
                </div>
                <div class="timer-text">å›åˆ: {{ turnTimer }}s</div>
            </div>

            <div class="battle-arena">
                <div class="fighter" id="player-fighter">
                    <img :src="user.pokemon_image">
                    <div class="fighter-stats">
                        <div class="fighter-name" style="color:#3498db;">{{ user.username }}</div>
                        <div class="fighter-buff">
                            <span v-if="battle.atkBuff > 1">âš”ï¸ ATK +{{ Math.round((battle.atkBuff-1)*100) }}%</span>
                            <span v-if="battle.shieldActive">ğŸ›¡ï¸ è­·ç›¾</span>
                        </div>
                        <div class="bar-container"><div class="bar-fill hp-fill" :style="{width: hpPercent(user) + '%'}"></div></div>
                        <div class="fighter-val">
                            <span>HP: {{ user.hp }}/{{ user.max_hp }}</span>
                            <span style="color:#f1c40f;">ATK: {{ Math.floor(user.attack * battle.atkBuff) }}</span>
                        </div>
                    </div>
                </div>

                <div class="fighter" id="enemy-fighter">
                    <img :src="battle.target.image_url || battle.target.pokemon_image">
                    <div class="fighter-stats">
                        <div class="fighter-name" style="color:#e74c3c;">{{ battle.target.name || battle.target.username }}</div>
                        <div class="fighter-buff"></div>
                        <div class="bar-container"><div class="bar-fill hp-fill" :style="{width: (battle.target.hp/battle.target.max_hp)*100 + '%'}"></div></div>
                        <div class="fighter-val">
                            <span>HP: {{ battle.target.hp }}/{{ battle.target.max_hp }}</span>
                            <span style="color:#f1c40f;">ATK: {{ battle.target.attack }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="skills-grid">
                <button v-for="skill in mySkills" :key="skill" class="btn-skill" 
                        :class="{'btn-disabled': isEnemyTurn}" 
                        @click="doSkillAttack(skill)" 
                        :disabled="isEnemyTurn">
                    {{ skill }} <small>{{ getSkillDesc(skill) }}</small>
                </button>
                <button v-if="battle.mode === 'wild'" class="btn-skill btn-shield" 
                        :class="{'btn-disabled': isEnemyTurn}" 
                        @click="useShield" 
                        :disabled="shieldUses <= 0 || isEnemyTurn">
                    ğŸ›¡ï¸ é˜²è­·ç›¾ <small>å‰© {{ shieldUses }} æ¬¡</small>
                </button>
                <button v-else class="btn-skill" style="background:#27ae60" 
                        @click="doHeal" 
                        :class="{'btn-disabled': isEnemyTurn}" 
                        :disabled="isEnemyTurn">
                    ğŸ’Š é†«ç™‚åŒ… <small>å›å¾©20%</small>
                </button>
            </div>
        </div>

        <div class="tabs" v-if="!battle.active">
            <button class="tab-btn" :class="{active: tab=='wild'}" @click="tab='wild'">ğŸŒ² é‡å¤–</button>
            <button class="tab-btn" :class="{active: tab=='arena'}" @click="tab='arena'">ğŸŸï¸ ç«¶æŠ€</button>
            <button class="tab-btn" :class="{active: tab=='box'}" @click="tab='box'">ğŸ“¦ ç›’å­</button>
            <button class="tab-btn" :class="{active: tab=='bag'}" @click="tab='bag'">ğŸ’ èƒŒåŒ…</button>
            <button class="tab-btn" :class="{active: tab=='pokedex'}" @click="tab='pokedex'">ğŸ“– åœ–é‘‘</button>
            <button class="tab-btn" :class="{active: tab=='leaderboard'}" @click="tab='leaderboard'">ğŸ† æ’è¡Œ</button>
            <button class="tab-btn" :class="{active: tab=='raid'}" @click="tab='raid'">ğŸ”¥ åœ˜é«”æˆ°</button>
            <button class="tab-btn" :class="{active: tab=='quest'}" @click="tab='quest'">ğŸ“œ ä»»å‹™</button>
            <button class="tab-btn" :class="{active: tab=='shop'}" @click="tab='shop'">ğŸ›’ å•†åº—</button>
            <button class="tab-btn" :class="{active: tab=='gamble'}" @click="tab='gamble'">ğŸ° è³­å ´</button>
            <button class="tab-btn" :class="{active: tab=='chat'}" @click="tab='chat'">ğŸ’¬ èŠå¤©</button>
            <button class="tab-btn" :class="{active: tab=='social'}" @click="tab='social'">ğŸ‘¥ å¥½å‹</button>
        </div>

        <div v-if="!battle.active">
            <div v-if="tab=='wild'">
                <h3>ğŸŒ² é¸æ“‡æ¢éšªå€åŸŸ</h3>
                <div style="margin-bottom:15px; background:#2c3e50; padding:10px; border-radius:8px;">
                    <label>ç­‰ç´šé¸æ“‡ï¼š</label>
                    <select v-model="selectedWildLevel" @change="fetchWildList" style="padding:5px; background:#16213e; color:white; border:none;">
                        <option v-for="n in user.level" :value="n">Lv. {{ n }}</option>
                    </select>
                </div>
                <div class="card-grid">
                    <div v-for="m in wildList" :key="m.name" class="card">
                        <img :src="m.image_url" class="card-img">
                        <div style="margin-top:5px;">
                            <b>{{ m.name }}</b><br>
                            <small>Lv.{{ m.level }} | HP:{{m.hp}}</small><br>
                            <button class="btn-small" style="background:#c0392b" @click="startWildBattle(m)">æˆ°é¬¥</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="tab=='raid'">
                <h3>ğŸ”¥ å‚³èªªåœ˜é«”æˆ° (æ¯å¤© 8, 18, 22 é»)</h3>
                <div v-if="raidState.active" class="card" style="border:2px solid #e74c3c; background:#2c0b0e;">
                    <h2>Boss: {{ raidState.boss_name }}</h2>
                    <img :src="raidState.image" style="width:120px; height:120px;">
                    <div v-if="raidState.status === 'LOBBY'" style="color:#f1c40f; margin:10px 0;">
                        â³ æº–å‚™ä¸­... 00åˆ†æº–æ™‚é–‹æ‰“
                    </div>
                    <div v-else>
                        <div class="bar-container" style="height:20px;"><div class="hp-fill" :style="{width: (raidState.hp/raidState.max_hp)*100 + '%'}"></div></div>
                        <p>HP: {{ raidState.hp }} / {{ raidState.max_hp }}</p>
                    </div>
                    <button v-if="canJoinLobby || raidState.status=='FIGHTING'" class="btn-action" @click="joinRaid">åŠ å…¥æˆ°é¬¥ (1000G)</button>
                    <button v-else class="btn-disabled btn-action">å°šæœªé–‹æ”¾</button>
                </div>
                <div v-else class="card">
                    ç›®å‰æ²’æœ‰åœ˜é«”æˆ°
                </div>
            </div>

            <div v-if="tab=='quest'">
                <h3>ğŸ“œ å†’éšªä»»å‹™ (è‡ªå‹•è£œä½ç³»çµ±)</h3>
                <div v-for="q in quests" :key="q.id" class="card quest-card" 
                     :class="{'quest-golden': q.type=='GOLDEN', 'quest-completed': q.now >= q.req}">
                    <h4>
                        <span v-if="q.type=='GOLDEN'">âœ¨</span> 
                        {{ q.target_display || q.target }}
                        <span v-if="q.type=='GOLDEN'">âœ¨</span>
                    </h4>
                    
                    <div class="bar-container" style="height:12px; margin:10px 0; background:rgba(0,0,0,0.3);">
                        <div class="bar-fill" 
                             :style="{ width: Math.min(100, (q.now/q.req)*100) + '%', background: q.now >= q.req ? '#2ecc71' : (q.type=='GOLDEN' ? '#fff' : '#f1c40f') }">
                        </div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <p style="margin:2px 0;">é€²åº¦ï¼š{{ q.now }} / {{ q.req }}</p>
                            <p style="margin:2px 0; font-size:0.9em; opacity:0.8;">
                                çå‹µï¼š{{ q.type=='GOLDEN' ? 'âœ¨ é»ƒé‡‘ç³–æœ x1' : (q.gold + 'G / ' + q.xp + ' XP') }}
                            </p>
                        </div>
                        <button v-if="Number(q.now) >= Number(q.req)" class="btn-action" style="width:120px; background:#2ecc71;" @click="claimQuest(q.id)">ğŸ é ˜å–çå‹µ</button>
                        <button v-else class="btn-action" style="width:120px; background:#e74c3c; font-size:0.8em; opacity:0.8;" @click="abandonQuest(q.id)">æ›´æ› (-1000G)</button>
                    </div>
                </div>
            </div>

            <div v-if="tab=='box'">
                <h3>ğŸ“¦ å¯¶å¯å¤¢ç›’å­</h3>
                <div class="card-grid">
                    <div v-for="p in box" :key="p.uid" class="card" :class="{active: p.uid === user.active_pokemon_uid}" @click="viewMon=p" :style="{borderColor: p.uid === user.active_pokemon_uid ? '#f1c40f' : 'transparent'}">
                        <span class="iv-tag">IV: {{ p.iv }}</span>
                        <b>{{ p.name }}</b><div>Lv.{{ p.lv }}</div>
                    </div>
                </div>
            </div>
            
            <div v-if="tab=='shop'">
                <h3>ğŸ›’ æ‰­è›‹å•†åº— <button style="font-size:0.6em; background:#555; border:none; color:white; padding:3px;" @click="showRates=true">ğŸ“Š æ©Ÿç‡</button></h3>
                <button class="btn-gacha gacha-normal" @click="playGacha('normal')"><span>ğŸ”® åˆç´šæ‰­è›‹</span> <span>1500G</span></button>
                <button class="btn-gacha gacha-medium" @click="playGacha('medium')"><span>ğŸ”µ ä¸­ç´šæ‰­è›‹</span> <span>3000G</span></button>
                <button class="btn-gacha gacha-high" @click="playGacha('high')"><span>ğŸŸ£ é«˜ç´šæ‰­è›‹</span> <span>10000G</span></button>
                <button class="btn-gacha gacha-candy" @click="playGacha('candy')"><span>ğŸ¬ ç³–æœæ‰­è›‹</span> <span>12 Candy</span></button>
                <button class="btn-gacha gacha-golden" @click="playGacha('golden')"><span>âœ¨ é»ƒé‡‘æ‰­è›‹</span> <span>3 Golden</span></button>
                <br>
                <button class="btn-action" style="background:#27ae60" @click="buyHeal">ğŸ’Š è£œè¡€ (50G)</button>
                <div class="card" style="margin-top:15px; border-color:#aaa;">
                    <h4>ğŸ å…Œæ›ç¢¼</h4>
                    <div style="display:flex; gap:5px;">
                        <input v-model="promoCode" placeholder="è¼¸å…¥åºè™Ÿ" style="flex:1; padding:8px; border-radius:5px; border:none;">
                        <button class="btn-action" style="margin-top:0; width:80px;" @click="redeemCode">å…Œæ›</button>
                    </div>
                </div>
            </div>
            
            <div v-if="tab=='bag'">
                <div class="card">
                    <h3>ğŸ’ é“å…·èƒŒåŒ…</h3>
                    <div class="card-grid">
                        <div class="card" style="background:#2c3e50;"><div style="font-size:2em;">ğŸ¬</div><b>ç¥å¥‡ç³–æœ</b><div style="font-size:1.2em; color:#f1c40f;">{{ inventory.candy || 0 }}</div></div>
                        <div class="card" style="background:#2c3e50;"><div style="font-size:2em;">âœ¨</div><b>é»ƒé‡‘ç³–æœ</b><div style="font-size:1.2em; color:#f1c40f;">{{ inventory.golden_candy || 0 }}</div></div>
                        <div class="card" style="background:#2c3e50;"><div style="font-size:2em;">ğŸ’Š</div><b>æˆé•·ç³–æœ</b><div style="font-size:1.2em; color:#f1c40f;">{{ inventory.growth_candy || 0 }}</div></div>
                    </div>
                </div>
            </div>

            <div v-if="tab=='gamble'">
                <div class="card" style="text-align:center; border:2px solid #f39c12;">
                    <h3>ğŸ° å¹¸é‹è³­å ´</h3>
                    <input type="number" v-model.number="gambleAmount" placeholder="è¼¸å…¥é‡‘é¡" style="padding:10px; width:100px; border-radius:5px; border:none;">
                    <button class="btn-action" style="margin-top:10px; background:#f39c12; color:black;" @click="doGamble">ä¸‹æ³¨ï¼</button>
                </div>
            </div>

            <div v-if="tab=='social'">
                <h3>ğŸ‘¥ å¥½å‹èˆ‡ç®¡ç†</h3>
                <div v-if="friendRequests.length > 0" class="card" style="margin-bottom:15px; border:1px solid #f1c40f;">
                    <h4 style="color:#f1c40f;">ğŸ”” å¥½å‹é‚€è«‹</h4>
                    <div v-for="req in friendRequests" :key="req.request_id" style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #444; padding:5px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <img :src="req.pokemon_image" style="width:30px; height:30px; border-radius:50%;">
                            <span>{{ req.username }}</span>
                        </div>
                        <button class="btn-small" style="width:60px; background:#2ecc71;" @click="acceptFriend(req.request_id)">æ¥å—</button>
                    </div>
                </div>

                <div v-if="friends.length > 0">
                    <h4>æˆ‘çš„å¥½å‹</h4>
                    <div class="card-grid">
                        <div v-for="f in friends" :key="f.id" class="card">
                            <img :src="f.pokemon_image" style="width:50px; height:50px; border-radius:50%; margin-bottom:5px;">
                            <b>{{ f.username }}</b>
                            <button class="btn-small" style="width:100%; margin-top:5px; background:#f39c12" v-if="f.can_gift" @click="sendGift(f.id)">ğŸ é€ç¦®</button>
                        </div>
                    </div>
                </div>
                <div v-else class="card">æš«ç„¡å¥½å‹</div>
            </div>

            <div v-if="tab=='leaderboard'">
                <div class="card">
                    <h3>ğŸ† å…¨æœæ’è¡Œæ¦œ</h3>
                    <div style="margin-bottom:10px;">
                        <label>æ’åºæ–¹å¼ï¼š</label>
                        <select v-model="leaderboardType" @change="fetchLeaderboard" style="padding:5px; background:#16213e; color:white; border:none;">
                            <option value="level">ç­‰ç´š (Level)</option>
                            <option value="collection">åœ–é‘‘å®Œæˆç‡ (Collection)</option>
                            <option value="money">è²¡å¯Œ (Gold)</option>
                        </select>
                    </div>
                    <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                        <tr style="border-bottom:1px solid #555; text-align:left;">
                            <th style="padding:5px;">æ’å</th>
                            <th>ç©å®¶</th>
                            <th>æ•¸å€¼</th>
                        </tr>
                        <tr v-for="r in leaderboardData" :key="r.rank" style="border-bottom:1px solid #333;">
                            <td style="padding:8px;">
                                <span v-if="r.rank==1">ğŸ¥‡</span><span v-else-if="r.rank==2">ğŸ¥ˆ</span><span v-else-if="r.rank==3">ğŸ¥‰</span><span v-else>{{ r.rank }}</span>
                            </td>
                            <td><img :src="r.img" style="width:20px; height:20px; vertical-align:middle; border-radius:50%;"> {{ r.username }}</td>
                            <td>{{ r.value }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div v-if="tab=='pokedex'">
                <div class="card">
                    <h3>ğŸ“– å¯¶å¯å¤¢åœ–é‘‘</h3>
                    <div class="bar-container" style="margin-bottom:10px;">
                        <div class="bar-fill player-xp-fill" :style="{width: pokedexPercent + '%'}"></div>
                    </div>
                    <p>æ”¶é›†é€²åº¦: {{ pokedexPercent }}%</p>
                    <div class="pokedex-grid">
                        <div v-for="p in pokedexList" :key="p.name" class="pokedex-item" :class="{'pokedex-owned': p.owned}">
                            <img :src="p.img" class="pokedex-img" :class="{'pokedex-unknown': !p.owned}">
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="tab=='arena'">
                <h3>ğŸŸï¸ ç·šä¸Šç©å®¶</h3>
                <div class="card-grid">
                    <div v-for="p in players" :key="p.id" class="card" :style="{opacity: p.is_online ? 1 : 0.5}">
                        <img :src="p.pokemon_image" class="card-img">
                        <div style="margin-top:5px;">
                            <b>{{ p.username }}</b>
                            <span v-if="p.is_online" style="color:#2ecc71; font-size:0.8em;">â— åœ¨ç·š</span>
                            <span v-else style="color:#95a5a6; font-size:0.8em;">â— é›¢ç·š</span>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button v-if="p.is_online" class="btn-small" style="background:#c0392b" @click="sendInvite(p)">æ±ºé¬¥</button>
                                <button v-else class="btn-small btn-disabled" disabled>æ±ºé¬¥</button>
                                <button class="btn-small" style="background:#27ae60" @click="addFriend(p.id)">åŠ å¥½å‹</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="tab=='chat'">
                <h3>ğŸ’¬ ä¸–ç•Œé »é“</h3>
                <div class="chat-room">
                    <div class="chat-msgs" id="chat-box">
                        <div v-for="m in chatMsgs" class="chat-msg-item">{{ m }}</div>
                        <div v-if="chatMsgs.length === 0" style="color:#aaa; text-align:center;">ç›®å‰æ²’æœ‰è¨Šæ¯ï¼Œèªªé»ä»€éº¼å§ï¼</div>
                    </div>
                    <div class="chat-input-area">
                        <input v-model="chatInput" class="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." @keyup.enter="sendChat">
                        <button class="btn-action" style="margin-top:0; width:80px; background:#e94560;" @click="sendChat">é€å‡º</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showRates" class="modal-overlay" @click.self="showRates=false">
        <div class="modal-box" style="width: 400px; max-height:80vh;">
            <div class="modal-title">ğŸ“Š æ‰­è›‹æ©Ÿç‡è¡¨</div>
            <div style="overflow-y:auto; max-height:60vh;">
                <div v-for="(pool, name) in gachaRates" :key="name" style="margin-bottom: 15px;">
                    <h4 style="color: #f1c40f; border-bottom: 1px solid #555;">{{ name }}</h4>
                    <table class="rate-table">
                        <tr v-for="item in pool" :key="item.name"><td>{{ item.name }}</td><td style="text-align: right;">{{ item.rate }}%</td></tr>
                    </table>
                </div>
            </div>
            <button class="btn-yes" style="width: 100%; margin-top: 10px;" @click="showRates=false">é—œé–‰</button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, onMounted, computed, watch, onUpdated } = Vue;
    const API_URL = `https://mwtpokemons.zeabur.app/api/v1`;
    const WS_URL = `wss://mwtpokemons.zeabur.app/ws`;

    createApp({
        setup() {
            const user = ref(null);
            const token = localStorage.getItem('token');
            const tab = ref('wild'); 
            const box = computed(() => user.value ? JSON.parse(user.value.pokemon_storage) : []);
            
            const inventory = computed(() => {
                if(!user.value) return {};
                try { return JSON.parse(user.value.inventory); } catch(e) { return {}; }
            });

            const showGachaAnim = ref(false);
            const gachaResult = ref(null);
            const showBattleResult = ref(false);
            const battleResultMsg = ref("");

            const quests = ref([]);
            const players = ref([]);
            const friends = ref([]);
            const friendRequests = ref([]);
            const selectedMon = ref(null);
            const viewMon = ref(null);
            
            const skillData = ref({});
            const mySkills = ref(["æ’æ“Š", "æ’æ“Š", "æ’æ“Š"]);
            const shieldUses = ref(2);
            const pokedexList = ref([]);
            const pokedexPercent = ref(0);
            const pokedexMap = ref({});
            
            const turnTimer = ref(10);
            const isEnemyTurn = ref(false);
            let timerInterval = null;

            const currentPetIV = computed(() => {
                if(!user.value) return 0;
                const p = box.value.find(x => x.uid === user.value.active_pokemon_uid);
                return p ? p.iv : 50;
            });
            const playerXpPercent = computed(() => user.value ? Math.min(100, (user.value.exp / getReqXp(user.value.level)) * 100) : 0);
            const hpPercent = (u) => (u.hp / u.max_hp) * 100;
            const petXpPercent = (u) => Math.min(100, (u.pet_exp / (u.next_pet_level_exp || 9999)) * 100);
            const currentAtkMe = computed(() => user.value ? user.value.attack : 0);

            const battle = ref({ active: false, mode: 'wild', target: null, shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false });
            const raidState = ref({ active: false, hp: 0, max_hp: 0, boss_name: '', status: 'IDLE', image: '' });
            const inLobby = ref(false);
            const lobbyTimer = ref(15);
            let lobbyInterval = null;
            
            const leaderboardData = ref([]);
            const leaderboardType = ref("level");
            const newsState = ref({ show: false });

            const chatMsgs = ref([]);
            const chatInput = ref("");
            const gambleAmount = ref(100);
            const promoCode = ref("");
            const selectedWildLevel = ref(1);
            const wildList = ref([]);
            const showRates = ref(false);
            const gachaRates = {
                "ğŸ”® åˆç´šæ‰­è›‹ (1500G)": [ {name: "å¦™è›™ç¨®å­/å°ç«é¾/å‚‘å°¼é¾œ", rate: 5}, {name: "ä¼Šå¸ƒ/çš®å¡ä¸˜/æ¯›è¾®ç¾Š", rate: 8}, {name: "çš®çš®/èƒ–ä¸", rate: 10}, {name: "å¤§è”¥é´¨/å‘†å‘†ç¸/å¯é”é´¨", rate: 12}, {name: "å¡æ¯”ç¸/å‰åˆ©è›‹", rate: 2} ],
                "ğŸ”µ ä¸­ç´šæ‰­è›‹ (3000G)": [ {name: "å¾¡ä¸‰å®¶/ä¼Šå¸ƒ/çš®å¡ä¸˜/å‘†å‘†ç¸/å¯é”é´¨/æ¯›è¾®ç¾Š", rate: 10}, {name: "å¡æ¯”ç¸", rate: 5}, {name: "å‰åˆ©è›‹/æ‹‰æ™®æ‹‰æ–¯/å¾¡ä¸‰å®¶é€²åŒ–", rate: 3} ],
                "ğŸŸ£ é«˜ç´šæ‰­è›‹ (10000G)": [ {name: "å¡æ¯”ç¸", rate: 20}, {name: "å‰åˆ©è›‹", rate: 24}, {name: "å¹¸ç¦è›‹/æ‹‰æ™®æ‹‰æ–¯/å¾¡ä¸‰å®¶é€²åŒ–", rate: 10}, {name: "å¿«é¾", rate: 6} ],
                "ğŸ¬ ç³–æœæ‰­è›‹ (12 Candy)": [ {name: "ä¼Šå¸ƒ/çš®å¡ä¸˜", rate: 20}, {name: "å¾¡ä¸‰å®¶é€²åŒ–/å¡æ¯”ç¸/å‰åˆ©è›‹", rate: 10}, {name: "å¹¸ç¦è›‹", rate: 4}, {name: "æ‹‰æ™®æ‹‰æ–¯/å¿«é¾", rate: 3} ],
                "âœ¨ é»ƒé‡‘æ‰­è›‹ (3 Golden)": [ {name: "å¡æ¯”ç¸", rate: 30}, {name: "å‰åˆ©è›‹", rate: 35}, {name: "å¹¸ç¦è›‹", rate: 20}, {name: "æ‹‰æ™®æ‹‰æ–¯", rate: 10}, {name: "å¿«é¾", rate: 5} ]
            };
            
            const SKILL_MAP = {
                "å°æ‹‰é”": ["æŠ“", "å‡ºå¥‡ä¸€æ“Š", "æ’æ“Š"], "æ³¢æ³¢": ["æŠ“", "å•„", "ç‡•è¿”"], 
                "å¦™è›™ç¨®å­": ["è—¤é­", "ç¨®å­ç‚¸å½ˆ", "æ±¡æ³¥ç‚¸å½ˆ"], "å°ç«é¾": ["ç«èŠ±", "å™´å°„ç«ç„°", "å¤§å­—çˆ†ç‚"], "å‚‘å°¼é¾œ": ["æ°´æ§", "æ°´æµå™´å°„", "æ°´æµå°¾"],
                "å¡æ¯”ç¸": ["æ³°å±±å£“é ‚", "åœ°éœ‡", "æ’æ“Š"], "çš®å¡ä¸˜": ["é›»å…‰", "æ”¾é›»", "é›»æ“Š"], "å¿«é¾": ["æŠ“", "é€†é±—", "å‹‡é³¥çŒ›æ”»"]
            };

            const getReqXp = (lv) => 100 * Math.pow(1.5, lv - 1);
            const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };

            const updateInfo = async () => {
                try {
                    const res = await fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if(res.ok) {
                        user.value = await res.json();
                        if(selectedWildLevel.value > user.value.level) selectedWildLevel.value = user.value.level;
                    } else window.location.href = 'login.html';
                } catch(e) {}
            };

            const fetchPlayers = async () => { const res = await fetch(`${API_URL}/auth/all`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) players.value = await res.json(); };
            const fetchFriends = async () => { 
                const res = await fetch(`${API_URL}/social/list`, { headers: { 'Authorization': `Bearer ${token}` } }); 
                if(res.ok) friends.value = await res.json();
                
                const res2 = await fetch(`${API_URL}/social/requests`, { headers: { 'Authorization': `Bearer ${token}` } }); 
                if(res2.ok) friendRequests.value = await res2.json();
            };
            const fetchQuests = async () => { const res = await fetch(`${API_URL}/quests/`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) quests.value = await res.json(); updateInfo(); };
            const fetchLeaderboard = async () => { const res = await fetch(`${API_URL}/social/leaderboard?type=${leaderboardType.value}`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) leaderboardData.value = await res.json(); };
            
            const checkRaid = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/status`); if(res.ok) raidState.value = await res.json(); };
            const fetchWildList = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/wild/list?level=${selectedWildLevel.value}`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) wildList.value = await res.json(); };
            const fetchSkillData = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/data/skills`); if(res.ok) skillData.value = await res.json(); };
            const initAdmin = async () => { try { const res = await fetch(`${API_URL}/social/admin/init`); const d = await res.json(); alert(d.message); } catch(e) {} };
            
            const fetchPokedex = async () => { 
                const res = await fetch(`${API_URL.replace('/items','')}/shop/pokedex/all`, { headers: { 'Authorization': `Bearer ${token}` } }); 
                if(res.ok && user.value) { 
                    const allMons = await res.json(); 
                    allMons.forEach(m => pokedexMap.value[m.name] = m);
                    
                    // ğŸ”¥ åœ–é‘‘ä¿®å¾©æ ¸å¿ƒï¼šæª¢æŸ¥ç›’å­ + è§£é–ç´€éŒ„
                    const unlockedStr = (user.value.unlocked_monsters || "").split(","); 
                    const boxNames = box.value.map(p => p.name);
                    
                    pokedexList.value = allMons.map(m => ({ 
                        ...m, 
                        owned: unlockedStr.includes(m.name) || boxNames.includes(m.name) 
                    })); 
                    
                    // é‡æ–°è¨ˆç®—ç™¾åˆ†æ¯”
                    const ownedCount = pokedexList.value.filter(m => m.owned).length;
                    pokedexPercent.value = Math.floor((ownedCount / allMons.length) * 100); 
                } 
            };

            const updateMySkills = () => {
                if(!user.value || !box.value) return;
                const active = box.value.find(p => p.uid === user.value.active_pokemon_uid);
                if(active) mySkills.value = SKILL_MAP[active.name] || ["æ’æ“Š", "æ’æ“Š", "æ’æ“Š"];
            };
            
            const calcStats = (mon) => {
                const base = pokedexMap.value[mon.name];
                if (!base) return { hp: "???", atk: "???" };
                const ivMult = 0.9 + (mon.iv / 100) * 0.2;
                const growth = Math.pow(1.06, mon.lv - 1);
                const hp = Math.floor(base.hp * ivMult * growth);
                const atk = Math.floor(base.atk * ivMult * growth);
                return { hp, atk };
            };
            
            const getMonSkills = (name) => SKILL_MAP[name] || ["æ’æ“Š", "æ’æ“Š", "æ’æ“Š"];
            const closeNews = () => { newsState.value.show = false; sessionStorage.setItem('seenNews_v2017', 'true'); };

            onUpdated(() => {
                const chatBox = document.getElementById('chat-box');
                if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;
            });

            onMounted(async () => {
                document.getElementById('loading').style.display = 'none'; 
                if(!token) return window.location.href = 'login.html';
                if (!sessionStorage.getItem('seenNews_v2017')) newsState.value.show = true;
                await updateInfo(); await fetchSkillData(); await fetchPokedex(); // é †åºèª¿æ•´ï¼Œç¢ºä¿ user æœ‰å€¼
                updateMySkills(); 
                fetchPlayers(); checkRaid(); setInterval(checkRaid, 5000); fetchQuests(); fetchWildList();
                
                try {
                    const ws = new WebSocket(`${WS_URL}?token=${token}`);
                    ws.onmessage = (e) => {
                        const msg = e.data;
                        if(msg.startsWith("CHAT|")) { chatMsgs.value.push(msg.split("|")[1]); }
                    };
                } catch(e) { console.error("WS error", e); }
            });
            
            watch(tab, (n) => { 
                if(n==='arena') fetchPlayers(); if(n==='social') fetchFriends(); if(n==='quest') fetchQuests(); 
                if(n==='wild') fetchWildList(); if(n==='pokedex') fetchPokedex(); if(n==='leaderboard') fetchLeaderboard();
            });
            watch(user, () => updateMySkills());

            const startWildBattle = (target) => {
                shieldUses.value = 2; updateMySkills();
                battle.value = { active: true, mode: 'wild', target: JSON.parse(JSON.stringify(target)), shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false };
                turnTimer.value = 10; isEnemyTurn.value = false;
                startTurnTimer();
            };
            
            const startTurnTimer = () => {
                clearInterval(timerInterval);
                turnTimer.value = 10;
                if (battle.value.mode !== 'wild') return; 
                timerInterval = setInterval(() => {
                    turnTimer.value--;
                    if(turnTimer.value <= 0) { 
                        clearInterval(timerInterval); 
                        isEnemyTurn.value = true; 
                        showFloatingText("é€¾æ™‚!", "red");
                        setTimeout(enemyAttackPhase, 1000); 
                    }
                }, 1000);
            };

            const getSkillDesc = (name) => { const s = skillData.value[name]; return s ? `${s.dmg}å‚· ${s.desc || ''}` : ''; };

            const doSkillAttack = async (skillName) => {
                if(isEnemyTurn.value) return; 
                if(!skillData.value[skillName]) return;
                
                isEnemyTurn.value = true;
                clearInterval(timerInterval);

                const skill = skillData.value[skillName];
                
                if (skill.effect === 'buff_atk' && Math.random() < skill.prob) {
                    battle.value.atkBuff = 1 + skill.val;
                    showFloatingText(`ATK UP!`, 'gold');
                } else if (skill.effect === 'heal' && Math.random() < skill.prob) {
                    const healAmt = Math.floor(user.value.max_hp * skill.val);
                    user.value.hp = Math.min(user.value.max_hp, user.value.hp + healAmt);
                    showFloatingText(`+${healAmt}`, 'green');
                }

                let dmg = Math.floor((user.value.attack / 100) * skill.dmg * battle.value.atkBuff);
                if (dmg < 1) dmg = 1;
                
                showFloatingText(`-${dmg}`, 'red', true); 

                if(battle.value.mode === 'wild') {
                    battle.value.target.hp = Math.max(0, battle.value.target.hp - dmg); 
                    battle.value.shakeTarget = true; setTimeout(()=>battle.value.shakeTarget=false, 500);
                    const enemyEl = document.getElementById('enemy-fighter'); if(enemyEl) { enemyEl.classList.add('flash-red'); setTimeout(()=>enemyEl.classList.remove('flash-red'), 300); }
                    
                    if(battle.value.target.hp <= 0) {
                        const res = await fetch(`${API_URL.replace('/items','')}/shop/wild/attack?is_win=true&is_powerful=${battle.value.target.is_powerful||false}&target_name=${battle.value.target.raw_name}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                        const d = await res.json(); 
                        battleResultMsg.value = `é€ æˆ ${dmg} å‚·å®³\n${d.message}`;
                        showBattleResult.value = true;
                        battle.value.active = false; 
                        updateInfo(); 
                        // ğŸ”¥ é—œéµä¿®æ­£ï¼šå»¶é²æ›´æ–°ä»»å‹™ï¼Œç¢ºä¿å¾Œç«¯å¯«å…¥å®Œç•¢
                        setTimeout(fetchQuests, 500); 
                    } else { setTimeout(() => { enemyAttackPhase(); }, 1200); }
                }
                else if (battle.value.mode === 'raid') {
                    battle.value.shakeTarget = true; setTimeout(()=>battle.value.shakeTarget=false, 500);
                    const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/attack?damage=${dmg}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                    const d = await res.json();
                    if(d.message.includes("å°šæœªé–‹å§‹")) showFloatingText("å°šæœªé–‹å§‹", "gold");
                    if(d.boss_hp !== undefined) battle.value.target.hp = d.boss_hp;
                    setTimeout(() => { isEnemyTurn.value = false; startTurnTimer(); }, 800);
                }
            };
            
            const enemyAttackPhase = () => {
                if(battle.value.shieldActive) {
                    alert(`ğŸ›¡ï¸ æ“‹ä¸‹å‚·å®³ï¼`);
                    battle.value.shieldActive = false; isEnemyTurn.value = false; startTurnTimer();
                } else {
                    const enemyDmg = Math.floor(((battle.value.target.attack / 100) * 20));
                    user.value.hp = Math.max(0, user.value.hp - enemyDmg);
                    battle.value.shakeMe = true; setTimeout(()=>battle.value.shakeMe=false, 500);
                    showFloatingText(`-${enemyDmg}`, 'red'); 
                    if(user.value.hp <= 0) { 
                        alert("ä½ è¢«æ‰“æ•—äº†..."); battle.value.active = false; 
                        fetch(`${API_URL.replace('/items','')}/shop/wild/attack?is_win=false`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                        buyHeal(); 
                    } else { isEnemyTurn.value = false; startTurnTimer(); }
                }
            };
            
            const showFloatingText = (text, color='red', isEnemy=false) => {
                const arena = document.querySelector('.battle-arena'); if(!arena) return;
                const el = document.createElement('div'); el.className = 'floating-text';
                el.innerText = text; el.style.color = color === 'gold' ? '#f1c40f' : (color === 'green' ? '#2ecc71' : '#e74c3c');
                el.style.left = isEnemy ? '60%' : '20%'; el.style.top = '30%';
                arena.appendChild(el); setTimeout(() => el.remove(), 1500);
            };

            const playGacha = async (type) => { 
                showGachaAnim.value = true; 
                const res = await fetch(`${API_URL.replace('/items','')}/shop/gacha/${type}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); 
                const d = await res.json(); 
                setTimeout(() => { showGachaAnim.value = false; gachaResult.value = d; updateInfo(); }, 2000); 
            };

            const useShield = () => { 
                if(shieldUses.value <= 0) return; 
                shieldUses.value--; battle.value.shieldActive = true; 
                showFloatingText("ğŸ›¡ï¸ é˜²è­·ç›¾é–‹å•Ÿ", 'gold');
                isEnemyTurn.value = true; 
                clearInterval(timerInterval);
                setTimeout(() => { enemyAttackPhase(); }, 1200); 
            };

            const doHeal = async () => { const heal = Math.floor(user.value.max_hp * 0.2); user.value.hp = Math.min(user.value.max_hp, user.value.hp + heal); alert(`å›å¾©äº† ${heal} HP`); };
            const dailyCheckin = async () => { const res = await fetch(`${API_URL}/social/daily_checkin`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const swapMon = async (uid) => { await fetch(`${API_URL.replace('/items','')}/shop/box/swap/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); updateInfo(); };
            const useCandy = async (uid) => { const res = await fetch(`${API_URL.replace('/items','')}/shop/box/action/candy/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const doGamble = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/gamble?amount=${gambleAmount.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const sendChat = async () => { if(!chatInput.value) return; await fetch(`${API_URL}/social/chat/send?content=${chatInput.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); chatInput.value = ""; };
            const buyHeal = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/heal`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { alert("è£œè¡€æˆåŠŸ"); updateInfo(); } else alert("é‡‘å¹£ä¸è¶³"); };
            const redeemCode = async () => { const res = await fetch(`${API_URL}/social/redeem?code=${promoCode.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const sendGift = async (fid) => { const res = await fetch(`${API_URL}/social/gift/send/${fid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { alert("ç¦®ç‰©å·²ç™¼é€ï¼"); fetchFriends(); } else { const d = await res.json(); alert(d.detail); } };
            const sendInvite = async (p) => { await fetch(`${API_URL.replace('/items','')}/shop/duel/invite/${p.id}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); alert("å·²é‚€è«‹"); };
            const addFriend = async (uid) => { const res = await fetch(`${API_URL}/social/add/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); };
            const acceptFriend = async (reqId) => { await fetch(`${API_URL}/social/accept/${reqId}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); alert("å·²æ¥å—å¥½å‹ï¼"); fetchFriends(); };
            
            const joinRaid = async () => { 
                if(confirm("æ”¯ä»˜ 1000G åŠ å…¥ï¼Ÿ")) { 
                    const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/join`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); 
                    if(res.ok) { 
                        battle.value = { active: true, mode: 'raid', target: { name: raidState.value.boss_name, hp: raidState.value.hp, max_hp: raidState.value.max_hp, image_url: raidState.value.image }, shakeMe: false, shakeTarget: false }; 
                    } else { const d = await res.json(); alert(d.detail); } 
                } 
            };

            const canJoinLobby = computed(() => raidState.value.status === 'LOBBY');
            const abandonQuest = async (qid) => { if(confirm("æ”¾æ£„éœ€æ¶ˆè€— 1000Gï¼Œç¢ºå®šå—ï¼Ÿ")) { await fetch(`${API_URL}/quests/abandon/${qid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); fetchQuests(); } };
            const claimQuest = async (qid) => { const res = await fetch(`${API_URL}/quests/claim/${qid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message); fetchQuests(); };

            return { user, tab, box, players, friends, friendRequests, selectedMon, battle, raidState, inLobby, lobbyTimer, dailyCheckin, logout, playGacha, swapMon, useCandy, gambleAmount, doGamble, chatMsgs, chatInput, sendChat, doSkillAttack, useShield, doHeal, buyHeal, promoCode, redeemCode, sendGift, joinRaid, playerXpPercent, hpPercent, petXpPercent, currentAtkMe, quests, abandonQuest, claimQuest, wildList, fetchWildList, startWildBattle, showRates, gachaRates, mySkills, shieldUses, getSkillDesc, selectedWildLevel, viewMon, calcStats, pokedexList, pokedexPercent, getReqXp, showGachaAnim, gachaResult, showBattleResult, battleResultMsg, inventory, leaderboardData, leaderboardType, fetchLeaderboard, initAdmin, newsState, closeNews, currentPetIV, addFriend, acceptFriend, sendInvite, canJoinLobby, turnTimer, isEnemyTurn };
        }
    }).mount('#app');
</script>
</body>
</html>