<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ å¦™è›™å®¸çš„ç†±è¡€æˆ°å ´ ğŸ”¥</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; color: #fff; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; color: #e94560; text-shadow: 0 0 10px #e94560; margin-bottom: 30px; }

        /* --- æˆ°é¬¥ä½ˆå±€ --- */
        .game-area { display: flex; gap: 20px; align-items: flex-start; }
        
        /* å·¦é‚Šï¼šæ€ªç¸å€ */
        .card-grid { flex: 2; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        
        /* å³é‚Šï¼šæˆ°å ±å€ */
        .battle-log-panel { flex: 1; background: #16213e; border: 2px solid #0f3460; border-radius: 10px; height: 500px; padding: 15px; overflow-y: auto; position: sticky; top: 20px; }
        .log-title { text-align: center; color: #4cc9f0; margin-top: 0; border-bottom: 1px solid #4cc9f0; padding-bottom: 10px; }
        .log-entry { margin-bottom: 8px; font-size: 0.9em; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .log-crit { color: #ffeb3b; font-weight: bold; }
        .log-heal { color: #2ecc71; }
        .log-die { color: #e74c3c; font-weight: bold; }

        /* --- å¡ç‰‡èˆ‡å‹•ç•« --- */
        .card { background: #0f3460; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-5px); border: 2px solid #e94560; }
        
        /* å—å‚·éœ‡å‹•å‹•ç•« */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shaking { animation: shake 0.5s; border: 2px solid red; }
        
        /* æ­»äº¡ç‰¹æ•ˆ */
        .dead { filter: grayscale(100%); opacity: 0.6; pointer-events: none; }

        .card-img { width: 100%; height: 180px; object-fit: cover; background: #fff; }
        .card-body { padding: 15px; }
        .card-title { font-size: 1.3em; margin: 0; color: #fff; font-weight: bold; }
        .hp-text { float: right; font-size: 0.9em; color: #ccc; }

        /* è¡€æ¢ */
        .hp-bar-bg { background: #333; height: 12px; border-radius: 6px; margin: 10px 0; overflow: hidden; border: 1px solid #555; }
        .hp-bar-fill { background: linear-gradient(90deg, #e74c3c, #c0392b); height: 100%; width: 100%; transition: width 0.3s ease-out; }

        /* æŒ‰éˆ• */
        .btn-group { display: flex; gap: 5px; }
        button { flex: 1; padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-attack { background: linear-gradient(to bottom, #e74c3c, #c0392b); }
        .btn-attack:active { transform: scale(0.95); }
        .btn-heal { background: linear-gradient(to bottom, #2ecc71, #27ae60); }
        
        /* RWD: æ‰‹æ©Ÿç‰ˆæŠŠæˆ°å ±å¾€ä¸‹æ”¾ */
        @media (max-width: 768px) {
            .game-area { flex-direction: column-reverse; }
            .battle-log-panel { width: 100%; height: 200px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>âš”ï¸ å¦™è›™å®¸çš„ç†±è¡€æˆ°å ´ âš”ï¸</h1>
    
    <div class="game-area">
        <div id="monster-list" class="card-grid">
            <div style="text-align:center; width:100%; color:#888;">æ­£åœ¨å°‹æ‰¾å°æ‰‹...</div>
        </div>

        <div class="battle-log-panel">
            <h3 class="log-title">ğŸ“œ æˆ°é¬¥ç´€éŒ„</h3>
            <div id="battle-log"></div>
        </div>
    </div>
</div>

<script>
    // âš ï¸ è¨˜å¾—æª¢æŸ¥é€™è£¡æ˜¯ä¸æ˜¯ä½ çš„ Zeabur ç¶²å€
    const API_URL = 'https://mwtpokemons.zeabur.app/api/v1/items/';

    // å•Ÿå‹•éŠæˆ²
    fetchMonsters();

    // 1. è®€å–æ€ªç¸
    async function fetchMonsters() {
        const container = document.getElementById('monster-list');
        try {
            const res = await fetch(API_URL);
            if (!res.ok) throw new Error('é€£ç·šå¤±æ•—');
            const monsters = await res.json();
            
            container.innerHTML = ''; 
            if (monsters.length === 0) {
                container.innerHTML = '<p>åœ°åœ–ä¸Šæ²’æœ‰æ€ªç¸ï¼Œå¿«å»å¬å–šï¼</p>';
                return;
            }

            monsters.forEach(m => {
                // æ¸²æŸ“å¡ç‰‡
                renderCard(container, m);
            });

        } catch (err) {
            console.error(err);
            container.innerHTML = `<p style="color:red">ä¼ºæœå™¨é€£ç·šå¤±æ•—</p>`;
        }
    }

    // è¼”åŠ©å‡½å¼ï¼šç”¢ç”Ÿå¡ç‰‡ HTML
    function renderCard(container, m) {
        const hpPercent = Math.max(0, (m.hp / m.max_hp) * 100);
        const img = m.image_url || 'https://via.placeholder.com/300x200?text=Monster';
        const isDead = m.hp <= 0 ? 'dead' : '';
        const hpColor = hpPercent < 30 ? '#e74c3c' : (hpPercent < 60 ? '#f1c40f' : '#2ecc71');

        const html = `
            <div class="card ${isDead}" id="card-${m.id}">
                <img src="${img}" class="card-img">
                <div class="card-body">
                    <div>
                        <span class="card-title">${m.name}</span>
                        <span class="hp-text" id="hp-text-${m.id}">${m.hp}/${m.max_hp}</span>
                    </div>
                    
                    <div class="hp-bar-bg">
                        <div class="hp-bar-fill" id="hp-bar-${m.id}" style="width: ${hpPercent}%; background:${hpColor}"></div>
                    </div>

                    <div class="btn-group">
                        <button class="btn-attack" onclick="playerAttack(${m.id}, ${m.hp}, '${m.name}')">ğŸ‘Š æ”»æ“Š</button>
                        <button class="btn-heal" onclick="playerHeal(${m.id}, ${m.hp}, ${m.max_hp}, '${m.name}')">ğŸ’– æ²»ç™’</button>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    }

    // 2. ç©å®¶æ”»æ“Šé‚è¼¯ (å«çˆ†æ“Šç‡)
    async function playerAttack(id, currentHp, name) {
        if (currentHp <= 0) return; // æ­»äº†ä¸èƒ½æ‰“

        // --- éŠæˆ²é‚è¼¯å€ ---
        const isCrit = Math.random() < 0.3; // 30% æ©Ÿç‡çˆ†æ“Š
        const baseDamage = 15 + Math.floor(Math.random() * 10); // æµ®å‹•å‚·å®³ 15~25
        const damage = isCrit ? baseDamage * 2 : baseDamage;
        
        let newHp = Math.max(0, currentHp - damage);
        
        // --- è¦–è¦ºç‰¹æ•ˆå€ ---
        // 1. è®“å¡ç‰‡éœ‡å‹•
        const card = document.getElementById(`card-${id}`);
        card.classList.remove('shaking'); // é‡ç½®å‹•ç•«
        void card.offsetWidth; // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª
        card.classList.add('shaking');

        // 2. å¯«å…¥æˆ°å ±
        const logMsg = isCrit 
            ? `<span class="log-crit">ğŸ’¥ çˆ†æ“Šï¼ä½ å° [${name}] é€ æˆäº† ${damage} é»å·¨é‡å‚·å®³ï¼</span>`
            : `ğŸ—¡ï¸ ä½ æ”»æ“Šäº† [${name}]ï¼Œé€ æˆ ${damage} é»å‚·å®³ã€‚`;
        addLog(logMsg);

        if (newHp === 0) {
            addLog(`<span class="log-die">ğŸ’€ [${name}] è¢«ä½ æ“Šæ•—äº†ï¼</span>`);
            card.classList.add('dead'); // è®Šç°
        }

        // --- å¾Œç«¯æºé€šå€ ---
        // å…ˆåœ¨å‰ç«¯æ›´æ–°è¡€æ¢ (çœ‹èµ·ä¾†æ¯”è¼ƒé †)ï¼Œç„¶å¾Œå†å·å‚³çµ¦å¾Œç«¯
        updateCardUI(id, newHp); // æš«æ™‚æ›´æ–° UI (ä¸ç­‰å¾Œç«¯)
        
        // é€™è£¡éœ€è¦é‡æ–°æŠ“å–åŸæœ¬çš„ max_hp (å› ç‚º onclick è£¡çš„åƒæ•¸æ˜¯èˆŠçš„)
        // å·æ‡¶åšæ³•ï¼šç›´æ¥æŠŠæŒ‰éˆ•çš„ onclick æ›´æ–°æˆæ–°çš„æ•¸å€¼
        updateButtonParams(id, newHp, name);

        try {
            await fetch(API_URL + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hp: newHp })
            });
        } catch (e) {
            console.error("åŒæ­¥å¤±æ•—", e);
        }
    }

    // 3. ç©å®¶æ²»ç™’é‚è¼¯
    async function playerHeal(id, currentHp, maxHp, name) {
        if (currentHp >= maxHp) {
            addLog(`âš ï¸ [${name}] è¡€é‡å·²æ»¿ï¼Œç„¡éœ€æ²»ç™‚ã€‚`);
            return;
        }
        if (currentHp <= 0) {
            addLog(`âš ï¸ [${name}] å·²ç¶“å€’ä¸‹äº†ï¼Œç„¡æ³•å¾©æ´»ã€‚`);
            return;
        }

        const heal = 30;
        let newHp = Math.min(maxHp, currentHp + heal);

        addLog(`<span class="log-heal">âœ¨ ä½ æ–½å±•äº†æ²»ç™’è¡“ï¼Œ[${name}] å›å¾©äº† ${heal} é»ç”Ÿå‘½ã€‚</span>`);
        
        updateCardUI(id, newHp, maxHp);
        updateButtonParams(id, newHp, name, maxHp);

        await fetch(API_URL + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hp: newHp })
        });
    }

    // æ›´æ–° UI å·¥å…·
    function updateCardUI(id, hp, maxHp) {
        // å¦‚æœæ²’å‚³ maxHpï¼Œæˆ‘å€‘å‡è¨­å®ƒæ²’è®Šï¼Œé€™è£¡ç°¡åŒ–è™•ç†ï¼Œ
        // å¯¦éš›é–‹ç™¼é€šå¸¸æœƒå¾ DOM è®€å–æˆ–é‡æ–° fetch
        const bar = document.getElementById(`hp-bar-${id}`);
        const text = document.getElementById(`hp-text-${id}`);
        
        // è®€å–ç•¶å‰çš„ max (å¾æ–‡å­—è£¡å·æŠ“)
        const currentMax = parseInt(text.innerText.split('/')[1]);
        
        const percent = (hp / currentMax) * 100;
        bar.style.width = `${percent}%`;
        text.innerText = `${hp}/${currentMax}`;

        // è¡€é‡é¡è‰²è®ŠåŒ–
        if (percent < 30) bar.style.background = '#e74c3c';
        else if (percent < 60) bar.style.background = '#f1c40f';
        else bar.style.background = '#2ecc71';
    }

    function updateButtonParams(id, newHp, name, maxHp) {
       // æ›´æ–° onclick åƒæ•¸ï¼Œé€™æ¨£ä¸‹æ¬¡é»æ“Šæ‰æœƒç”¨æ–°çš„è¡€é‡è¨ˆç®—
       // æ³¨æ„ï¼šé€™åªæ˜¯ç°¡å–®çš„å‰ç«¯æ›´æ–°ï¼Œæ­£è¦åšæ³•æ‡‰è©²é‡æ–° render æˆ–ç”¨ Vue/React
       const card = document.getElementById(`card-${id}`);
       const btnAttack = card.querySelector('.btn-attack');
       const btnHeal = card.querySelector('.btn-heal');
       
       // é‡æ–°ç¶å®šäº‹ä»¶
       btnAttack.onclick = () => playerAttack(id, newHp, name);
       // é€™è£¡æœ‰é»å·æ‡¶ï¼ŒmaxHp æˆ‘å€‘éœ€è¦æƒ³è¾¦æ³•ä¿å­˜ï¼Œé€™è£¡å…ˆä¸æ›´æ–° heal çš„ maxHp åƒæ•¸
    }

    // å¯«å…¥æˆ°å ±å·¥å…·
    function addLog(html) {
        const box = document.getElementById('battle-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = html;
        box.prepend(entry); // æŠŠæœ€æ–°çš„è¨Šæ¯æ’åœ¨æœ€ä¸Šé¢
    }

</script>

</body>
</html>