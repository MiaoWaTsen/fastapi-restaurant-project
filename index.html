<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ï¸ å¯¶å¯å¤¢å¤§äº‚é¬¥ V2.0 âš¡ï¸</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; color: #fff; padding: 20px; padding-bottom: 120px; user-select: none; }
        .container { max-width: 900px; margin: 0 auto; }
        .btn-action { width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #c0392b; color: white; }
        .card { background: #0f3460; border-radius: 10px; padding: 10px; margin-bottom:10px; border: 1px solid #444; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 10px; background: #16213e; color: #aaa; border: 1px solid #333; cursor: pointer; }
        .tab-btn.active { background: #e94560; color: white; border-color: #e94560; }
        
        /* æˆ°é¬¥ç›¸é—œ */
        .battle-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 15, 30, 0.98); z-index: 2000; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .battle-arena { display: flex; justify-content: space-between; width: 100%; max-width: 900px; height: 300px; align-items: flex-end; }
        .fighter { width: 45%; text-align: center; }
        .fighter img { width: 100px; height: 100px; object-fit: contain; }
        .bar-container { width: 100%; background: #333; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .hp-fill { background: #e74c3c; height: 100%; transition: width 0.3s; }
        .shake-hit { animation: shake 0.4s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } 100% { transform: translateX(0); } }

        /* èŠå¤©å®¤ */
        .chat-panel { position: fixed; bottom: 0; left: 0; width: 100%; height: 120px; background: rgba(0,0,0,0.9); z-index: 5000; padding: 10px; display: flex; flex-direction: column; }
        .chat-msgs { flex: 1; overflow-y: auto; font-size: 0.9em; margin-bottom: 5px; }
        .chat-input-area { display: flex; gap: 5px; }
        .chat-input { flex: 1; padding: 5px; border-radius: 5px; border: none; }
        
        /* ç›’å­ */
        .box-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .box-item { background: #222; padding: 10px; border-radius: 5px; text-align: center; border: 2px solid transparent; cursor: pointer; }
        .box-item.active { border-color: #f1c40f; }
        .iv-tag { font-size: 0.8em; color: #f1c40f; font-weight: bold; }
        
        /* åœ˜é«”æˆ° */
        .raid-boss { text-align: center; border: 2px solid #e74c3c; padding: 20px; border-radius: 10px; background: #2c0b0e; }
        .raid-hp { height: 20px; background: #555; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .raid-hp-fill { height: 100%; background: #e74c3c; transition: width 0.5s; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div v-if="!user" style="text-align:center; padding-top:100px;">
        <h1 style="color:#e94560">å¯¶å¯å¤¢å¤§äº‚é¬¥ V2.0</h1>
        <p>è«‹å…ˆç™»å…¥ (V2.0 è‡ªå‹•é‡ç½®ç‚º Lv.1)</p>
        <button class="btn-action" @click="logout">å‰å¾€ç™»å…¥é é¢</button>
    </div>

    <div v-else>
        <div class="card" style="display:flex; gap:10px; align-items:center;">
            <img :src="user.pokemon_image" style="width:60px; height:60px; border-radius:50%;">
            <div style="flex:1;">
                <div><b>{{ user.username }}</b> Lv.{{ user.level }}</div>
                <div>ğŸ’° {{ user.money }} | IV: {{ currentPetIV }}</div>
            </div>
            <button style="background:#27ae60; color:white; border:none; padding:5px 10px; border-radius:5px;" @click="dailyCheckin">ğŸ“… ç°½åˆ°</button>
            <button style="background:#555; color:white; border:none; padding:5px 10px; border-radius:5px;" @click="logout">ç™»å‡º</button>
        </div>

        <div v-if="battle.active" class="battle-overlay">
            <h2 style="color:#f1c40f">{{ battle.mode === 'raid' ? 'ğŸ”¥ åœ˜é«”æˆ°' : (battle.mode === 'wild' ? 'ğŸŒ² é‡å¤–é­é‡' : 'âš”ï¸ PVP å°æ±º') }}</h2>
            <div class="battle-arena">
                <div class="fighter" :class="{'shake-hit': battle.shakeMe}">
                    <img :src="user.pokemon_image">
                    <div>{{ user.pokemon_name }} (Lv.{{ user.pet_level }})</div>
                    <div class="bar-container"><div class="hp-fill" :style="{width: (user.hp/user.max_hp)*100 + '%'}"></div></div>
                    <small>{{ user.hp }}/{{ user.max_hp }}</small>
                </div>
                <div class="fighter" :class="{'shake-hit': battle.shakeTarget}">
                    <img :src="battle.target.image_url || battle.target.pokemon_image">
                    <div>{{ battle.target.name || battle.target.username }}</div>
                    <div class="bar-container"><div class="hp-fill" :style="{width: (battle.target.hp/battle.target.max_hp)*100 + '%'}"></div></div>
                    <small>HP: {{ battle.target.hp }}</small>
                </div>
            </div>
            <div style="width:100%; max-width:600px; margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn-action" @click="doAttack(1.0)">æ™®é€šæ”»æ“Š</button>
                <button class="btn-action" style="background:#3498db" @click="doAttack(1.2)">æŠ€èƒ½æ”»æ“Š (CD)</button>
                <button class="btn-action" style="background:#27ae60" @click="doHeal">ğŸ’Š é†«ç™‚åŒ… (20%)</button>
                <button class="btn-action" style="background:#7f8c8d" @click="battle.active=false">é€ƒè·‘</button>
            </div>
        </div>

        <div class="tabs" v-if="!battle.active">
            <button class="tab-btn" :class="{active: tab=='wild'}" @click="tab='wild'">ğŸŒ² é‡å¤–</button>
            <button class="tab-btn" :class="{active: tab=='raid'}" @click="tab='raid'">ğŸ”¥ åœ˜é«”æˆ°</button>
            <button class="tab-btn" :class="{active: tab=='box'}" @click="tab='box'">ğŸ“¦ ç›’å­</button>
            <button class="tab-btn" :class="{active: tab=='shop'}" @click="tab='shop'">ğŸ›’ å•†åº—</button>
            <button class="tab-btn" :class="{active: tab=='gamble'}" @click="tab='gamble'">ğŸ° è³­å ´</button>
            <button class="tab-btn" :class="{active: tab=='social'}" @click="tab='social'">ğŸ’¬ ç¤¾äº¤</button>
        </div>

        <div v-if="!battle.active">
            <div v-if="tab=='wild'">
                <h3>âš”ï¸ é­é‡é‡æ€ª</h3>
                <button class="btn-action" @click="findWild">å°‹æ‰¾é‡æ€ª</button>
            </div>

            <div v-if="tab=='raid'">
                <h3>ğŸ”¥ å‚³èªªåœ˜é«”æˆ°</h3>
                <div v-if="raidState.active" class="raid-boss">
                    <h2>Boss: {{ raidState.boss_name }}</h2>
                    <div class="raid-hp"><div class="raid-hp-fill" :style="{width: (raidState.hp/raidState.max_hp)*100 + '%'}"></div></div>
                    <p>HP: {{ raidState.hp }} / {{ raidState.max_hp }}</p>
                    <button class="btn-action" @click="joinRaid">åŠ å…¥æˆ°é¬¥ (1000G)</button>
                </div>
                <div v-else class="card">ç›®å‰æ²’æœ‰åœ˜é«”æˆ° (08:00, 18:00, 22:00 é–‹æ”¾)</div>
            </div>

            <div v-if="tab=='box'">
                <h3>ğŸ“¦ å¯¶å¯å¤¢ç›’å­ ({{ box.length }}/25)</h3>
                <div class="box-grid">
                    <div v-for="p in box" :key="p.uid" class="box-item" :class="{active: p.uid === user.active_pokemon_uid}" @click="selectedMon=p">
                        <div><b>{{ p.name }}</b></div>
                        <div class="iv-tag">IV: {{ p.iv }}</div>
                        <div>Lv.{{ p.lv }}</div>
                    </div>
                </div>
                <div v-if="selectedMon" class="card" style="margin-top:15px; border-color:#f1c40f;">
                    <h4>å·²é¸æ“‡: {{ selectedMon.name }}</h4>
                    <p>IV: {{ selectedMon.iv }} | ç­‰ç´š: {{ selectedMon.lv }}</p>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-action" style="background:#2ecc71" @click="swapMon(selectedMon.uid)">å‡ºæˆ°</button>
                        <button class="btn-action" style="background:#3498db" @click="useCandy(selectedMon.uid)">ğŸ¬ é¤µç³–</button>
                        <button class="btn-action" style="background:#e74c3c" @click="releaseMon(selectedMon.uid)">ğŸ‘‹ æ”¾ç”Ÿ</button>
                    </div>
                </div>
            </div>

            <div v-if="tab=='shop'">
                <h3>ğŸ›’ æ‰­è›‹å•†åº—</h3>
                <button class="btn-action" @click="playGacha('normal')">ğŸ”® åˆç´š (1500G)</button>
                <button class="btn-action" style="background:linear-gradient(45deg, #3498db, #2980b9)" @click="playGacha('medium')">ğŸ”µ ä¸­ç´š (3000G)</button>
                <button class="btn-action" style="background:linear-gradient(45deg, #8e44ad, #9b59b6)" @click="playGacha('high')">ğŸŸ£ é«˜ç´š (10000G)</button>
                <button class="btn-action" style="background:#27ae60" @click="buyHeal">ğŸ’Š è£œè¡€ (50G)</button>
            </div>

            <div v-if="tab=='gamble'">
                <div class="card" style="text-align:center; border:2px solid #f39c12;">
                    <h3>ğŸ° å¹¸é‹è³­å ´</h3>
                    <input type="number" v-model.number="gambleAmount" placeholder="è¼¸å…¥é‡‘é¡" style="padding:10px; width:100px;">
                    <button class="btn-action" style="margin-top:10px; background:#f39c12; color:black;" @click="doGamble">ä¸‹æ³¨ï¼</button>
                </div>
            </div>
            
            <div v-if="tab=='social'">
                <h3>ğŸ’¬ ç¤¾äº¤èˆ‡ç®¡ç†</h3>
                <div v-if="user.is_admin" class="card" style="border-color:red;">
                    <h4>ğŸ”´ ç®¡ç†å“¡é¢æ¿</h4>
                    <input v-model="adminTargetId" placeholder="ç©å®¶ID" style="width:50px;">
                    <button @click="adminAction('mute')">ç¦è¨€</button>
                    <button @click="adminAction('ban')">åˆªå¸³è™Ÿ</button>
                    <br><input v-model="announceText" placeholder="å…¬å‘Šå…§å®¹">
                    <button @click="adminAction('announce')">ç™¼å…¬å‘Š</button>
                </div>
                <div class="card">
                    <h4>ğŸ å…Œæ›ç¢¼</h4>
                    <input v-model="promoCode" placeholder="è¼¸å…¥åºè™Ÿ">
                    <button @click="redeemCode">å…Œæ›</button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="user" class="chat-panel">
        <div class="chat-msgs" id="chat-box">
            <div v-for="m in chatMsgs" style="margin-bottom:2px;">{{ m }}</div>
        </div>
        <div class="chat-input-area">
            <input v-model="chatInput" class="chat-input" placeholder="èªªé»ä»€éº¼..." @keyup.enter="sendChat">
            <button @click="sendChat" style="padding:0 15px;">é€å‡º</button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, onMounted, computed } = Vue;
    const API_URL = `https://mwtpokemons.zeabur.app/api/v1`;
    const WS_URL = `wss://mwtpokemons.zeabur.app/ws`;

    createApp({
        setup() {
            const user = ref(null);
            const token = localStorage.getItem('token');
            const tab = ref('box');
            const box = computed(() => user.value ? JSON.parse(user.value.pokemon_storage) : []);
            const selectedMon = ref(null);
            const currentPetIV = computed(() => {
                if(!user.value) return 0;
                const p = box.value.find(x => x.uid === user.value.active_pokemon_uid);
                return p ? p.iv : 50;
            });
            
            // æˆ°é¬¥ç‹€æ…‹
            const battle = ref({ active: false, mode: 'wild', target: null, shakeMe: false, shakeTarget: false });
            const raidState = ref({ active: false, hp: 0, max_hp: 0, boss_name: '' });
            
            const chatMsgs = ref([]);
            const chatInput = ref("");
            const gambleAmount = ref(100);
            const adminTargetId = ref("");
            const announceText = ref("");
            const promoCode = ref("");

            const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };

            const updateInfo = async () => {
                const res = await fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                if(res.ok) user.value = await res.json();
                else window.location.href = 'login.html';
            };

            const checkRaid = async () => {
                const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/status`);
                raidState.value = await res.json();
            };

            onMounted(() => {
                if(!token) return window.location.href = 'login.html';
                updateInfo();
                checkRaid();
                setInterval(checkRaid, 5000); // è¼ªè©¢åœ˜é«”æˆ°ç‹€æ…‹
                
                const ws = new WebSocket(`${WS_URL}?token=${token}`);
                ws.onmessage = (e) => {
                    const msg = e.data;
                    if(msg.startsWith("CHAT|")) chatMsgs.value.push(msg.split("|")[1]);
                    if(msg.startsWith("RAID_UPDATE|")) {
                        const parts = msg.split("|");
                        raidState.value.hp = parseInt(parts[1]);
                        raidState.value.max_hp = parseInt(parts[2]);
                    }
                    if(msg.startsWith("RAID_WIN|")) alert(`ğŸ‰ åœ˜é«”æˆ°å‹åˆ©ï¼ç”± ${msg.split("|")[1]} çµ¦å‡ºæœ€å¾Œä¸€æ“Šï¼`);
                };
            });

            // æˆ°é¬¥é‚è¼¯
            const findWild = async () => {
                const res = await fetch(`${API_URL.replace('/items','')}/shop/wild/encounter?level=${user.value.level}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                battle.value = { active: true, mode: 'wild', target: data, shakeMe: false, shakeTarget: false };
            };
            
            const joinRaid = async () => {
                if(confirm("æ”¯ä»˜ 1000G åŠ å…¥åœ˜é«”æˆ°ï¼Ÿ")) {
                    const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/join`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                    if(res.ok) {
                        battle.value = { active: true, mode: 'raid', target: { name: raidState.value.boss_name, hp: raidState.value.hp, max_hp: raidState.value.max_hp, image_url: '' }, shakeMe: false, shakeTarget: false };
                    } else {
                        const d = await res.json(); alert(d.detail);
                    }
                }
            };

            const doAttack = async (mult) => {
                const dmg = Math.floor(user.value.attack * mult);
                
                if(battle.value.mode === 'wild') {
                    battle.value.target.hp -= dmg;
                    battle.value.shakeTarget = true; setTimeout(()=>battle.value.shakeTarget=false, 500);
                    if(battle.value.target.hp <= 0) {
                        const res = await fetch(`${API_URL.replace('/items','')}/shop/wild/attack?is_win=true&is_powerful=${battle.value.target.is_powerful||false}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                        const d = await res.json(); alert(d.message);
                        battle.value.active = false; updateInfo();
                    } else {
                        // æ•µäººåæ“Š
                        setTimeout(() => {
                            user.value.hp -= Math.floor(battle.value.target.attack * 0.8);
                            battle.value.shakeMe = true; setTimeout(()=>battle.value.shakeMe=false, 500);
                        }, 500);
                    }
                } else if(battle.value.mode === 'raid') {
                    const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/attack?damage=${dmg}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                    const d = await res.json();
                    if(d.result === 'WIN') { alert("Boss æ“Šæ•—ï¼ç²å¾—çå‹µ"); battle.value.active = false; updateInfo(); }
                    else { battle.value.target.hp = d.boss_hp; }
                }
            };
            
            const doHeal = async () => {
                // V2.0 é†«ç™‚åŒ…ï¼šå› 20%
                const heal = Math.floor(user.value.max_hp * 0.2);
                user.value.hp = Math.min(user.value.max_hp, user.value.hp + heal);
                alert(`å›å¾©äº† ${heal} HP`);
            };

            // (å…¶é¤˜ actions ä¿æŒä¸è®Š: dailyCheckin, playGacha, swapMon...)
            const dailyCheckin = async () => { const res = await fetch(`${API_URL}/social/daily_checkin`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const playGacha = async (type) => { const res = await fetch(`${API_URL.replace('/items','')}/shop/gacha/${type}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const swapMon = async (uid) => { await fetch(`${API_URL.replace('/items','')}/shop/box/swap/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); updateInfo(); };
            const releaseMon = async (uid) => { if(!confirm("ç¢ºå®šæ”¾ç”Ÿï¼Ÿ")) return; await fetch(`${API_URL.replace('/items','')}/shop/box/action/release/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); selectedMon.value = null; updateInfo(); };
            const useCandy = async (uid) => { const res = await fetch(`${API_URL.replace('/items','')}/shop/box/action/candy/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const doGamble = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/gamble?amount=${gambleAmount.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const sendChat = async () => { if(!chatInput.value) return; await fetch(`${API_URL}/social/chat/send?content=${chatInput.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); chatInput.value = ""; };
            const buyHeal = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/heal`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { alert("è£œè¡€æˆåŠŸ"); updateInfo(); } else alert("é‡‘å¹£ä¸è¶³"); };
            const redeemCode = async () => { const res = await fetch(`${API_URL}/social/redeem?code=${promoCode.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const adminAction = async (act) => { await fetch(`${API_URL}/social/admin/action?action=${act}&target_id=${adminTargetId.value}&content=${announceText.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); alert("åŸ·è¡ŒæˆåŠŸ"); };

            return { user, tab, box, selectedMon, currentPetIV, battle, raidState, dailyCheckin, logout, playGacha, swapMon, releaseMon, useCandy, gambleAmount, doGamble, chatMsgs, chatInput, sendChat, findWild, joinRaid, doAttack, doHeal, buyHeal, adminTargetId, announceText, adminAction, promoCode, redeemCode };
        }
    }).mount('#app');
</script>
</body>
</html>