<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ï¸ å¯¶å¯å¤¢å¤§äº‚é¬¥ V3.2 (æŠ€èƒ½ç‰¹æ•ˆç‰ˆ) âš¡ï¸</title>
    <script>
        window.onerror = function(msg, source, lineno) {
            const loader = document.getElementById('loading');
            if(loader) loader.innerHTML = `<h3 style="color:red">âš ï¸ éŒ¯èª¤</h3><p>${msg}</p>`;
            fetch('https://mwtpokemons.zeabur.app/api/v1/social/log/frontend', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({msg: msg, source: source, lineno: lineno})
            });
        };
    </script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        [v-cloak] { display: none; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; color: #fff; padding: 20px; padding-bottom: 120px; user-select: none; }
        .container { max-width: 900px; margin: 0 auto; }
        .navbar { display: flex; justify-content: space-between; align-items: center; background: #16213e; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #0f3460; }
        .user-info { display: flex; gap: 15px; width: 100%; }
        .user-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #f1c40f; object-fit: cover; }
        .user-stats { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .stat-block { background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 5px; }
        .stat-title { font-size: 0.9em; color: #aaa; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .bar-container { width: 100%; background: #333; height: 8px; border-radius: 4px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .hp-fill { background: linear-gradient(90deg, #e74c3c, #c0392b); } 
        .pet-xp-fill { background: linear-gradient(90deg, #3498db, #2980b9); } 
        .player-xp-fill { background: linear-gradient(90deg, #f1c40f, #d35400); }
        .bar-text { font-size: 0.75em; color: #ccc; display: flex; justify-content: space-between; margin-top: 1px; }
        .atk-val { color: #f1c40f; font-weight: bold; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px; background: #0f3460; border: none; color: #aaa; cursor: pointer; border-radius: 8px; font-weight: bold; min-width: 80px; transition:0.2s; display:flex; flex-direction:column; align-items:center; justify-content: center; }
        .tab-btn.active { background: #e94560; color: white; transform: translateY(-3px); }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .card { background: #0f3460; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; border: 1px solid transparent; transition:0.2s; position: relative; }
        .card:hover { border-color: #f1c40f; transform: translateY(-5px); }
        .card-img { width: 100%; height: 120px; object-fit: contain; background: #222; border-radius: 5px; }
        
        .btn-action { width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #c0392b; color: white; }
        .btn-small { width: 48%; padding: 5px; font-size: 0.9em; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; color: white; }
        
        .quest-card { text-align: left; margin-bottom: 10px; border-left: 5px solid #aaa; padding: 15px; background:#1e2a38; }
        .quest-active { border-left-color: #f1c40f; } 
        .quest-completed { border-left-color: #2ecc71; background: #1b261b; }
        .quest-golden { background: linear-gradient(45deg, #f1c40f, #f39c12); color: #000; border-left: 5px solid #fff; }

        .box-item.active { border: 2px solid #f1c40f; }
        .iv-tag { position: absolute; top: 5px; right: 5px; background: #f1c40f; color: black; padding: 2px 5px; border-radius: 3px; font-size: 0.7em; font-weight: bold; }
        
        .battle-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 15, 30, 0.98); z-index: 2000; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .battle-arena { display: flex; justify-content: space-between; width: 100%; max-width: 800px; height: 350px; align-items: flex-end; }
        .fighter { width: 45%; text-align: center; position: relative; transition: 0.3s; }
        .fighter img { width: 100%; height: 200px; object-fit: contain; drop-shadow: 0 10px 10px rgba(0,0,0,0.5); }
        .shake-hit { animation: shake 0.4s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } 100% { transform: translateX(0); } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 4000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #16213e; border: 3px solid #f1c40f; padding: 30px; border-radius: 20px; text-align: center; width: 300px; position: relative; }
        .modal-title { font-size: 1.5em; color: #f1c40f; margin-bottom: 20px; }
        .btn-yes { background: #27ae60; padding: 10px 20px; border:none; color:white; border-radius:5px; cursor:pointer; margin:5px; }
        
        .chat-panel { position: fixed; bottom: 0; left: 0; width: 100%; height: 120px; background: rgba(0,0,0,0.95); z-index: 9999; padding: 10px; display: flex; flex-direction: column; border-top: 1px solid #333; }
        .chat-msgs { flex: 1; overflow-y: auto; font-size: 0.9em; margin-bottom: 5px; color: #ccc; }
        .chat-input { flex: 1; padding: 8px; border-radius: 5px; border: none; background: #333; color: white; }
        
        .lobby-bar { position: fixed; bottom: 130px; left: 0; width: 100%; background: rgba(22, 33, 62, 0.95); border-top: 3px solid #f1c40f; padding: 10px; z-index: 6000; display: flex; justify-content: center; align-items: center; }
        
        .rate-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .rate-table th, .rate-table td { border: 1px solid #444; padding: 5px; font-size: 0.9em; text-align:left; }
        
        /* 4-Button Grid for Battle */
        .skills-grid { width:100%; max-width:600px; margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:15px; }
        .btn-skill { padding: 15px; font-size: 1.1em; background: #3498db; color: white; border: none; border-radius: 10px; cursor: pointer; transition: 0.2s; position:relative; }
        .btn-skill:active { transform: scale(0.95); }
        .btn-shield { background: #f1c40f; color: black; font-weight: bold; }
        .btn-skill small { display: block; font-size: 0.7em; opacity: 0.8; }
    </style>
</head>
<body>

<div id="loading" style="text-align:center; padding:50px; color:#aaa;">Loading...</div>

<div id="app" class="container" v-cloak>
    <div v-if="!user" style="text-align:center; padding-top:100px;">
        <h1 style="color:#e94560">å¯¶å¯å¤¢å¤§äº‚é¬¥ V3.2</h1>
        <p>æŠ€èƒ½ç‰¹æ•ˆèˆ‡æ•¸å€¼å®Œå…¨ä¿®æ­£ç‰ˆ</p>
        <button class="btn-action" @click="logout">å‰å¾€ç™»å…¥é é¢</button>
        <br><br>
        <button style="background:transparent; border:1px solid #aaa; color:#aaa; padding:5px;" @click="initAdmin">ğŸ‘‘ åˆå§‹åŒ–ç®¡ç†å“¡</button>
    </div>

    <div v-else>
        <div v-if="newsState.show" class="modal-overlay">
            <div class="modal-box" style="text-align:left;">
                <div class="modal-title" style="text-align:center;">ğŸ“¢ V3.2 æ›´æ–°å…¬å‘Š</div>
                <ul>
                    <li><b>âš”ï¸ æŠ€èƒ½ç‰¹æ•ˆ</b>ï¼šå¯¦è£åŠ æ”»ã€å›è¡€ã€åå‚·æ©Ÿç‡ã€‚</li>
                    <li><b>ğŸ›¡ï¸ æˆ°é¬¥ä»‹é¢</b>ï¼šå„ªåŒ–ç‚º 4 éµæ“ä½œï¼Œç¯€å¥æ›´å¿«ã€‚</li>
                    <li><b>ğŸŒ² åš´æ ¼åˆ†ç´š</b>ï¼šLv.1 åªèƒ½é‡åˆ° å°æ‹‰é”ï¼Œä»¥æ­¤é¡æ¨ã€‚</li>
                </ul>
                <div style="text-align:center; margin-top:15px;">
                    <button class="btn-yes" @click="closeNews">æˆ‘çŸ¥é“äº†</button>
                </div>
            </div>
        </div>

        <div class="navbar">
            <div class="user-info">
                <img :src="user.pokemon_image" class="user-avatar">
                <div class="user-stats">
                    <div class="stat-block">
                        <div class="stat-title">
                            <span>{{ user.username }} <span v-if="user.is_admin" style="color:red">[GM]</span> (Lv.{{ user.level }})</span>
                            <span>ğŸ’° {{ user.money }}</span>
                        </div>
                        <div class="bar-container"><div class="bar-fill player-xp-fill" :style="{ width: playerXpPercent + '%' }"></div></div>
                        <div class="bar-text"><span>Trainer XP</span><span>{{ user.exp }}/{{ user.next_level_exp }}</span></div>
                    </div>

                    <div class="stat-block">
                        <div class="stat-title">
                            <span>{{ user.pokemon_name }} (Lv.{{ user.pet_level }})</span>
                            <span class="atk-val">ATK: {{ currentAtkMe }} (IV: {{ currentPetIV }})</span>
                        </div>
                        <div class="bar-container"><div class="bar-fill hp-fill" :style="{ width: hpPercent(user) + '%' }"></div></div>
                        <div class="bar-text"><span>HP: {{ user.hp }}/{{ user.max_hp }}</span></div>
                        <div class="bar-container" style="margin-top:4px;"><div class="bar-fill pet-xp-fill" :style="{ width: petXpPercent(user) + '%' }"></div></div>
                    </div>
                </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:5px;">
                <button class="btn-logout" @click="dailyCheckin">ğŸ“… ç°½åˆ°</button>
                <button class="btn-logout" @click="logout">ç™»å‡º</button>
            </div>
        </div>

        <div v-if="battle.active && !inLobby" class="battle-overlay">
            <h2 style="color:#f1c40f">{{ battle.mode === 'raid' ? 'ğŸ”¥ åœ˜é«”æˆ°' : (battle.mode === 'wild' ? 'ğŸŒ² é‡å¤–é­é‡' : 'âš”ï¸ PVP å°æ±º') }}</h2>
            <div class="battle-arena">
                <div class="fighter" :class="{'shake-hit': battle.shakeMe}">
                    <img :src="user.pokemon_image">
                    <div>{{ user.username }} <span v-if="battle.atkBuff > 1" style="color:#f1c40f">â–²</span></div>
                    <div class="bar-container"><div class="bar-fill hp-fill" :style="{width: hpPercent(user) + '%'}"></div></div>
                    <small>{{ user.hp }}/{{ user.max_hp }}</small>
                </div>
                <div class="fighter" :class="{'shake-hit': battle.shakeTarget}">
                    <img :src="battle.target.image_url || battle.target.pokemon_image">
                    <div>{{ battle.target.name || battle.target.username }}</div>
                    <div class="bar-container"><div class="bar-fill hp-fill" :style="{width: (battle.target.hp/battle.target.max_hp)*100 + '%'}"></div></div>
                    <small>HP: {{ battle.target.hp }}</small>
                </div>
            </div>
            
            <div class="skills-grid">
                <button v-for="skill in mySkills" :key="skill" class="btn-skill" @click="doSkillAttack(skill)">
                    {{ skill }} <small>{{ getSkillDesc(skill) }}</small>
                </button>
                <button class="btn-skill btn-shield" @click="useShield" :disabled="shieldUses <= 0">
                    ğŸ›¡ï¸ é˜²è­·ç›¾ <small>å‰© {{ shieldUses }} æ¬¡</small>
                </button>
            </div>
            <div style="margin-top:10px; text-align:center;">
                <button @click="battle.active=false" style="background:none; border:none; color:#7f8c8d; cursor:pointer;">(é€ƒè·‘)</button>
            </div>
        </div>

        <div class="tabs" v-if="!battle.active">
            <button class="tab-btn" :class="{active: tab=='wild'}" @click="tab='wild'">ğŸŒ² é‡å¤–</button>
            <button class="tab-btn" :class="{active: tab=='arena'}" @click="tab='arena'">ğŸŸï¸ ç«¶æŠ€</button>
            <button class="tab-btn" :class="{active: tab=='box'}" @click="tab='box'">ğŸ“¦ ç›’å­</button>
            <button class="tab-btn" :class="{active: tab=='raid'}" @click="tab='raid'">ğŸ”¥ åœ˜é«”æˆ°</button>
            <button class="tab-btn" :class="{active: tab=='quest'}" @click="tab='quest'">ğŸ“œ ä»»å‹™</button>
            <button class="tab-btn" :class="{active: tab=='social'}" @click="tab='social'">ğŸ’¬ ç¤¾äº¤</button>
            <button class="tab-btn" :class="{active: tab=='shop'}" @click="tab='shop'">ğŸ›’ å•†åº—</button>
            <button class="tab-btn" :class="{active: tab=='gamble'}" @click="tab='gamble'">ğŸ° è³­å ´</button>
        </div>

        <div v-if="!battle.active">
            
            <div v-if="tab=='wild'">
                <h3>ğŸŒ² é¸æ“‡æ¢éšªå€åŸŸ</h3>
                <div style="margin-bottom:15px; background:#2c3e50; padding:10px; border-radius:8px;">
                    <label>ç•¶å‰ç­‰ç´šï¼šLv. {{ user.level }}</label>
                    <p style="font-size:0.8em; color:#aaa;">(åªèƒ½é­é‡ Lv.{{ user.level }} çš„ç‰¹å®šé‡æ€ª)</p>
                </div>
                <div class="card-grid">
                    <div v-for="m in wildList" :key="m.name" class="card">
                        <img :src="m.image_url" class="card-img">
                        <div style="margin-top:5px;">
                            <b :style="{color: m.is_powerful?'#e74c3c':'white'}">{{ m.name }}</b><br>
                            <small>Lv.{{ m.level }} | HP:{{m.hp}}</small><br>
                            <button class="btn-small" style="background:#c0392b" @click="startWildBattle(m)">æˆ°é¬¥</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="tab=='arena'">
                <h3>ğŸŸï¸ ç·šä¸Šç©å®¶</h3>
                <div class="card-grid">
                    <div v-for="p in players" :key="p.id" class="card">
                        <img :src="p.pokemon_image" class="card-img">
                        <div style="margin-top:5px;"><b>{{ p.username }}</b> (Lv.{{ p.level }})
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="btn-small" style="background:#c0392b" @click="sendInvite(p)">æ±ºé¬¥</button>
                                <button class="btn-small" style="background:#27ae60" @click="addFriend(p.id)">åŠ å¥½å‹</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="tab=='box'">
                <h3>ğŸ“¦ å¯¶å¯å¤¢ç›’å­</h3>
                <div class="card-grid">
                    <div v-for="p in box" :key="p.uid" class="card" :class="{active: p.uid === user.active_pokemon_uid}" @click="selectedMon=p" style="border:2px solid transparent;" :style="{borderColor: p.uid === user.active_pokemon_uid ? '#f1c40f' : 'transparent'}">
                        <span class="iv-tag">IV: {{ p.iv }}</span>
                        <b>{{ p.name }}</b><div>Lv.{{ p.lv }}</div>
                    </div>
                </div>
                <div v-if="selectedMon" class="card" style="border-color:#f1c40f; margin-top:10px;">
                    <h4>{{ selectedMon.name }}</h4>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-small" style="background:#2ecc71" @click="swapMon(selectedMon.uid)">å‡ºæˆ°</button>
                        <button class="btn-small" style="background:#3498db" @click="useCandy(selectedMon.uid)">ğŸ¬ é¤µç³–</button>
                        <button class="btn-small" style="background:#e74c3c" @click="releaseMon(selectedMon.uid)">ğŸ‘‹ æ”¾ç”Ÿ</button>
                    </div>
                </div>
            </div>

            <div v-if="tab=='raid'">
                <h3>ğŸ”¥ å‚³èªªåœ˜é«”æˆ°</h3>
                <div v-if="raidState.active" class="card" style="border:2px solid #e74c3c; background:#2c0b0e;">
                    <h2>Boss: {{ raidState.boss_name }}</h2>
                    <div class="bar-container" style="height:20px;"><div class="hp-fill" :style="{width: (raidState.hp/raidState.max_hp)*100 + '%'}"></div></div>
                    <p>HP: {{ raidState.hp }} / {{ raidState.max_hp }}</p>
                    <button class="btn-action" @click="joinRaid">åŠ å…¥æˆ°é¬¥ (1000G)</button>
                </div>
                <div v-else class="card">ç›®å‰æ²’æœ‰åœ˜é«”æˆ° (08:00, 18:00, 22:00 é–‹æ”¾)</div>
            </div>

            <div v-if="tab=='quest'">
                <h3>ğŸ“œ å†’éšªä»»å‹™ (3/3)</h3>
                <div v-for="q in quests" :key="q.id" class="card quest-card" :class="{'quest-active': q.status=='ACTIVE', 'quest-completed': q.status=='COMPLETED', 'quest-golden': q.type=='GOLDEN'}">
                    <h4>{{ q.type=='GOLDEN' ? 'âœ¨ é»ƒé‡‘ä»»å‹™' : 'âš”ï¸ ç‹©çµä»»å‹™' }}: æ“Šæ•— {{ q.target_display || q.target }} x{{ q.req }}</h4>
                    <p>é€²åº¦: {{ q.now }} / {{ q.req }}</p>
                    <p v-if="q.type=='GOLDEN'">çå‹µ: ğŸ¬ é»ƒé‡‘ç³–æœ x1</p>
                    <p v-else>çå‹µ: {{ q.gold }}G, {{ q.xp }} XP</p>
                    <button v-if="q.status=='WAITING'" class="btn-action" style="background:#3498db" @click="acceptQuest(q.id)">æ¥å—</button>
                    <button v-if="q.status=='ACTIVE'" class="btn-action" style="background:#e74c3c" @click="abandonQuest(q.id)">æ”¾æ£„ (-1000G)</button>
                    <button v-if="q.status=='COMPLETED'" class="btn-action" style="background:#2ecc71" @click="claimQuest(q.id)">é ˜å–çå‹µ</button>
                </div>
            </div>

            <div v-if="tab=='shop'">
                <h3>ğŸ›’ æ‰­è›‹å•†åº— <button style="font-size:0.6em; background:#555; border:none; color:white; padding:3px;" @click="showRates=true">ğŸ“Š æ©Ÿç‡</button></h3>
                <button class="btn-action" @click="playGacha('normal')">ğŸ”® åˆç´š (1500G)</button>
                <button class="btn-action" style="background:linear-gradient(45deg, #3498db, #2980b9)" @click="playGacha('medium')">ğŸ”µ ä¸­ç´š (3000G)</button>
                <button class="btn-action" style="background:linear-gradient(45deg, #8e44ad, #9b59b6)" @click="playGacha('high')">ğŸŸ£ é«˜ç´š (10000G)</button>
                <button class="btn-action" style="background:linear-gradient(45deg, #f1c40f, #d35400)" @click="playGacha('golden')">âœ¨ é»ƒé‡‘ (3 Golden)</button>
                <br><br>
                <button class="btn-action" style="background:#27ae60" @click="buyHeal">ğŸ’Š è£œè¡€ (50G)</button>
            </div>

            <div v-if="tab=='gamble'">
                <div class="card" style="text-align:center; border:2px solid #f39c12;">
                    <h3>ğŸ° å¹¸é‹è³­å ´</h3>
                    <input type="number" v-model.number="gambleAmount" placeholder="è¼¸å…¥é‡‘é¡" style="padding:10px; width:100px; border-radius:5px; border:none;">
                    <button class="btn-action" style="margin-top:10px; background:#f39c12; color:black;" @click="doGamble">ä¸‹æ³¨ï¼</button>
                </div>
            </div>

            <div v-if="tab=='social'">
                <h3>ğŸ’¬ å¥½å‹èˆ‡ç®¡ç†</h3>
                <div v-if="friends.length > 0">
                    <h4>æˆ‘çš„å¥½å‹</h4>
                    <div class="card-grid">
                        <div v-for="f in friends" :key="f.id" class="card">
                            <b>{{ f.username }}</b>
                            <button class="btn-small" style="width:100%; margin-top:5px; background:#f39c12" v-if="f.can_gift" @click="sendGift(f.id)">ğŸ é€ç¦®</button>
                        </div>
                    </div>
                </div>
                <div v-else class="card">æš«ç„¡å¥½å‹</div>
                <div class="card" style="margin-top:10px;">
                    <h4>ğŸ å…Œæ›ç¢¼</h4>
                    <input v-model="promoCode" placeholder="è¼¸å…¥åºè™Ÿ" style="padding:5px; width:70%;">
                    <button @click="redeemCode" style="padding:5px;">å…Œæ›</button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showRates" class="modal-overlay" @click.self="showRates=false">
        <div class="modal-box" style="width: 400px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-title">ğŸ“Š æ‰­è›‹æ©Ÿç‡è¡¨</div>
            <div v-for="(pool, name) in gachaRates" :key="name" style="margin-bottom: 15px;">
                <h4 style="color: #f1c40f; border-bottom: 1px solid #555;">{{ name }}</h4>
                <table class="rate-table">
                    <tr v-for="item in pool" :key="item.name"><td>{{ item.name }}</td><td style="text-align: right;">{{ item.rate }}%</td></tr>
                </table>
            </div>
            <button class="btn-yes" style="width: 100%; margin-top: 10px;" @click="showRates=false">é—œé–‰</button>
        </div>
    </div>

    <div v-if="user" class="chat-panel">
        <div class="chat-msgs" id="chat-box">
            <div v-for="m in chatMsgs" style="margin-bottom:2px;">{{ m }}</div>
        </div>
        <div class="chat-input-area">
            <input v-model="chatInput" class="chat-input" placeholder="èªªé»ä»€éº¼..." @keyup.enter="sendChat">
            <button @click="sendChat" style="padding:0 15px; border-radius:5px; border:none;">é€å‡º</button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, onMounted, computed, watch } = Vue;
    const API_URL = `https://mwtpokemons.zeabur.app/api/v1`;
    const WS_URL = `wss://mwtpokemons.zeabur.app/ws`;

    createApp({
        setup() {
            const user = ref(null);
            const token = localStorage.getItem('token');
            const tab = ref('wild'); 
            const box = computed(() => user.value ? JSON.parse(user.value.pokemon_storage) : []);
            const newsState = ref({ show: false });
            const closeNews = () => { newsState.value.show = false; sessionStorage.setItem('seenNews_v32', 'true'); };
            const quests = ref([]);
            const players = ref([]);
            const friends = ref([]);
            const selectedMon = ref(null);
            
            const skillData = ref({});
            const mySkills = ref(["æ’æ“Š", "æ’æ“Š", "æ’æ“Š"]);
            const shieldUses = ref(2);
            
            const currentPetIV = computed(() => {
                if(!user.value) return 0;
                const p = box.value.find(x => x.uid === user.value.active_pokemon_uid);
                return p ? p.iv : 50;
            });
            const playerXpPercent = computed(() => user.value ? Math.min(100, (user.value.exp / (user.value.next_level_exp || 9999)) * 100) : 0);
            const hpPercent = (u) => (u.hp / u.max_hp) * 100;
            const petXpPercent = (u) => Math.min(100, (u.pet_exp / (u.next_pet_level_exp || 9999)) * 100);
            const currentAtkMe = computed(() => user.value ? user.value.attack : 0);

            const battle = ref({ active: false, mode: 'wild', target: null, shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false });
            const raidState = ref({ active: false, hp: 0, max_hp: 0, boss_name: '' });
            const inLobby = ref(false);
            const lobbyTimer = ref(15);
            let lobbyInterval = null;

            const chatMsgs = ref([]);
            const chatInput = ref("");
            const gambleAmount = ref(100);
            const promoCode = ref("");
            const wildList = ref([]);
            const showRates = ref(false);
            const gachaRates = {
                "ğŸŸ£ é«˜ç´šæ‰­è›‹ (10000G)": [{name: "å¡æ¯”ç¸", rate: 20}, {name: "å‰åˆ©è›‹", rate: 24}, {name: "å¹¸ç¦è›‹/æ‹‰æ™®æ‹‰æ–¯/å¦™è›™/å™´ç«/æ°´ç®­", rate: 10}, {name: "å¿«é¾", rate: 6}],
                "âœ¨ é»ƒé‡‘æ‰­è›‹ (3 Golden)": [{name: "å¡æ¯”ç¸", rate: 30}, {name: "å‰åˆ©è›‹", rate: 35}, {name: "å¹¸ç¦è›‹", rate: 20}, {name: "æ‹‰æ™®æ‹‰æ–¯", rate: 10}, {name: "å¿«é¾", rate: 5}]
            };

            const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };

            const updateInfo = async () => {
                try {
                    const res = await fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if(res.ok) user.value = await res.json(); else window.location.href = 'login.html';
                } catch(e) {}
            };

            const fetchPlayers = async () => { const res = await fetch(`${API_URL}/auth/all`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) players.value = await res.json(); };
            const fetchFriends = async () => { const res = await fetch(`${API_URL}/social/list`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) friends.value = await res.json(); };
            const fetchQuests = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/quests/`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) quests.value = await res.json(); updateInfo(); };
            const checkRaid = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/status`); if(res.ok) raidState.value = await res.json(); };
            const initAdmin = async () => { try { const res = await fetch(`${API_URL}/social/admin/init`); const d = await res.json(); alert(d.message); } catch(e) {} };
            const fetchWildList = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/wild/list?level=${user.value.level}`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) wildList.value = await res.json(); };
            const fetchSkillData = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/data/skills`); if(res.ok) skillData.value = await res.json(); };

            const updateMySkills = () => {
                if(!user.value || !box.value) return;
                const active = box.value.find(p => p.uid === user.value.active_pokemon_uid);
                if(active) {
                    // é€™è£¡æš«æ™‚ç”¨ç¡¬ç·¨ç¢¼å°æ‡‰ï¼Œæ­£å¼ç‰ˆå¾Œç«¯æœƒå›å‚³ skills
                    const skillMap = {
                        "å°æ‹‰é”": ["æŠ“", "å‡ºå¥‡ä¸€æ“Š", "æ’æ“Š"], "æ³¢æ³¢": ["æŠ“", "å•„", "ç‡•è¿”"], 
                        "å¦™è›™ç¨®å­": ["è—¤é­", "ç¨®å­ç‚¸å½ˆ", "æ±¡æ³¥ç‚¸å½ˆ"], "å°ç«é¾": ["ç«èŠ±", "å™´å°„ç«ç„°", "å¤§å­—çˆ†ç‚"], "å‚‘å°¼é¾œ": ["æ°´æ§", "æ°´æµå™´å°„", "æ°´æµå°¾"],
                        "å¡æ¯”ç¸": ["æ³°å±±å£“é ‚", "åœ°éœ‡", "æ’æ“Š"], "çš®å¡ä¸˜": ["é›»å…‰", "æ”¾é›»", "é›»æ“Š"], "å¿«é¾": ["æŠ“", "é€†é±—", "å‹‡é³¥çŒ›æ”»"]
                    };
                    mySkills.value = skillMap[active.name] || ["æ’æ“Š", "æ’æ“Š", "æ’æ“Š"];
                }
            };

            onMounted(async () => {
                document.getElementById('loading').style.display = 'none'; 
                if(!token) return window.location.href = 'login.html';
                if (!sessionStorage.getItem('seenNews_v32')) newsState.value.show = true;
                await updateInfo(); await fetchSkillData(); updateMySkills();
                fetchPlayers(); checkRaid(); setInterval(checkRaid, 5000); fetchQuests(); fetchWildList();
                const ws = new WebSocket(`${WS_URL}?token=${token}`);
                ws.onmessage = (e) => {
                    const msg = e.data;
                    if(msg.startsWith("CHAT|")) { chatMsgs.value.push(msg.split("|")[1]); setTimeout(() => { const b = document.getElementById('chat-box'); if(b) b.scrollTop = b.scrollHeight; }, 100); }
                    if(msg.startsWith("EVENT:DUEL_INVITE")) { const parts = msg.split("|"); if(parseInt(parts[3]) === user.value.id) { if(confirm(`${parts[2]} é‚€è«‹ä½ æ±ºé¬¥ï¼æ¥å—å—ï¼Ÿ`)) acceptDuel(parts[1]); } }
                    if(msg.startsWith("EVENT:PVP_SWAP") || msg.startsWith("EVENT:PVP_MOVE")) updateInfo();
                };
            });
            
            watch(tab, (n) => { if(n==='arena') fetchPlayers(); if(n==='social') fetchFriends(); if(n==='quest') fetchQuests(); if(n==='wild') fetchWildList(); });
            watch(user, () => updateMySkills());

            const startWildBattle = (target) => {
                shieldUses.value = 2; updateMySkills();
                battle.value = { active: true, mode: 'wild', target: JSON.parse(JSON.stringify(target)), shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false };
            };

            const getSkillDesc = (name) => {
                const s = skillData.value[name];
                return s ? `${s.dmg}å‚· ${s.desc || ''}` : '';
            };

            const doSkillAttack = async (skillName) => {
                if(!skillData.value[skillName]) return;
                const skill = skillData.value[skillName];
                const baseDmg = skill.dmg;
                
                // å‚·å®³å…¬å¼: (ATK * (Dmg/20)) * Buff
                let dmg = Math.floor((user.value.attack * baseDmg / 20) * battle.value.atkBuff);
                
                // ç‰¹æ•ˆè™•ç†
                let effectMsg = "";
                if(skill.effect && Math.random() < skill.prob) {
                    if(skill.effect === "heal") {
                        const healAmt = Math.floor(user.value.max_hp * skill.val);
                        user.value.hp = Math.min(user.value.max_hp, user.value.hp + healAmt);
                        effectMsg = `ä¸¦å›å¾©äº† ${healAmt} HP!`;
                    } else if(skill.effect === "buff_atk") {
                        battle.value.atkBuff = 1 + skill.val;
                        effectMsg = `æ”»æ“ŠåŠ›æå‡äº†!`;
                    } else if(skill.effect === "recoil") {
                        const recoil = Math.floor(user.value.max_hp * skill.val);
                        user.value.hp -= recoil;
                        effectMsg = `ä½†å—åˆ° ${recoil} åå‚·!`;
                    }
                }

                if(battle.value.mode === 'wild') {
                    battle.value.target.hp -= dmg;
                    battle.value.shakeTarget = true; setTimeout(()=>battle.value.shakeTarget=false, 500);
                    
                    if(battle.value.target.hp <= 0) {
                        const res = await fetch(`${API_URL.replace('/items','')}/shop/wild/attack?is_win=true&is_powerful=${battle.value.target.is_powerful||false}&target_name=${battle.value.target.raw_name}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                        const d = await res.json(); alert(`é€ æˆ ${dmg} å‚·å®³${effectMsg}\n${d.message}`);
                        battle.value.active = false; updateInfo(); fetchQuests();
                    } else {
                        // é‡æ€ªåæ“Š
                        setTimeout(() => {
                            if(battle.value.shieldActive) {
                                // è§¸ç™¼é˜²è­·ç›¾
                                const enemySkill = battle.value.target.skills[Math.floor(Math.random()*3)];
                                const enemyBaseDmg = (skillData.value[enemySkill] || {dmg:20}).dmg;
                                const enemyDmg = Math.floor((battle.value.target.attack * enemyBaseDmg / 20));
                                const reflect = Math.floor(enemyDmg * 0.2);
                                battle.value.target.hp -= reflect;
                                alert(`ğŸ›¡ï¸ æ“‹ä¸‹ ${enemyDmg} å‚·å®³ï¼Œåå½ˆ ${reflect}ï¼`);
                                battle.value.shieldActive = false; // æ¶ˆè€—ç›¾
                                if(battle.value.target.hp <= 0) {
                                     fetch(`${API_URL.replace('/items','')}/shop/wild/attack?is_win=true&is_powerful=${battle.value.target.is_powerful||false}&target_name=${battle.value.target.raw_name}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } })
                                     .then(r=>r.json()).then(d=>{ alert(d.message); battle.value.active = false; updateInfo(); fetchQuests(); });
                                }
                            } else {
                                const enemySkill = battle.value.target.skills[Math.floor(Math.random()*3)];
                                const enemyBaseDmg = (skillData.value[enemySkill] || {dmg:20}).dmg;
                                const enemyDmg = Math.floor((battle.value.target.attack * enemyBaseDmg / 20));
                                user.value.hp -= enemyDmg;
                                battle.value.shakeMe = true; setTimeout(()=>battle.value.shakeMe=false, 500);
                                if(user.value.hp <= 0) { alert("ä½ è¢«æ‰“æ•—äº†..."); battle.value.active = false; buyHeal(); }
                            }
                        }, 500);
                    }
                }
            };
            
            const useShield = () => {
                if(shieldUses.value <= 0) return;
                shieldUses.value--;
                battle.value.shieldActive = true;
                // è§¸ç™¼é‡æ€ªæ”»æ“Š (ä½†ä¸æ‰£è¡€)
                doSkillAttack('wait'); // wait æ˜¯ä¸€å€‹ä¸å­˜åœ¨çš„æŠ€èƒ½ï¼Œä¸æœƒé€ æˆå‚·å®³ï¼Œåªè§¸ç™¼é‡æ€ªå›åˆ
            };
            
            const doHeal = async () => { const heal = Math.floor(user.value.max_hp * 0.2); user.value.hp = Math.min(user.value.max_hp, user.value.hp + heal); alert(`å›å¾©äº† ${heal} HP`); };
            const dailyCheckin = async () => { const res = await fetch(`${API_URL}/social/daily_checkin`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const playGacha = async (type) => { const res = await fetch(`${API_URL.replace('/items','')}/shop/gacha/${type}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const swapMon = async (uid) => { await fetch(`${API_URL.replace('/items','')}/shop/box/swap/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); updateInfo(); };
            const releaseMon = async (uid) => { if(!confirm("ç¢ºå®šæ”¾ç”Ÿï¼Ÿ")) return; await fetch(`${API_URL.replace('/items','')}/shop/box/action/release/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); selectedMon.value = null; updateInfo(); };
            const useCandy = async (uid) => { const res = await fetch(`${API_URL.replace('/items','')}/shop/box/action/candy/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const doGamble = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/gamble?amount=${gambleAmount.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const sendChat = async () => { if(!chatInput.value) return; await fetch(`${API_URL}/social/chat/send?content=${chatInput.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); chatInput.value = ""; };
            const buyHeal = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/heal`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { alert("è£œè¡€æˆåŠŸ"); updateInfo(); } else alert("é‡‘å¹£ä¸è¶³"); };
            const redeemCode = async () => { const res = await fetch(`${API_URL}/social/redeem?code=${promoCode.value}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message || d.detail); updateInfo(); };
            const sendInvite = async (p) => { await fetch(`${API_URL.replace('/items','')}/shop/duel/invite/${p.id}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); alert("å·²é‚€è«‹"); };
            const acceptDuel = async (targetId) => { await fetch(`${API_URL.replace('/items','')}/shop/duel/accept/${targetId}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); };
            const addFriend = async (uid) => { const res = await fetch(`${API_URL}/social/add/${uid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message); };
            const sendGift = async (fid) => { const res = await fetch(`${API_URL}/social/gift/send/${fid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { alert("ç¦®ç‰©å·²ç™¼é€ï¼"); fetchFriends(); } else { const d = await res.json(); alert(d.detail); } };
            const joinRaid = async () => { if(confirm("æ”¯ä»˜ 1000G åŠ å…¥ï¼Ÿ")) { const res = await fetch(`${API_URL.replace('/items','')}/shop/raid/join`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { battle.value = { active: true, mode: 'raid', target: { name: raidState.value.boss_name, hp: raidState.value.hp, max_hp: raidState.value.max_hp, image_url: '' }, shakeMe: false, shakeTarget: false }; } else { const d = await res.json(); alert(d.detail); } } };
            const acceptQuest = async (qid) => { await fetch(`${API_URL.replace('/items','')}/shop/quests/accept/${qid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); fetchQuests(); };
            const abandonQuest = async (qid) => { if(confirm("æ”¾æ£„éœ€æ¶ˆè€— 1000Gï¼Œç¢ºå®šå—ï¼Ÿ")) { await fetch(`${API_URL.replace('/items','')}/shop/quests/abandon/${qid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); fetchQuests(); } };
            const claimQuest = async (qid) => { const res = await fetch(`${API_URL.replace('/items','')}/shop/quests/claim/${qid}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } }); const d = await res.json(); alert(d.message); fetchQuests(); };

            return { user, tab, box, players, friends, selectedMon, currentPetIV, battle, raidState, inLobby, lobbyTimer, dailyCheckin, logout, playGacha, swapMon, releaseMon, useCandy, gambleAmount, doGamble, chatMsgs, chatInput, sendChat, doSkillAttack, useShield, doHeal, buyHeal, promoCode, redeemCode, initAdmin, sendInvite, addFriend, sendGift, joinRaid, playerXpPercent, hpPercent, petXpPercent, currentAtkMe, quests, acceptQuest, abandonQuest, claimQuest, wildList, fetchWildList, startWildBattle, showRates, gachaRates, newsState, closeNews, mySkills, shieldUses, getSkillDesc };
        }
    }).mount('#app');
</script>
</body>
</html>