<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ï¸ å¯¶å¯å¤¢å¤§äº‚é¬¥ (Vueç‰ˆ) âš¡ï¸</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <style>
        /* --- æ¨£å¼å€ (ä¿æŒåŸæœ¬çš„å¸¥æ°£é¢¨æ ¼) --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; color: #fff; padding: 20px; margin: 0; overflow-x: hidden; }
        .container { max-width: 900px; margin: 0 auto; padding-top: 20px; position: relative; }
        
        /* Navbar */
        .navbar { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; background: #16213e; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #0f3460; gap: 10px; }
        .user-info { display: flex; align-items: center; gap: 15px; width: 100%; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #f1c40f; object-fit: cover; }
        .user-stats { flex: 1; }
        .user-name { font-weight: bold; color: #4cc9f0; font-size: 1.1em; }
        .money-badge { color: #f1c40f; background: rgba(241, 196, 15, 0.1); padding: 2px 8px; border-radius: 10px; border: 1px solid #f1c40f; font-size: 0.9em; margin-left: 10px; }
        .player-hp-box { width: 100%; background: #333; height: 10px; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .player-hp-fill { height: 100%; transition: width 0.3s; }
        
        .btn-logout { background: transparent; border: 1px solid #e74c3c; color: #e74c3c; padding: 5px 15px; border-radius: 5px; cursor: pointer; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; background: #0f3460; border: none; color: #aaa; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: #e94560; color: white; transform: translateY(-3px); }

        /* Game Area */
        .game-area { display: flex; gap: 20px; align-items: flex-start; }
        .card-grid { flex: 2; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .battle-log-panel { flex: 1; background: #16213e; border: 2px solid #0f3460; border-radius: 10px; height: 500px; padding: 10px; overflow-y: auto; position: sticky; top: 20px; }
        .log-entry { font-size: 0.9em; border-bottom: 1px solid #333; padding: 4px 0; }

        /* Card */
        .card { background: #0f3460; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.5); position: relative; transition: 0.2s; }
        .card:hover { transform: translateY(-5px); border: 1px solid #e94560; }
        .card.dead { filter: grayscale(100%); opacity: 0.6; pointer-events: none; }
        .card-img { width: 100%; height: 150px; object-fit: cover; background: #fff; }
        .card-body { padding: 10px; }
        .hp-bar-bg { background: #333; height: 8px; border-radius: 4px; margin: 8px 0; overflow: hidden; }
        .hp-bar-fill { height: 100%; transition: width 0.3s; }
        
        .btn-attack { width: 100%; background: #c0392b; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
        .btn-heal { background: #27ae60; }
        .btn-pvp { background: #8e44ad; }
        .btn-disabled { background: #555 !important; cursor: not-allowed; }

        /* Gacha */
        .gacha-box { text-align: center; padding: 40px; background: #16213e; border-radius: 15px; border: 2px dashed #f1c40f; }
        .gacha-btn { background: linear-gradient(45deg, #f1c40f, #d35400); color: white; border: none; padding: 15px 40px; font-size: 1.5em; border-radius: 50px; cursor: pointer; box-shadow: 0 0 20px rgba(241, 196, 15, 0.5); }

        /* Floating Damage */
        .floating-damage { position: absolute; color: #ffeb3b; font-weight: bold; font-size: 24px; pointer-events: none; animation: floatUp 0.8s ease-out forwards; text-shadow: 2px 2px 0 #000; z-index: 100; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-60px) scale(1); opacity: 0; } }
        
        /* RWD */
        @media (max-width: 768px) { .game-area { flex-direction: column-reverse; } }
    </style>
</head>
<body>

<div id="app" class="container">
    
    <div class="navbar" v-if="user">
        <div class="user-section">
            <img :src="user.pokemon_image || 'https://via.placeholder.com/50'" class="user-avatar">
            <div class="user-stats">
                <div class="user-name">
                    {{ user.username }} (Lv.{{ user.level }}) 
                    <span class="money-badge">ğŸ’° {{ user.money }}</span>
                </div>
                <div class="player-hp-box">
                    <div class="player-hp-fill" :style="{ width: hpPercent(user) + '%', background: hpColor(user) }"></div>
                </div>
                <div style="font-size:0.8em; color:#ccc">HP: {{ user.hp }}/{{ user.max_hp }} | ATK: {{ user.attack }}</div>
            </div>
        </div>
        <button class="btn-logout" @click="logout">ç™»å‡º</button>
    </div>

    <h1 style="text-align: center; color: #e94560;">âš”ï¸ å¦™è›™å®¸çš„ç†±è¡€æˆ°å ´ (Vueç‰ˆ) âš”ï¸</h1>

    <div class="tabs">
        <button class="tab-btn" :class="{ active: currentTab === 'wild' }" @click="currentTab = 'wild'">ğŸŒ² é‡å¤–æ¢éšª</button>
        <button class="tab-btn" :class="{ active: currentTab === 'arena' }" @click="currentTab = 'arena'">ğŸŸï¸ ç©å®¶ç«¶æŠ€å ´</button>
        <button class="tab-btn" :class="{ active: currentTab === 'shop' }" @click="currentTab = 'shop'">ğŸ›’ å•†åº— & æ‰­è›‹</button>
    </div>

    <div class="game-area">
        
        <div v-if="currentTab === 'wild'" class="card-grid">
            <div v-if="monsters.length === 0" style="text-align:center; width:100%; color:#888;">æ²’æœ‰æ€ªç¸...</div>
            <div v-for="m in monsters" :key="m.id" class="card" :class="{ dead: m.hp <= 0 }" :id="'card-monster-' + m.id">
                <img :src="m.image_url" class="card-img">
                <div class="card-body">
                    <div><b>{{ m.name }}</b> <small style="float:right">ATK: {{ m.attack }}</small></div>
                    <div class="hp-bar-bg"><div class="hp-bar-fill" :style="{ width: hpPercent(m) + '%', background: hpColor(m) }"></div></div>
                    <small>{{ m.hp }} / {{ m.max_hp }}</small>
                    <button class="btn-attack" @click="attackMonster(m)">âš”ï¸ è¨ä¼</button>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'arena'" class="card-grid">
            <div v-if="players.length === 0" style="text-align:center; width:100%; color:#888;">æ²’æœ‰å…¶ä»–ç©å®¶...</div>
            <div v-for="p in players" :key="p.id" class="card" :class="{ dead: p.hp <= 0 }" :id="'card-player-' + p.id">
                <img :src="p.pokemon_image" class="card-img">
                <div class="card-body">
                    <div>
                        <b>{{ p.username }}</b> 
                        <span v-if="p.is_online" style="color:#2ecc71; font-size:0.8em;">â— ç·šä¸Š</span>
                        <span v-else style="color:#95a5a6; font-size:0.8em;">â— é›¢ç·š</span>
                    </div>
                    <div class="hp-bar-bg"><div class="hp-bar-fill" :style="{ width: hpPercent(p) + '%', background: hpColor(p) }"></div></div>
                    <small>{{ p.hp }} / {{ p.max_hp }}</small>
                    
                    <button v-if="p.is_online" class="btn-attack btn-pvp" @click="attackPlayer(p)">ğŸ¥Š æ±ºé¬¥</button>
                    <button v-else class="btn-attack btn-disabled" disabled>ğŸ’¤ ä¼‘æ¯ä¸­</button>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'shop'" style="width: 100%;">
            <div class="gacha-box">
                <h2 style="color:#f1c40f;">ğŸŒŸ å‚³èªªæ‰­è›‹æ©Ÿ ğŸŒŸ</h2>
                <p>æ¶ˆè€— 200 Gï¼Œéš¨æ©Ÿç²å¾—å¼·åŠ›å¯¶å¯å¤¢ï¼</p>
                <button class="gacha-btn" @click="playGacha">ğŸ”® å¬å–š (200G)</button>
                <br><br>
                <button class="btn-attack btn-heal" style="width:auto; padding:10px 30px;" @click="buyHeal">ğŸ’Š é†«é™¢è£œè¡€ (50G)</button>
            </div>
        </div>

        <div class="battle-log-panel">
            <h3 class="log-title">ğŸ“œ æˆ°é¬¥ç´€éŒ„</h3>
            <div v-for="(log, index) in logs" :key="index" class="log-entry" v-html="log"></div>
        </div>
    </div>

</div>

<script>
    // --------------------------------------------------------
    // âš ï¸ è¨­å®šå€ï¼šè«‹å°‡é€™è£¡æ”¹æˆä½ çš„ Zeabur ç¶²å€
    const ZEABUR_DOMAIN = 'mwtpokemons.zeabur.app'; 
    // --------------------------------------------------------

    const API_URL = `https://${ZEABUR_DOMAIN}/api/v1`;
    const WS_URL = `wss://${ZEABUR_DOMAIN}/ws`;

    // --- Vue 3 æ‡‰ç”¨ç¨‹å¼ ---
    const { createApp, ref, onMounted, watch } = Vue;

    createApp({
        setup() {
            const user = ref(null);
            const token = localStorage.getItem('token');
            const monsters = ref([]);
            const players = ref([]);
            const logs = ref([]);
            const currentTab = ref('wild');
            let socket = null;

            // æª¢æŸ¥ç™»å…¥
            if (!token) {
                window.location.href = 'login.html';
            }

            // åˆå§‹åŒ–
            onMounted(async () => {
                await updateUserInfo();
                await fetchMonsters();
                await fetchPlayers(); // ä¸€é€²ä¾†å…ˆæŠ“ä¸€æ¬¡ç©å®¶
                connectWebSocket();
            });

            // 1. å–å¾—è‡ªå·±è³‡æ–™
            const updateUserInfo = async () => {
                try {
                    const res = await fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (res.ok) user.value = await res.json();
                } catch (e) { console.error(e); }
            };

            // 2. å–å¾—æ€ªç¸åˆ—è¡¨
            const fetchMonsters = async () => {
                try {
                    const res = await fetch(`${API_URL}/items/`);
                    const data = await res.json();
                    monsters.value = data.sort((a, b) => a.id - b.id);
                } catch (e) { console.error(e); }
            };

            // 3. å–å¾—ç©å®¶åˆ—è¡¨ (å«åœ¨ç·šç‹€æ…‹)
            const fetchPlayers = async () => {
                try {
                    const res = await fetch(`${API_URL}/auth/all`);
                    const data = await res.json();
                    // éæ¿¾æ‰è‡ªå·±ï¼Œä¸¦ä¾ç‹€æ…‹æ’åº
                    players.value = data.filter(u => u.id !== user.value?.id).sort((a, b) => b.is_online - a.is_online);
                } catch (e) { console.error(e); }
            };

            // 4. WebSocket é€£ç·š
            const connectWebSocket = () => {
                socket = new WebSocket(`${WS_URL}?token=${token}`);
                
                socket.onopen = () => {
                    addLog("âœ… å·²é€£ç·šåˆ°å³æ™‚æˆ°å ´ï¼");
                    setInterval(() => { if(socket.readyState === 1) socket.send("ping"); }, 30000);
                };

                // ğŸ”¥ ä¿®æ­£é‡é»ï¼šæ”¶åˆ°å»£æ’­ï¼Œå…¨éƒ¨åˆ·æ–°ï¼ ğŸ”¥
                socket.onmessage = (event) => {
                    addLog(`<span style="color: #4cc9f0;">ğŸ“¡ ${event.data}</span>`);
                    fetchMonsters();  // åˆ·æ–°æ€ªç¸
                    fetchPlayers();   // åˆ·æ–°ç©å®¶ç‹€æ…‹ (è§£æ±ºé›¢ç·šé¡¯ç¤ºå•é¡Œ)
                    updateUserInfo(); // åˆ·æ–°è‡ªå·±
                };

                socket.onclose = () => {
                    addLog(`<span style="color: red;">âŒ é€£ç·šæ–·é–‹ï¼Œå˜—è©¦é‡é€£...</span>`);
                    setTimeout(connectWebSocket, 3000);
                };
            };

            // 5. æˆ°é¬¥é‚è¼¯
            const attackMonster = async (monster) => {
                if(monster.hp <= 0) return;
                
                // è¨ˆç®—é è¦½å‚·å®³
                const isCrit = Math.random() < 0.3;
                const bonus = Math.floor(Math.random() * user.value.attack);
                const dmg = isCrit ? (user.value.attack + bonus) * 2 : (user.value.attack + bonus);
                
                showFloatingDamage(`card-monster-${monster.id}`, dmg, isCrit);
                
                // é å…ˆæ›´æ–° UI (è®“æ‰‹æ„Ÿæ›´å¥½)
                monster.hp = Math.max(0, monster.hp - dmg);

                const res = await fetch(`${API_URL}/items/${monster.id}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hp: monster.hp })
                });
            };

            const attackPlayer = async (target) => {
                showFloatingDamage(`card-player-${target.id}`, "PVP", true);
                const res = await fetch(`${API_URL}/shop/pvp/${target.id}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(!res.ok) {
                    const err = await res.json();
                    alert(err.detail);
                }
            };

            const playGacha = async () => {
                const res = await fetch(`${API_URL}/shop/gacha`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if(res.ok) {
                    alert(`ğŸ‰ ${data.message}`);
                    updateUserInfo();
                } else {
                    alert(data.detail);
                }
            };

            const buyHeal = async () => {
                const res = await fetch(`${API_URL}/shop/heal`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) {
                    alert("è£œè¡€æˆåŠŸï¼");
                    updateUserInfo();
                } else {
                    alert("é‡‘å¹£ä¸è¶³");
                }
            };

            // å·¥å…·å‡½å¼
            const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };
            
            const addLog = (msg) => {
                logs.value.unshift(msg);
                if(logs.value.length > 50) logs.value.pop();
            };

            const hpPercent = (u) => Math.max(0, (u.hp / u.max_hp) * 100);
            const hpColor = (u) => {
                const p = hpPercent(u);
                return p < 30 ? '#e74c3c' : (p < 60 ? '#f1c40f' : '#2ecc71');
            };

            const showFloatingDamage = (elementId, value, isCrit) => {
                const card = document.getElementById(elementId);
                if (!card) return;
                const rect = card.getBoundingClientRect();
                const el = document.createElement('div');
                el.className = 'floating-damage';
                el.innerText = isCrit ? `ğŸ’¥ ${value}` : `-${value}`;
                el.style.left = `${rect.left + rect.width/2}px`;
                el.style.top = `${rect.top}px`;
                if(isCrit) { el.style.fontSize='36px'; el.style.color='#e74c3c'; }
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 800);
            };

            // ç›£è½ Tab åˆ‡æ› (ç¢ºä¿åˆ‡æ›æ™‚è³‡æ–™ä¹Ÿæ˜¯æ–°çš„)
            watch(currentTab, (newTab) => {
                if(newTab === 'wild') fetchMonsters();
                if(newTab === 'arena') fetchPlayers();
            });

            return {
                user, monsters, players, logs, currentTab,
                hpPercent, hpColor, logout, attackMonster, attackPlayer, playGacha, buyHeal
            };
        }
    }).mount('#app');
</script>

</body>
</html>