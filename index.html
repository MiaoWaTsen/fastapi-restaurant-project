<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ï¸ å¯¶å¯å¤¢å¤§äº‚é¬¥ V2.15.11 âš¡ï¸</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        [v-cloak] { display: none; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a2e; color: #fff; padding: 20px; padding-bottom: 120px; user-select: none; }
        .container { max-width: 900px; margin: 0 auto; position: relative; }
        .navbar { display: flex; justify-content: space-between; align-items: center; background: #16213e; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #0f3460; }
        .user-info { display: flex; gap: 15px; width: 100%; }
        .user-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #f1c40f; object-fit: cover; background: #000; }
        .user-stats { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .stat-block { background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 5px; }
        .stat-title { font-size: 0.9em; color: #aaa; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .bar-container { width: 100%; background: #333; height: 8px; border-radius: 4px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .hp-fill { background: linear-gradient(90deg, #e74c3c, #c0392b); } 
        .pet-xp-fill { background: linear-gradient(90deg, #3498db, #2980b9); } 
        .player-xp-fill { background: linear-gradient(90deg, #f1c40f, #d35400); }
        .bar-text { font-size: 0.75em; color: #ccc; display: flex; justify-content: space-between; margin-top: 1px; }
        .atk-val { color: #f1c40f; font-weight: bold; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px; background: #0f3460; border: none; color: #aaa; cursor: pointer; border-radius: 8px; font-weight: bold; min-width: 80px; transition:0.2s; display:flex; flex-direction:column; align-items:center; justify-content: center; }
        .tab-btn.active { background: #e94560; color: white; transform: translateY(-3px); }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .card { background: #0f3460; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; border: 1px solid transparent; transition:0.2s; position: relative; }
        .card:hover { border-color: #f1c40f; transform: translateY(-5px); }
        .card-img { width: 100%; height: 120px; object-fit: contain; background: #222; border-radius: 5px; }
        .btn-action { width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #c0392b; color: white; }
        .btn-small { width: 48%; padding: 5px; font-size: 0.9em; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; color: white; }
        .btn-disabled { background: #555 !important; cursor: not-allowed; opacity: 0.6; pointer-events: none; }
        .btn-logout { background: #95a5a6; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; color: white; font-size: 0.8em; }
        
        .gacha-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .btn-gacha { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; border-radius: 12px; border: none; cursor: pointer; color: white; font-weight: bold; min-height: 100px; transition: transform 0.2s; position: relative; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn-gacha:active { transform: scale(0.95); }
        .btn-gacha span:first-child { font-size: 1.1em; margin-bottom: 5px; }
        .btn-gacha span:last-child { font-size: 0.85em; opacity: 0.9; background: rgba(0,0,0,0.2); padding: 3px 8px; border-radius: 10px; }
        .g-normal { background: linear-gradient(135deg, #3498db, #2980b9); }
        .g-medium { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .g-high { background: linear-gradient(135deg, #e67e22, #d35400); }
        .g-candy { background: linear-gradient(135deg, #e91e63, #c2185b); }
        .g-golden { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #000; text-shadow: none; }
        .g-leg-candy { background: linear-gradient(135deg, #8e44ad, #34495e); border: 1px solid #a569bd; }
        .g-leg-gold { background: linear-gradient(135deg, #f39c12, #d35400); border: 2px solid #f1c40f; box-shadow: 0 0 15px rgba(243, 156, 18, 0.4); }
        
        .item-buy-btn { background: #2c3e50; border: 1px solid #444; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; }
        .item-buy-btn:hover { border-color: #f1c40f; background: #34495e; }
        .item-icon { font-size: 2em; margin-bottom: 5px; }
        .item-price { color: #f1c40f; font-weight: bold; font-size: 0.9em; }

        .gym-card { border: 2px solid #333; position: relative; overflow: hidden; }
        .gym-card.occupied-me { border-color: #f1c40f; box-shadow: 0 0 15px rgba(241, 196, 15, 0.2); }
        .gym-card.protected { border-color: #3498db; }
        .gym-leader-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #fff; margin: 10px auto; object-fit: cover; }
        .gym-status { position: absolute; top: 5px; right: 5px; font-size: 0.8em; padding: 2px 5px; border-radius: 4px; background: rgba(0,0,0,0.6); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #16213e; border: 3px solid #f1c40f; padding: 30px; border-radius: 20px; text-align: center; width: 350px; position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 1.5em; color: #f1c40f; margin-bottom: 20px; }
        .btn-yes { background: #27ae60; padding: 10px 20px; border:none; color:white; border-radius:5px; cursor:pointer; margin:5px; }
        
        .battle-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 15, 30, 0.98); z-index: 5000; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto;}
        .battle-header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .battle-arena { display: flex; justify-content: space-between; width: 100%; max-width: 800px; height: 350px; align-items: flex-end; position: relative; margin-top: 20px;}
        .fighter { width: 40%; text-align: center; position: relative; transition: 0.1s; }
        .fighter img { width: 100%; height: 180px; object-fit: contain; drop-shadow: 0 10px 10px rgba(0,0,0,0.5); }
        .fighter-stats { background: rgba(0,0,0,0.6); padding: 5px; border-radius: 5px; margin-top: 5px; text-align: left; border: 1px solid #444; }
        .fighter-name { font-weight: bold; font-size: 1.1em; margin-bottom: 2px; }
        .fighter-val { display: flex; justify-content: space-between; font-size: 0.8em; color: #ccc; }
        .fighter-buff { color: #f1c40f; font-size: 0.8em; height: 1.2em; font-weight: bold; text-align: center; margin-bottom: 2px; }
        .shake-hit { animation: shake 0.4s; }
        .flash-red { animation: flashRed 0.3s; }
        .flash-heal { animation: flashGreen 0.5s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-15px); } 75% { transform: translateX(15px); } 100% { transform: translateX(0); } }
        @keyframes flashRed { 0% { filter: sepia(1) hue-rotate(-50deg) saturate(5); } 100% { filter: none; } }
        @keyframes flashGreen { 0% { filter: sepia(1) hue-rotate(90deg) saturate(3); } 100% { filter: none; } }
        .floating-text { position: absolute; font-size: 2.5em; font-weight: bold; animation: floatUp 1.5s forwards; pointer-events: none; text-shadow: 2px 2px 0 #000; z-index: 6000; white-space: nowrap; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 80% { opacity: 1; } 100% { transform: translateY(-80px) scale(1.1); opacity: 0; } }
        .timer-bar { width: 100%; height: 8px; background: #333; margin-top: 10px; border-radius: 4px; overflow: hidden; position: relative; }
        .timer-fill { height: 100%; background: #f1c40f; transition: width 1s linear; }
        .timer-text { position: absolute; top: -20px; right: 0; font-size: 0.9em; color: #aaa; }
        .chat-room { background: #1e2a38; border-radius: 10px; padding: 15px; height: 65vh; display: flex; flex-direction: column; border: 1px solid #333; }
        .chat-msgs { flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; text-align: left; }
        .chat-msg-item { margin-bottom: 5px; font-size: 0.95em; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 3px; }
        .chat-input-area { display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 12px; border-radius: 5px; border: none; background: #333; color: white; }
        .rate-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .rate-table th, .rate-table td { border: 1px solid #444; padding: 5px; font-size: 0.9em; text-align:left; }
        .skills-grid { width:100%; max-width:600px; margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:15px; }
        
        .btn-skill { padding: 10px; font-size: 1em; background: #3498db; color: white; border: none; border-radius: 10px; cursor: pointer; transition: 0.2s; position:relative; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; }
        .btn-skill:active { transform: scale(0.95); }
        .btn-skill b { font-size: 1.1em; margin-bottom: 3px; }
        .btn-skill small { font-size: 0.8em; opacity: 0.9; text-align: center; line-height: 1.2; }
        
        .detail-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333; }
        .pokedex-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .pokedex-item { background: #222; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        .pokedex-item:hover { transform: scale(1.05); border: 1px solid #f1c40f; }
        .pokedex-img { width: 100%; height: 80px; object-fit: contain; }
        .pokedex-unknown { filter: brightness(0); opacity: 0.7; }
        .pokedex-owned { border: 2px solid #f1c40f; }
        .gacha-anim { font-size: 5em; animation: bounce 1s infinite; margin-bottom: 20px; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .lobby-bar { text-align:center; padding:10px; background:#2c3e50; color:white; border-radius:5px; margin-bottom:15px; border:1px solid #f39c12; }
        .pvp-banner { position: fixed; top: 0; left: 0; width: 100%; background: rgba(231, 76, 60, 0.9); color: white; padding: 15px; text-align: center; z-index: 9999; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display:flex; justify-content:space-between; align-items:center; }
        .quest-card { text-align: left; margin-bottom: 10px; border-left: 5px solid #aaa; padding: 15px; background:#1e2a38; transition: 0.3s; }
        .quest-completed { border-left-color: #2ecc71; background: #1b261b; }
        .quest-golden { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #000 !important; border-left: 5px solid #fff; box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
        .quest-golden h4, .quest-golden p { color: #000 !important; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading" style="text-align:center; padding:50px; color:#aaa;">Loading...</div>

<div id="app" class="container" v-cloak>
    <div v-if="!user" style="text-align:center; padding-top:100px;">
        <h1 style="color:#e94560">å¯¶å¯å¤¢å¤§äº‚é¬¥ V2.15.11</h1>
        <p>é“é¤¨è£œè¡€é‚è¼¯ä¿®å¾©ç‰ˆ</p>
        <button class="btn-action" @click="logout">å‰å¾€ç™»å…¥é é¢</button>
    </div>

    <div v-else>
        <div v-if="bulkState.show" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-title">ğŸ“¦ æ‰¹é‡æ“ä½œ</div>
                <p>è«‹é¸æ“‡ {{ bulkState.name }} çš„æ•¸é‡</p>
                <div style="display:flex; justify-content:center; gap:10px; margin:20px 0;">
                    <button class="btn-yes" style="background:#3498db" @click="confirmBulkAction(1)">x1</button>
                    <button class="btn-yes" style="background:#9b59b6" @click="confirmBulkAction(10)">x10</button>
                    <button class="btn-yes" style="background:#e67e22" @click="confirmBulkAction(50)">x50</button>
                </div>
                <button class="btn-yes" style="background:#7f8c8d; width:100%;" @click="bulkState.show=false">å–æ¶ˆ</button>
            </div>
        </div>

        <div v-if="invite.has_invite" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-title">âš”ï¸ æ±ºé¬¥é‚€è«‹</div>
                <p>ç©å®¶ <b>{{ invite.source_name }}</b> å‘ä½ ç™¼èµ·äº†æŒ‘æˆ°ï¼</p>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn-yes" @click="acceptInvite">æ¥å—</button>
                    <button class="btn-yes" style="background:#e74c3c" @click="rejectInvite">æ‹’çµ•</button>
                </div>
            </div>
        </div>

        <div v-if="showRaidRates" class="modal-overlay" @click.self="showRaidRates=false">
            <div class="modal-box">
                <div class="modal-title">ğŸ”¥ Boss å‡ºç¾æ©Ÿç‡</div>
                <table class="rate-table">
                    <tr><th>Boss</th><th>æ©Ÿç‡</th></tr>
                    <tr v-for="b in raidBossPoolDisplay" :key="b.name">
                        <td>{{ b.name }} <span style="font-size:0.8em; color:#aaa;">({{ b.tag }})</span></td>
                        <td style="color:#f1c40f;">{{ b.rate }}%</td>
                    </tr>
                </table>
                <button class="btn-yes" style="width:100%; margin-top:15px;" @click="showRaidRates=false">é—œé–‰</button>
            </div>
        </div>

        <div v-if="duelState.preparing" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-title">â³ æº–å‚™æˆ°é¬¥</div>
                <h1 style="font-size:4em; margin:10px 0; color:#f1c40f;">{{ duelState.countdown }}</h1>
                <p>æ­£åœ¨é€£ç·šå°æ‰‹...</p>
            </div>
        </div>

        <div v-if="toast.show" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-title">{{ toast.title }}</div>
                <p>{{ toast.msg }}</p>
                <button class="btn-yes" style="width:100%; margin-top:15px;" @click="toast.show=false">ç¢ºå®š</button>
            </div>
        </div>

        <div v-if="showDefenderSelect" class="modal-overlay">
            <div class="modal-box" style="width: 450px;">
                <div class="modal-title">âš”ï¸ é¸æ“‡é˜²å®ˆå¯¶å¯å¤¢</div>
                <p style="color:#aaa; font-size:0.9em;">è«‹å¾ç›’å­ä¸­é¸æ“‡ä¸€éš»å¯¶å¯å¤¢ä¾†é®å®ˆé“é¤¨ã€‚<br>(åŒä¸€éš»å¯¶å¯å¤¢ä¸èƒ½åŒæ™‚å®ˆå…©å€‹é“é¤¨)</p>
                <div class="card-grid" style="max-height: 50vh; overflow-y: auto; margin-top:15px;">
                    <div v-for="p in box" :key="p.uid" class="card" @click="selectDefender(p)">
                        <img :src="getMonImage(p.name)" class="card-img" style="height: 80px;">
                        <div style="font-size:0.9em; margin-top:5px;"><b>{{ p.name }}</b><br>Lv.{{ p.lv }} (IV:{{ p.iv }})</div>
                    </div>
                </div>
                <button class="btn-yes" style="background:#7f8c8d; width:100%; margin-top:15px;" @click="showDefenderSelect=false">å–æ¶ˆ</button>
            </div>
        </div>

        <div v-if="battle.active && !inLobby" class="battle-overlay">
            <div class="battle-header">
                <h2 style="color:#f1c40f; margin:0;">
                    {{ battle.mode === 'gym' ? 'ğŸŸï¸ é“é¤¨æŒ‘æˆ°' : (battle.mode === 'raid' ? 'ğŸ”¥ åœ˜é«”æˆ°' : (battle.mode === 'wild' ? 'ğŸŒ² é‡å¤–æ¢éšª' : 'âš”ï¸ PVP')) }}
                </h2>
                <button class="btn-small" style="width:auto; background:#7f8c8d; padding:5px 10px;" @click="forceCloseBattle">é€ƒè·‘</button>
            </div>
            
            <div v-if="battle.mode === 'wild'" style="width:100%; max-width:600px; position:relative;">
                <div style="width:100%;background:#333;height:8px;border-radius:4px;"><div :style="{width: (turnTimer/10)*100 + '%', background: turnTimer < 3 ? '#e74c3c' : '#f1c40f'}" style="height:100%;"></div></div>
                <div style="font-size:0.9em;color:#aaa;text-align:right;">å›åˆ: {{ turnTimer }}s</div>
            </div>

            <div class="battle-arena">
                <div class="fighter" id="player-fighter">
                    <img :src="getMonImage(user.pokemon_name)" :class="{'shake-hit': battle.shakeMe}">
                    <div class="fighter-stats">
                        <div class="fighter-name" style="color:#3498db;">{{ user.username }}</div>
                        <div class="fighter-buff">
                            <span v-if="battle.atkBuff != 1.0" :style="{color: battle.atkBuff > 1 ? '#f1c40f' : '#e74c3c'}">âš”ï¸ x{{ battle.atkBuff.toFixed(2) }}</span>
                            <span v-if="battle.shieldActive">ğŸ›¡ï¸</span>
                        </div>
                        <div class="bar-container"><div class="bar-fill hp-fill" :style="{width: hpPercent(user) + '%'}"></div></div>
                        <div class="fighter-val">
                            <span>HP: {{ user.hp }}/{{ user.max_hp }}</span>
                            <span style="color:#f1c40f;">ATK: {{ Math.floor(user.attack * battle.atkBuff) }}</span>
                        </div>
                    </div>
                </div>
                <div class="fighter" id="enemy-fighter">
                    <img :src="battle.target.image_url || getMonImage(battle.target.name)" :class="{'shake-hit': battle.shakeTarget}">
                    <div class="fighter-stats">
                        <div class="fighter-name" style="color:#e74c3c;">{{ battle.target.name || battle.target.username }}</div>
                        <div class="bar-container"><div class="bar-fill hp-fill" :style="{width: (battle.target.hp / (battle.target.max_hp || 1)) * 100 + '%'}"></div></div>
                        <div class="fighter-val">
                            <span>HP: {{ battle.target.hp }}/{{ battle.target.max_hp }}</span>
                            <span style="color:#f1c40f;">ATK: {{ battle.target.attack }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="skills-grid">
                <button v-for="skill in mySkills" :key="skill" class="btn-skill" :class="{'btn-disabled': isEnemyTurn}" @click="doSkillAttack(skill)" :disabled="isEnemyTurn">
                    <b>{{ skill }}</b> 
                    <small>{{ getSkillDesc(skill) }}</small>
                </button>
                
                <button v-if="battle.mode === 'wild'" class="btn-skill btn-shield" :class="{'btn-disabled': isEnemyTurn}" @click="useShield" :disabled="shieldUses <= 0 || isEnemyTurn">
                    <b>ğŸ›¡ï¸ é˜²è­·ç›¾</b> <small>å‰© {{ shieldUses }} æ¬¡</small>
                </button>
                <button v-else-if="battle.mode === 'raid'" class="btn-skill btn-shield" style="background:#e91e63;" :class="{'btn-disabled': isEnemyTurn}" @click="useMedKit" :disabled="shieldUses <= 0 || isEnemyTurn">
                    <b>ğŸ’Š é†«ç™‚åŒ…</b> <small>å‰© {{ shieldUses }} æ¬¡</small>
                </button>
                <button v-else class="btn-skill" style="background:#27ae60" @click="doHeal" :class="{'btn-disabled': isEnemyTurn}" :disabled="isEnemyTurn">
                    <b>ğŸ’Š é†«ç™‚åŒ…</b> <small>å›å¾©20%</small>
                </button>
            </div>
        </div>

        <div v-if="showGachaAnim" class="modal-overlay"><div style="text-align:center;"><div class="gacha-anim">ğŸ”®</div><h2 style="color:white;">æŠ½çä¸­...</h2></div></div>
        <div v-if="gachaResult" class="modal-overlay"><div class="modal-box"><div class="modal-title">ğŸ‰ æ­å–œç²å¾—ï¼</div><img :src="getMonImage(gachaResult.prize.name)" style="width:120px; height:120px; object-fit:contain; margin:10px auto; display:block;"><h3 style="color:#f1c40f; font-size:1.5em; margin:10px 0;">{{ gachaResult.prize.name }}</h3><p>Lv.{{ gachaResult.prize.lv }} (IV: {{ gachaResult.prize.iv }})</p><div style="margin-top:20px;"><button class="btn-yes" @click="gachaResult=null">å¤ªæ£’äº†</button></div></div></div>
        <div v-if="showBattleResult" class="modal-overlay"><div class="modal-box"><div class="modal-title">ğŸ† æˆ°é¬¥çµæŸ</div><p style="white-space: pre-wrap; line-height: 1.6; font-size:1.2em;">{{ battleResultMsg }}</p><div style="margin-top:20px;"><button class="btn-yes" @click="showBattleResult=false">ç¢ºå®š</button></div></div></div>
        <div v-if="raidVictory" class="modal-overlay"><div class="modal-box"><div class="modal-title">ğŸ‰ åœ˜é«”æˆ°å‹åˆ©ï¼ ğŸ‰</div><p>è«‹é¸æ“‡æ‚¨çš„çå‹µ (ä¸‰é¸ä¸€)ï¼š</p><div style="display:flex; justify-content:center; gap:20px; margin-top:20px;"><div v-for="i in 3" :key="i" @click="claimRaidReward(i)" style="cursor:pointer; transition:0.2s; background:#2c3e50; padding:15px; border-radius:10px;"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" style="width:60px;"><div style="margin-top:5px;">é»æ“Šé–‹å•Ÿ</div></div></div></div></div>
        <div v-if="isRaidDead" class="modal-overlay" style="background:rgba(50,0,0,0.9);"><div class="modal-box" style="border: 3px solid #e74c3c;"><div class="modal-title" style="color:#e74c3c;">ğŸ’€ ä½ å·²ç¶“æ­»äº¡</div><h2 style="font-size:4em; margin:10px 0; color:#fff;">{{ raidDeadTimer }}</h2><p>ç§’å¾Œå°‡è¢«è¸¢å‡ºå¤§å»³...</p><button class="btn-action" style="background:#27ae60; margin-top:20px; padding:15px;" @click="reviveRaid">ğŸ’Š è³¼è²·å¾©æ´» (500G)</button></div></div>
        
        <div v-if="viewMon" class="modal-overlay" style="z-index: 10000;" @click.self="viewMon=null">
            <div class="modal-box" style="width:380px;">
                <div class="modal-title">{{ viewMon.name }} <span v-if="viewMon.lv" style="font-size:0.6em; color:#aaa;">(Lv.{{ viewMon.lv }})</span></div>
                <div style="text-align:center; margin:10px 0;"><img :src="viewMon.img_src" style="width:120px; height:120px; object-fit:contain;"></div>
                <div v-if="viewMon.iv" style="text-align:center; margin-bottom:15px;"><span style="background:#f1c40f; color:black; padding:2px 8px; border-radius:5px; font-weight:bold;">IV: {{ viewMon.iv }}</span></div>
                
                <div v-if="trainMode.show && !viewMon.is_demo" style="background:#222; padding:10px; border-radius:10px; margin-bottom:10px;">
                    <h4 style="margin:5px 0; color:#f1c40f;">âš¡ æ½›èƒ½ç‰¹è¨“ä¸­å¿ƒ</h4>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button class="btn-small" :style="{background: trainMode.type=='normal'?'#3498db':'#333'}" @click="trainMode.type='normal'">ä¸€èˆ¬ç‰¹è¨“</button>
                        <button class="btn-small" :style="{background: trainMode.type=='hyper'?'#e74c3c':'#333'}" @click="trainMode.type='hyper'">æ¥µé™ç‰¹è¨“</button>
                    </div>
                    <div style="font-size:0.8em; color:#aaa; margin-bottom:10px;">
                        <div v-if="trainMode.type=='normal'">è²»ç”¨: {{ isLegendary(viewMon.name) ? '50ğŸ¬+3âœ¨+5000G' : '30ğŸ¬+3âœ¨+1000G' }}<br>æ•ˆæœ: IV éš¨æ©Ÿ ({{ isLegendary(viewMon.name) ? '60' : '0' }}~100)</div>
                        <div v-else>è²»ç”¨: {{ isLegendary(viewMon.name) ? '250ğŸ¬+15âœ¨+2.5è¬G' : '150ğŸ¬+15âœ¨+5000G' }}<br>æ•ˆæœ: IV å¿…å®šæå‡</div>
                    </div>
                    <button class="btn-action" @click="trainMon(viewMon.uid)">é–‹å§‹ç‰¹è¨“</button>
                    <button class="btn-small" style="background:#7f8c8d; margin-top:5px; width:100%;" @click="trainMode.show=false">å–æ¶ˆ</button>
                </div>

                <div v-else>
                    <div class="detail-row"><span>â¤ï¸ æœ€å¤§è¡€é‡</span><b>{{ viewMon.hp_val }}</b></div>
                    <div class="detail-row"><span>âš”ï¸ æ”»æ“ŠåŠ›</span><b>{{ viewMon.atk_val }}</b></div>
                    <div v-if="!viewMon.is_demo" class="detail-row"><span>âœ¨ ç¶“é©—å€¼</span><span>{{ viewMon.exp }}</span></div>
                    <div style="margin-top:15px; text-align:left;"><h4>âš¡ æŠ€èƒ½çµ„</h4><div v-for="skill in getMonSkills(viewMon.name)" :key="skill" style="background:#222; padding:5px; margin-bottom:5px; border-radius:5px;"><b style="color:#3498db">{{ skill }}</b> <small style="color:#aaa;">{{ getSkillDesc(skill) }}</small></div></div>
                    <div style="display:flex; gap:10px; margin-top:20px; flex-wrap:wrap;">
                        <button class="btn-yes" style="flex:1; background:#7f8c8d" @click="viewMon=null">é—œé–‰</button>
                        <template v-if="!viewMon.is_demo">
                            <button class="btn-yes" style="flex:1; background:#e67e22;" @click="openBulkCandy(viewMon.uid)">ğŸ¬ é¤µç³–</button>
                            <button class="btn-yes" style="flex:1; background:#9b59b6;" @click="trainMode.show=true">âš¡ ç‰¹è¨“</button>
                            <button class="btn-yes" style="width:100%; margin-top:5px;" @click="swapMon(viewMon.uid); viewMon=null;">å‡ºæˆ°</button>
                            <button class="btn-yes" style="width:100%; margin-top:5px; background:#c0392b;" @click="releaseMon(viewMon.uid)">âŒ æ”¾ç”Ÿ</button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="newsState.show" class="modal-overlay"><div class="modal-box" style="text-align:left;"><div class="modal-title" style="text-align:center;">ğŸ“¢ V2.15.11 æ›´æ–°å…¬å‘Š</div><ul><li><b>âš¡ æŠ€èƒ½ä¿®æ­£</b>ï¼šç ´å£æ­»å…‰å·²å¯¦è£ï¼Œä¸¦ä¿®å¾©äº†è£œè¡€æ•¸å­—é¡¯ç¤ºå•é¡Œã€‚</li><li><b>ğŸ“¦ æ‰¹é‡æ“ä½œ</b>ï¼šå•†åº—èˆ‡é¤µç³–ç¾åœ¨å¯ä»¥ä¸€æ¬¡æ“ä½œå¤šå€‹ã€‚</li><li><b>âš”ï¸ å…¨é¢å‡ç´š</b>ï¼šç©å®¶ç­‰ç´šä¸Šé™æå‡è‡³Lv.120ã€‚</li></ul><div style="text-align:center; margin-top:15px;"><button class="btn-yes" @click="closeNews">æˆ‘çŸ¥é“äº†</button></div></div></div>
        
        <div v-if="showRates" class="modal-overlay" @click.self="showRates=false"><div class="modal-box" style="width: 400px; max-height:80vh;"><div class="modal-title">ğŸ“Š æ‰­è›‹æ©Ÿç‡è¡¨</div><div style="overflow-y:auto; max-height:60vh;"><div v-for="(pool, name) in gachaRates" :key="name" style="margin-bottom: 15px;"><h4 style="color: #f1c40f; border-bottom: 1px solid #555;">{{ name }}</h4><table class="rate-table"><tr v-for="item in pool" :key="item.name"><td>{{ item.name }}</td><td style="text-align: right;">{{ item.rate }}%</td></tr></table></div></div><button class="btn-yes" style="width: 100%; margin-top: 10px;" @click="showRates=false">é—œé–‰</button></div></div>

        <div v-if="inLobby" class="lobby-bar"><span style="font-size:1.2em; margin-right:20px;">âš ï¸ æˆ°é¬¥æº–å‚™ä¸­...</span><span style="font-size:1.5em; color:#f1c40f; font-family:monospace;">{{ lobbyTimer }}s</span></div>
        <div class="navbar">
            <div class="user-info">
                <img :src="getMonImage(user.pokemon_name)" class="user-avatar">
                <div class="user-stats">
                    <div class="stat-block"><div class="stat-title"><span>{{ user.username }} (Lv.{{ user.level }})</span><span>ğŸ’° {{ user.money }}</span></div><div class="bar-container"><div class="bar-fill player-xp-fill" :style="{ width: playerXpPercent + '%' }"></div></div><div class="bar-text"><span>Trainer XP</span><span>{{ user.exp }}/{{ getReqXp(user.level) }}</span></div></div>
                    <div class="stat-block"><div class="stat-title"><span>{{ user.pokemon_name }} (Lv.{{ user.pet_level }})</span><span class="atk-val">ATK: {{ currentAtkMe }} (IV: {{ currentPetIV }})</span></div><div class="bar-container"><div class="bar-fill hp-fill" :style="{ width: hpPercent(user) + '%' }"></div></div><div class="bar-text"><span>HP: {{ user.hp || 0 }}/{{ user.max_hp || 100 }}</span></div><div class="bar-container" style="margin-top:4px;"><div class="bar-fill pet-xp-fill" :style="{ width: petXpPercent(user) + '%' }"></div></div></div>
                </div>
            </div>
            <div style="display:flex; flex-direction:column; gap:5px;"><button class="btn-logout" @click="logout">ç™»å‡º</button></div>
        </div>
        
        <div class="tabs" v-if="!battle.active">
            <button class="tab-btn" :class="{active: tab=='wild'}" @click="tab='wild'">ğŸŒ² é‡å¤–</button>
            <button class="tab-btn" :class="{active: tab=='gym'}" @click="tab='gym'">ğŸŸï¸ é“é¤¨</button>
            <button class="tab-btn" :class="{active: tab=='arena'}" @click="tab='arena'">ğŸŸï¸ ç«¶æŠ€</button>
            <button class="tab-btn" :class="{active: tab=='box'}" @click="tab='box'">ğŸ“¦ ç›’å­</button>
            <button class="tab-btn" :class="{active: tab=='pokedex'}" @click="tab='pokedex'">ğŸ“– åœ–é‘‘</button>
            <button class="tab-btn" :class="{active: tab=='bag'}" @click="tab='bag'">ğŸ’ èƒŒåŒ…</button>
            <button class="tab-btn" :class="{active: tab=='leaderboard'}" @click="tab='leaderboard'">ğŸ† æ’è¡Œ</button>
            <button class="tab-btn" :class="{active: tab=='raid'}" @click="tab='raid'">ğŸ”¥ åœ˜é«”æˆ°</button>
            <button class="tab-btn" :class="{active: tab=='quest'}" @click="tab='quest'">ğŸ“œ ä»»å‹™</button>
            <button class="tab-btn" :class="{active: tab=='shop'}" @click="tab='shop'">ğŸ›’ å•†åº—</button>
        </div>

        <div v-if="!battle.active">
            <div v-if="tab=='wild'"><h3>ğŸŒ² é¸æ“‡æ¢éšªå€åŸŸ</h3><div style="margin-bottom:15px; background:#2c3e50; padding:10px; border-radius:8px;"><label>ç­‰ç´šé¸æ“‡ï¼š</label><select v-model="selectedWildLevel" @change="fetchWildList" style="padding:5px; background:#16213e; color:white; border:none;"><option v-for="n in user.level" :value="n">Lv. {{ n }}</option></select></div><div class="card-grid"><div v-for="m in wildList" :key="m.name" class="card"><img :src="m.image_url" class="card-img"><div style="margin-top:5px;"><b>{{ m.name }}</b><br><small>Lv.{{ m.level }} | HP:{{m.hp}}</small><br><button class="btn-small" style="background:#c0392b" @click="startWildBattle(m)">æˆ°é¬¥</button></div></div></div></div>
            
            <div v-if="tab=='gym'">
                <h3>ğŸŸï¸ é“é¤¨çˆ­å¥ªæˆ°</h3>
                <div class="card-grid">
                    <div v-for="g in gymList" :key="g.id" class="card gym-card" :class="{'occupied-me': g.leader_id === user.id, 'protected': g.is_protected}">
                        <div v-if="g.is_protected" class="gym-status" style="background:#3498db;">ğŸ›¡ï¸ ä¿è­·: {{ g.protection_sec }}s</div>
                        <div v-else-if="g.leader_id" class="gym-status" style="background:#e74c3c;">âš”ï¸ å·²ä½”é ˜</div>
                        <div v-else class="gym-status" style="background:#2ecc71;">âœ… ç©ºé“é¤¨</div>
                        <h4>{{ g.name }}</h4>
                        <img :src="g.leader_img || 'https://via.placeholder.com/60?text=Empty'" class="gym-leader-avatar">
                        <div style="font-size:0.9em;">é¤¨ä¸»: <b>{{ g.leader_name }}</b></div>
                        <div style="font-size:0.8em; color:#f1c40f; margin:5px 0;">{{ g.buff }}</div>
                        <div style="font-size:0.8em; color:#aaa;">æ”¶ç›Š: {{ g.rate }} G/åˆ†</div>
                        <div v-if="g.leader_id === user.id">
                            <div style="color:#2ecc71; font-weight:bold; margin:5px 0;">ç´¯ç©: {{ g.income_acc }} G</div>
                            <button class="btn-action" style="background:#f39c12; color:black;" @click="startGymBattle(g.id)">ğŸ’° æ”¶å–</button>
                        </div>
                        <button v-else class="btn-action" @click="startGymBattle(g.id)">{{ g.leader_id ? 'âš”ï¸ è¸¢é¤¨' : 'ğŸš© ä½”é ˜' }}</button>
                    </div>
                </div>
            </div>

            <div v-if="tab=='raid'">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3>ğŸ”¥ åœ˜é«”æˆ°å¤§å»³</h3>
                    <button class="btn-small" style="width:auto; background:#7f8c8d;" @click="showRaidRates=true">ğŸ“Š Bossæ©Ÿç‡</button>
                </div>
                <div v-if="raidState.active" class="card" style="border:2px solid #e74c3c; background:#2c0b0e;"><h2>Boss: {{ raidState.boss_name }}</h2><img :src="raidState.image" style="width:120px; height:120px;"><div v-if="raidState.status === 'LOBBY'" style="color:#f1c40f; margin:10px 0;">â³ æº–å‚™ä¸­... 00åˆ†æº–æ™‚é–‹æ‰“</div><div v-else><div class="bar-container" style="height:20px;"><div class="hp-fill" :style="{width: (raidState.hp/raidState.max_hp)*100 + '%'}"></div></div><p>HP: {{ raidState.hp }} / {{ raidState.max_hp }}</p></div><button v-if="raidState.status=='ENDED'" class="btn-action" style="background:#f1c40f; color:black;" @click="raidVictory=true">ğŸ é ˜å–çå‹µ</button><button v-else-if="canJoinLobby" class="btn-action btn-disabled">â³ å°šæœªé–‹æ”¾</button><button v-else-if="raidState.status=='FIGHTING'" class="btn-action" @click="joinRaid">åŠ å…¥æˆ°é¬¥ (1000G)</button></div><div v-else class="card">ç›®å‰æ²’æœ‰åœ˜é«”æˆ° (08/14/18/21/22/23 é»)</div>
            </div>
            <div v-if="tab=='quest'"><div v-if="quests.length === 0" style="color:#aaa; text-align:center;">ç›®å‰æ²’æœ‰ä»»å‹™ï¼Œè«‹é‡æ–°æ•´ç†é é¢...</div><div v-for="q in quests" :key="q.id" class="card quest-card" :class="{'quest-golden': q.type=='GOLDEN', 'quest-completed': q.now >= q.req}"><h4><span v-if="q.type=='GOLDEN'">âœ¨</span> {{ q.target_display || q.target }} <span v-if="q.type=='GOLDEN'">âœ¨</span></h4><div class="bar-container" style="height:12px; margin:10px 0; background:rgba(0,0,0,0.3);"><div class="bar-fill" :style="{ width: Math.min(100, (q.now/q.req)*100) + '%', background: q.now >= q.req ? '#2ecc71' : (q.type=='GOLDEN' ? '#fff' : '#f1c40f') }"></div></div><div style="display:flex; justify-content:space-between; align-items:center;"><div><p style="margin:2px 0;">é€²åº¦ï¼š{{ q.now }} / {{ q.req }}</p><p style="margin:2px 0; font-size:0.9em; opacity:0.8;">çå‹µï¼š{{ q.type=='GOLDEN' ? 'âœ¨ é»ƒé‡‘ç³–æœ x1' : (q.gold + 'G / ' + q.xp + ' XP') }}</p></div><button v-if="Number(q.now) >= Number(q.req)" class="btn-action" style="width:120px; background:#2ecc71;" @click="claimQuest(q.id)">ğŸ é ˜å–çå‹µ</button><button v-else class="btn-action" style="width:120px; background:#e74c3c; font-size:0.8em; opacity:0.8;" @click="abandonQuest(q.id)">æ›´æ› (-1000G)</button></div></div></div>
            <div v-if="tab=='box'"><h3>ğŸ“¦ å¯¶å¯å¤¢ç›’å­ ({{ box.length }}/35)</h3><div class="card-grid"><div v-for="p in box" :key="p.uid" class="card" :class="{active: p.uid === user.active_pokemon_uid}" @click="viewBoxMon(p)" :style="{borderColor: p.uid === user.active_pokemon_uid ? '#f1c40f' : 'transparent'}"><span class="iv-tag">IV: {{ p.iv }}</span><b>{{ p.name }}</b><div>Lv.{{ p.lv }}</div></div></div></div>
            <div v-if="tab=='pokedex'"><h3>ğŸ“– å¯¶å¯å¤¢åœ–é‘‘ ({{ pokedexPercent }}%)</h3><div class="pokedex-grid"><div v-for="item in pokedexCollection" :key="item.name" class="pokedex-item" :class="{'pokedex-owned': item.is_owned}" @click="viewPokedexEntry(item)"><img :src="item.img" class="pokedex-img" :class="{'pokedex-unknown': !item.is_owned}"><div style="font-size:0.8em; margin-top:5px;">{{ item.is_owned ? item.name : '???' }}</div></div></div></div>
            
            <div v-if="tab=='shop'">
                <h3>ğŸ›’ é“å…·å•†åº—</h3>
                <div class="card-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom:20px;">
                    <div class="item-buy-btn" @click="openBulkBuy('candy', 'ç¥å¥‡ç³–æœ', 500)"><div class="item-icon">ğŸ¬</div><div>ç¥å¥‡ç³–æœ</div><div class="item-price">500 G</div></div>
                    <div class="item-buy-btn" @click="openBulkBuy('growth', 'æˆé•·ç³–æœ', 2000)"><div class="item-icon">ğŸ’Š</div><div>æˆé•·ç³–æœ</div><div class="item-price">2000 G</div></div>
                    <div class="item-buy-btn" @click="openBulkBuy('golden', 'é»ƒé‡‘ç³–æœ', 10000)"><div class="item-icon">âœ¨</div><div>é»ƒé‡‘ç³–æœ</div><div class="item-price">10,000 G</div></div>
                    <div class="item-buy-btn" @click="openBulkBuy('legendary', 'å‚³èªªç³–æœ', 25000)"><div class="item-icon">ğŸ”®</div><div>å‚³èªªç³–æœ</div><div class="item-price">25,000 G</div></div>
                </div>

                <h3>ğŸ”® æ‰­è›‹å•†åº— <button style="font-size:0.6em; background:#555; border:none; color:white; padding:3px;" @click="showRates=true">ğŸ“Š æ©Ÿç‡</button></h3>
                <div class="gacha-grid">
                    <button class="btn-gacha g-normal" @click="playGacha('normal')"><span>ğŸ”® åˆç´š</span><span>2500G</span></button>
                    <button class="btn-gacha g-medium" @click="playGacha('medium')"><span>ğŸ”µ ä¸­ç´š</span><span>5000G</span></button>
                    <button class="btn-gacha g-high" @click="playGacha('high')"><span>ğŸŸ£ é«˜ç´š</span><span>15000G</span></button>
                    <button class="btn-gacha g-candy" @click="playGacha('candy')"><span>ğŸ¬ ç³–æœ</span><span>12 Candy</span></button>
                    <button class="btn-gacha g-golden" @click="playGacha('golden')"><span>âœ¨ é»ƒé‡‘</span><span>3 Golden</span></button>
                    <button class="btn-gacha g-leg-candy" @click="playGacha('legendary_candy')"><span>ğŸ‘‘ å‚³èªª(ç³–)</span><span>5 Candy</span></button>
                    <button class="btn-gacha g-leg-gold" @click="playGacha('legendary_gold')"><span>ğŸ’° å‚³å¥‡(é‡‘)</span><span>200K G</span></button>
                </div>
                <br><button class="btn-action" style="background:#27ae60; width:100%; padding:15px;" @click="buyHeal">ğŸ’Š è£œè¡€ (50G)</button>
                <div class="card" style="margin-top:15px; border-color:#aaa;"><h4>ğŸ å…Œæ›ç¢¼</h4><div style="display:flex; gap:5px;"><input v-model="promoCode" placeholder="è¼¸å…¥åºè™Ÿ" style="flex:1; padding:8px; border-radius:5px; border:none;"><button class="btn-action" style="margin-top:0; width:80px;" @click="redeemCode">å…Œæ›</button></div></div>
                <div class="card" style="text-align:center; border:2px solid #f39c12; margin-top:20px;">
                    <h3 style="color:#f39c12; margin-bottom:10px;">ğŸ° å¹¸é‹è³­å ´</h3>
                    <input type="number" v-model.number="gambleAmount" placeholder="è¼¸å…¥é‡‘é¡" style="padding:10px; width:100px; border-radius:5px; border:none; margin-right:10px;">
                    <button class="btn-action" style="margin-top:0; width:auto; background:#f39c12; color:black;" @click="doGamble">ä¸‹æ³¨ï¼</button>
                </div>
            </div>

            <div v-if="tab=='bag'"><div class="card-grid"><div class="card" style="background:#2c3e50;"><div style="font-size:2em;">ğŸ¬</div><b>ç¥å¥‡ç³–æœ</b><div style="font-size:1.2em; color:#f1c40f;">{{ inventory.candy || 0 }}</div></div><div class="card" style="background:#2c3e50;"><div style="font-size:2em;">âœ¨</div><b>é»ƒé‡‘ç³–æœ</b><div style="font-size:1.2em; color:#f1c40f;">{{ inventory.golden_candy || 0 }}</div></div><div class="card" style="background:#2c3e50;"><div style="font-size:2em;">ğŸ’Š</div><b>æˆé•·ç³–æœ</b><div style="font-size:1.2em; color:#f1c40f;">{{ inventory.growth_candy || 0 }}</div></div><div class="card" style="background:#2c3e50;"><div style="font-size:2em;">ğŸ”®</div><b>å‚³èªªç³–æœ</b><div style="font-size:1.2em; color:#f1c40f;">{{ inventory.legendary_candy || 0 }}</div></div></div></div>
            <div v-if="tab=='leaderboard'"><div class="card"><h3>ğŸ† å…¨æœæ’è¡Œæ¦œ</h3><div style="margin-bottom:10px;"><label>æ’åºæ–¹å¼ï¼š</label><select v-model="leaderboardType" @change="fetchLeaderboard" style="padding:5px; background:#16213e; color:white; border:none;"><option value="level">ç­‰ç´š (Level)</option><option value="money">è²¡å¯Œ (Gold)</option></select></div><table v-if="leaderboardData.length > 0" style="width:100%; border-collapse:collapse; margin-top:10px;"><tr style="border-bottom:1px solid #555; text-align:left;"><th style="padding:5px;">æ’å</th><th>ç©å®¶</th><th>æ•¸å€¼</th></tr><tr v-for="r in leaderboardData" :key="r.rank" style="border-bottom:1px solid #333;"><td style="padding:8px;"><span v-if="r.rank==1">ğŸ¥‡</span><span v-else-if="r.rank==2">ğŸ¥ˆ</span><span v-else-if="r.rank==3">ğŸ¥‰</span><span v-else>{{ r.rank }}</span></td><td><img :src="r.img" style="width:20px; height:20px; vertical-align:middle; border-radius:50%;"> {{ r.username }}</td><td>{{ r.value }}</td></tr></table><div v-else style="padding:20px; text-align:center; color:#aaa;">æš«ç„¡æ’è¡Œè³‡æ–™æˆ–è¼‰å…¥ä¸­...</div></div></div>
            <div v-if="tab=='arena'">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#2c3e50; padding:10px; border-radius:8px;">
                    <div><b>âš”ï¸ ç«¶æŠ€å ´è¨­å®š</b></div>
                    <button class="btn-small" :style="{background: pvpBlocked ? '#e74c3c' : '#2ecc71', width:'auto'}" @click="togglePvpSettings">
                        {{ pvpBlocked ? 'ğŸ”• æ‹’çµ•é‚€è«‹' : 'ğŸ”” æ¥å—é‚€è«‹' }}
                    </button>
                </div>
                <div class="card-grid"><div v-for="p in players" :key="p.id" class="card" :style="{opacity: p.is_online ? 1 : 0.5}"><img :src="p.pokemon_image" class="card-img"><div style="margin-top:5px;"><b>{{ p.username }}</b><span v-if="p.is_online" style="color:#2ecc71; font-size:0.8em;">â— åœ¨ç·š</span><span v-else style="color:#95a5a6; font-size:0.8em;">â— é›¢ç·š</span><div style="display:flex; gap:5px; margin-top:5px;"><button v-if="p.is_online" class="btn-small" style="background:#c0392b" @click="sendInvite(p)">æ±ºé¬¥</button><button v-else class="btn-small btn-disabled" disabled>æ±ºé¬¥</button></div></div></div></div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, computed, watch, onUpdated } = Vue;
    const API_URL = `https://mwtpokemons.zeabur.app/api/v1`;

    const LEVEL_XP_MAP = { 1: 50, 2: 120, 3: 200, 4: 350, 5: 600, 6: 900, 7: 1360, 8: 1800, 9: 2300 };

    createApp({
        setup() {
            const user = ref(null);
            const token = localStorage.getItem('token');
            const tab = ref('wild'); 
            const bulkState = ref({ show: false, type: '', targetId: '', name: '', price: 0 });
            const isBattleResultShown = ref(false);
            const showRaidRates = ref(false);
            const pvpBlocked = ref(false); // ğŸ”¥ PVP ç‹€æ…‹

            const raidBossPoolDisplay = [
                { name: "â„ï¸ æ€¥å‡é³¥", rate: 25, tag: "å¸¸è¦‹" },
                { name: "ğŸ”¥ ç«ç„°é³¥", rate: 25, tag: "å¸¸è¦‹" },
                { name: "âš¡ é–ƒé›»é³¥", rate: 25, tag: "å¸¸è¦‹" },
                { name: "ğŸŒˆ é³³ç‹", rate: 7.5, tag: "ç¨€æœ‰" },
                { name: "ğŸŒªï¸ æ´›å¥‡äº", rate: 7.5, tag: "ç¨€æœ‰" },
                { name: "ğŸ”® è¶…å¤¢", rate: 5, tag: "æ¥µç¨€æœ‰" },
                { name: "âœ¨ å¤¢å¹»", rate: 5, tag: "æ¥µç¨€æœ‰" }
            ];

            watch(tab, (newVal) => {
                if (newVal === 'quest') fetchQuests();
                if (newVal === 'leaderboard') fetchLeaderboard();
                if (newVal === 'wild') fetchWildList();
            });

            // ... (box, inventory, currentPetIV, getReqXp, playerXpPercent, hpPercent, petXpPercent, currentAtkMe ä¿æŒä¸è®Š)
            const box = computed(() => { if(!user.value || !user.value.pokemon_storage) return []; if(typeof user.value.pokemon_storage === 'object') return user.value.pokemon_storage; try { return JSON.parse(user.value.pokemon_storage); } catch(e) { return []; } });
            const inventory = computed(() => { if(!user.value) return {}; try { return JSON.parse(user.value.inventory); } catch(e) { return {}; } });
            const currentPetIV = computed(() => { if(!user.value) return 0; const p = box.value.find(x => x.uid === user.value.active_pokemon_uid); return p ? p.iv : 50; });
            const getReqXp = (lv) => { if(lv >= 100) return 999999999; if(lv <= 10) return LEVEL_XP_MAP[lv]; let req = 2300; for(let i=11; i<=Math.min(lv, 50); i++) req += 600; if(lv > 50) { for(let i=51; i<=lv; i++) req += 2000; } return req; };
            const playerXpPercent = computed(() => user.value ? Math.min(100, (user.value.exp / getReqXp(user.value.level)) * 100) : 0);
            const hpPercent = (u) => { if (!u || !u.max_hp || u.max_hp <= 0) return 0; return Math.min(100, (u.hp / u.max_hp) * 100); };
            const petXpPercent = (u) => { if (!u) return 0; const req = getReqXp(u.pet_level); return Math.min(100, (u.pet_exp / req) * 100); };
            const currentAtkMe = computed(() => user.value ? user.value.attack : 0);
            
            const battle = ref({ active: false, mode: 'wild', target: null, shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false });
            const raidState = ref({ active: false, hp: 0, max_hp: 0, boss_name: '', status: 'IDLE', image: '', my_status: {}, attack_counter: 0 });
            const inLobby = ref(false);
            const lobbyTimer = ref(15);
            const leaderboardData = ref([]);
            const leaderboardType = ref("level");
            const newsState = ref({ show: false });
            const trainMode = ref({ show: false, type: 'normal' });
            
            const chatInput = ref("");
            const chatMsgs = ref([]); 
            const gambleAmount = ref(100);
            const promoCode = ref("");
            const selectedWildLevel = ref(1);
            const wildList = ref([]);
            const gymList = ref([]); 
            const showRates = ref(false);
            const showGachaAnim = ref(false);
            const gachaResult = ref(null);
            const showBattleResult = ref(false);
            const battleResultMsg = ref("");
            const quests = ref([]);
            const players = ref([]);
            const viewMon = ref(null);
            const pokedexCollection = ref([]); 
            const pokedexPercent = ref(0); 
            const pokedexMap = ref({}); 
            
            const toast = ref({ show: false, title: "", msg: "" });
            const showToast = (title, msg) => { toast.value = { show: true, title, msg }; };

            const invite = ref({ has_invite: false, source_id: 0, source_name: "" });
            const duelState = ref({ preparing: false, countdown: 12 });
            const showDefenderSelect = ref(false);
            const pendingGymId = ref(null);

            const skillData = ref({});
            // ğŸ”¥ æ›´æ–°å‰ç«¯æŠ€èƒ½è¡¨ (SKILL_MAP)ï¼ŒåŠ å…¥ã€Œç ´å£æ­»å…‰ã€
            const SKILL_MAP = { 
                "å°æ‹‰é”": ["æŠ“", "å‡ºå¥‡ä¸€æ“Š", "æ’æ“Š"], "æ³¢æ³¢": ["æŠ“", "å•„", "ç‡•è¿”"], "å°ç«é¾": ["ç«èŠ±", "å™´å°„ç«ç„°", "å¤§å­—çˆ†ç‚"], "å‚‘å°¼é¾œ": ["æ°´æ§", "æ°´æµå™´å°„", "æ°´æµå°¾"], "å¦™è›™ç¨®å­": ["è—¤é­", "ç¨®å­ç‚¸å½ˆ", "æ±¡æ³¥ç‚¸å½ˆ"], "çš®å¡ä¸˜": ["é›»å…‰", "æ”¾é›»", "é›»æ“Š"], "ä¼Šå¸ƒ": ["æ’æ“Š", "æŒ–æ´", "é«˜é€Ÿæ˜Ÿæ˜Ÿ"], "å¡æ¯”ç¸": ["æ³°å±±å£“é ‚", "åœ°éœ‡", "ç ´å£æ­»å…‰"], "å¿«é¾": ["é¾æ¯", "é€†é±—", "å‹‡é³¥çŒ›æ”»"], "è¶…å¤¢": ["å¿µåŠ›", "ç²¾ç¥å¼·å¿µ", "ç²¾ç¥æ“Šç ´"], "å¤¢å¹»": ["å¿µåŠ›", "æš—å½±çƒ", "ç²¾ç¥æ“Šç ´"], "æ€¥å‡é³¥": ["å†°ç¤«", "å†°å‡å…‰æŸ", "å‹‡é³¥çŒ›æ”»"], "ç«ç„°é³¥": ["å™´å°„ç«ç„°", "å¤§å­—çˆ†ç‚", "å‹‡é³¥çŒ›æ”»"], "é–ƒé›»é³¥": ["é›»å…‰", "ç˜‹ç‹‚ä¼ç‰¹", "å‹‡é³¥çŒ›æ”»"], "é³³ç‹": ["ç‡’ç›¡", "å‹‡é³¥çŒ›æ”»", "ç¥è–ä¹‹ç«"], "æ´›å¥‡äº": ["é¾å°¾", "æ°´ç ²", "æ°£æ—‹æ”»æ“Š"], "å¦™è›™èŠ±": ["è—¤é­", "ç¨®å­ç‚¸å½ˆ", "æ±¡æ³¥ç‚¸å½ˆ"], "å™´ç«é¾": ["ç«èŠ±", "å™´å°„ç«ç„°", "å¤§å­—çˆ†ç‚"], "æ°´ç®­é¾œ": ["æ°´æ§", "æ°´æµå™´å°„", "æ°´æµå°¾"], "æ¯›è¾®ç¾Š": ["æ’æ“Š", "æ’’å¬Œ", "é›»æ“Š"], "å…­å°¾": ["æ’æ“Š", "ç«èŠ±", "å™´å°„ç«ç„°"], "èƒ–ä¸": ["æ’æ“Š", "æ’’å¬Œ", "ç²¾ç¥å¼·å¿µ"], "çš®çš®": ["æ’æ“Š", "æ’’å¬Œ", "ç²¾ç¥å¼·å¿µ"], "å¤§è”¥é´¨": ["å•„", "è‘‰åˆƒ", "å‹‡é³¥çŒ›æ”»"], "å‘†å‘†ç¸": ["æ°´æ§", "å¹»è±¡å…‰ç·š", "æ°´æµå™´å°„"], "å¯é”é´¨": ["æ°´æ§", "å¹»è±¡å…‰ç·š", "æ°´æµå™´å°„"], "è€¿é¬¼": ["é©šåš‡", "æ±¡æ³¥ç‚¸å½ˆ", "æš—å½±çƒ"], "å‰åˆ©è›‹": ["ç ´å£æ­»å…‰", "ç²¾ç¥å¼·å¿µ", "æ’æ“Š"], "å¹¸ç¦è›‹": ["ç ´å£æ­»å…‰", "ç²¾ç¥å¼·å¿µ", "æ’æ“Š"], "æ‹‰æ™®æ‹‰æ–¯": ["æ°´æ§", "æ°´æµå™´å°„", "å†°å‡å…‰æŸ"],
                "çƒˆé›€": ["æŠ“", "å•„", "ç‡•è¿”"], "é˜¿æŸè›‡": ["æ¯’é‡", "æ¯’æ“Š", "ç·ŠæŸ"], "ç“¦æ–¯å½ˆ": ["æ¯’é‡", "æ¯’é‡", "æ’æ“Š"], "æµ·æ˜Ÿæ˜Ÿ": ["æ°´æ§", "å¹»è±¡å…‰ç·š", "æ’æ“Š"], "è§’é‡‘é­š": ["æ°´æ§", "å¹»è±¡å…‰ç·š", "æ³¥å·´å°„æ“Š"], "èµ°è·¯è‰": ["ç¨®å­ç‚¸å½ˆ", "æ’æ“Š", "æ¯’æ“Š"], "ç©¿å±±é¼ ": ["æŠ“", "æ³¥å·´å°„æ“Š", "æ³¥å·´ç‚¸å½ˆ"], "èšŠé¦™èŒèšª": ["é›™å€å¥‰é‚„", "å†°å‡å…‰æŸ", "æ°´æ§"], "å°ç£æ€ª": ["é›»æ“Š", "æ”¾é›»", "æ’æ“Š"], "å¡æ‹‰å¡æ‹‰": ["æ³¥å·´å°„æ“Š", "æ³¥å·´ç‚¸å½ˆ", "æŒ–æ´"], "å–µå–µ": ["æŠ“", "å‡ºå¥‡ä¸€æ“Š", "æ’æ“Š"], "ç‘ªç‘™æ°´æ¯": ["æ°´æ§", "æ°´æµå°¾", "ç·ŠæŸ"], "æµ·åˆºé¾": ["æ°´æ§", "æ°´æµå°¾", "é€†é±—"], "é›»æ“Šç¸": ["é›»å…‰", "é›»æ“Š", "ç˜‹ç‹‚ä¼ç‰¹"], "é´¨å˜´ç«ç¸": ["ç«èŠ±", "å™´å°„ç«ç„°", "å¤§å­—çˆ†ç‚"], "åŒ–çŸ³ç¿¼é¾": ["æŒ–æ´", "å²©çŸ³å°é–", "å‹‡é³¥çŒ›æ”»"], "æ€ªåŠ›": ["é›™å€å¥‰é‚„", "å²©çŸ³å°é–", "è¿‘èº«æˆ°"], "æš´é¯‰é¾": ["æ°´æ§", "æ°´æµå°¾", "å‹‡é³¥çŒ›æ”»"],
                "é£›å¤©è³è‚": ["åå­—å‰ª", "ç‡•è¿”", "æ’æ“Š"], "è¿·å”‡å§": ["å†°ç¤«", "æ’’å¬Œ", "å¹»è±¡å…‰ç·š"], "é®åˆ€ç›”": ["æ³¥å·´å°„æ“Š", "æ°´æµå™´å°„", "å²©çŸ³å°é–"], "å¤šåˆºèŠçŸ³ç¸": ["æ³¥å·´å°„æ“Š", "æ°´æµå™´å°„", "å²©çŸ³å°é–"]
            };
            
            const mySkills = ref(["æ’æ“Š", "æ’æ“Š", "æ’æ“Š"]);
            const shieldUses = ref(2);
            const turnTimer = ref(10);
            const isEnemyTurn = ref(false);
            let timerInterval = null;
            const raidVictory = ref(false);
            const isRaidDead = ref(false);
            const raidDeadTimer = ref(5);
            let deadInterval = null;
            let battleId = null;

            const gachaRates = { 
                "ğŸ”® åˆç´š": [{name:"å¦™è›™ç¨®å­", rate:5}, {name:"å°ç«é¾", rate:5}, {name:"å‚‘å°¼é¾œ", rate:5}, {name:"å…­å°¾", rate:5}, {name:"æ¯›è¾®ç¾Š", rate:5}, {name:"ä¼Šå¸ƒ", rate:10}, {name:"çš®å¡ä¸˜", rate:10}, {name:"çš®çš®", rate:10}, {name:"èƒ–ä¸", rate:10}, {name:"å¤§è”¥é´¨", rate:10}, {name:"å‘†å‘†ç¸", rate:12.5}, {name:"å¯é”é´¨", rate:12.5}],
                "ğŸ”µ ä¸­ç´š": [{name:"å¦™è›™ç¨®å­", rate:10}, {name:"å°ç«é¾", rate:10}, {name:"å‚‘å°¼é¾œ", rate:10}, {name:"ä¼Šå¸ƒ", rate:10}, {name:"çš®å¡ä¸˜", rate:10}, {name:"å‘†å‘†ç¸", rate:10}, {name:"å¯é”é´¨", rate:10}, {name:"æ¯›è¾®ç¾Š", rate:10}, {name:"å¡æ¯”ç¸", rate:5}, {name:"å‰åˆ©è›‹", rate:3}, {name:"æ‹‰æ™®æ‹‰æ–¯", rate:3}, {name:"å¦™è›™èŠ±", rate:3}, {name:"å™´ç«é¾", rate:3}, {name:"æ°´ç®­é¾œ", rate:3}],
                "ğŸŸ£ é«˜ç´š": [{name:"å¡æ¯”ç¸", rate:20}, {name:"å‰åˆ©è›‹", rate:20}, {name:"å¹¸ç¦è›‹", rate:10}, {name:"æ‹‰æ™®æ‹‰æ–¯", rate:10}, {name:"å¦™è›™èŠ±", rate:10}, {name:"å™´ç«é¾", rate:10}, {name:"æ°´ç®­é¾œ", rate:10}, {name:"å¿«é¾", rate:5}, {name:"è€¿é¬¼", rate:5}],
                "ğŸ¬ ç³–æœ": [{name:"ä¼Šå¸ƒ", rate:20}, {name:"çš®å¡ä¸˜", rate:20}, {name:"å¦™è›™èŠ±", rate:10}, {name:"å™´ç«é¾", rate:10}, {name:"æ°´ç®­é¾œ", rate:10}, {name:"å¡æ¯”ç¸", rate:10}, {name:"å‰åˆ©è›‹", rate:10}, {name:"å¹¸ç¦è›‹", rate:4}, {name:"æ‹‰æ™®æ‹‰æ–¯", rate:3}, {name:"å¿«é¾", rate:3}],
                "âœ¨ é»ƒé‡‘": [{name:"å¡æ¯”ç¸", rate:30}, {name:"å‰åˆ©è›‹", rate:35}, {name:"å¹¸ç¦è›‹", rate:20}, {name:"æ‹‰æ™®æ‹‰æ–¯", rate:5}, {name:"å¿«é¾", rate:5}, {name:"è€¿é¬¼", rate:5}],
                "ğŸ‘‘ å‚³èªª": [{name:"æ€¥å‡é³¥", rate:25}, {name:"ç«ç„°é³¥", rate:25}, {name:"é–ƒé›»é³¥", rate:25}, {name:"é³³ç‹", rate:7.5}, {name:"æ´›å¥‡äº", rate:7.5}, {name:"è¶…å¤¢", rate:5}, {name:"å¤¢å¹»", rate:5}],
                "ğŸ’° å‚³å¥‡": [{name:"å¿«é¾", rate:30}, {name:"è€¿é¬¼", rate:20}, {name:"æ€¥å‡é³¥", rate:15}, {name:"ç«ç„°é³¥", rate:15}, {name:"é–ƒé›»é³¥", rate:15}, {name:"é³³ç‹", rate:2}, {name:"æ´›å¥‡äº", rate:2}, {name:"è¶…å¤¢", rate:0.5}, {name:"å¤¢å¹»", rate:0.5}]
            };

            const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };
            const safeFetch = async (url, options = {}) => {
                const token = localStorage.getItem('token');
                if (!token) { logout(); return null; }
                const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
                const res = await fetch(url, { ...options, headers });
                if (res.status === 401) { logout(); return null; }
                return res;
            };

            const getSkillDesc = (name) => { 
                if (!skillData.value) return "";
                const s = skillData.value[name]; 
                return s ? `${s.dmg}å‚· ${s.desc || ''}` : ''; 
            };
            
            const normalizeName = (name) => { if (!name) return ""; return name.replace(/ğŸ”¥ |âœ¨ |å¼·å¤§çš„ |é–ƒå…‰ /g, "").trim(); };
            const getMonSkills = (name) => SKILL_MAP[normalizeName(name)] || ["æ’æ“Š", "æ’æ“Š", "æ’æ“Š"];
            const closeNews = () => { newsState.value.show = false; sessionStorage.setItem('seenNews_v21511', 'true'); }; // ğŸ”¥ Version bump
            
            const calcStats = (mon) => { 
                const realName = normalizeName(mon.name);
                const base = pokedexMap.value[realName] || { hp: 100, atk: 10 }; 
                const ivMult = 0.8 + ((mon.iv || 50) / 100) * 0.4; 
                const hp = Math.floor(base.hp * ivMult * (1.033 ** ((mon.lv || 1) - 1))); 
                const atk = Math.floor(base.atk * ivMult * (1.034 ** ((mon.lv || 1) - 1))); 
                return { hp, atk }; 
            };
            
            const viewPokedexEntry = (p) => { const realName = normalizeName(p.name); const base = pokedexMap.value[realName]; if (base) { viewMon.value = { name: p.name, iv: null, lv: null, exp: null, hp_val: base.hp, atk_val: base.atk, img_src: base.img, is_demo: true }; } };
            const viewBoxMon = (p) => { const realName = normalizeName(p.name); const base = pokedexMap.value[realName]; trainMode.value.show = false; if (!base) { viewMon.value = { ...p, hp_val: "???", atk_val: "???", img_src: "https://via.placeholder.com/150", is_demo: false }; return; } const stats = calcStats(p); viewMon.value = { ...p, hp_val: stats.hp, atk_val: stats.atk, img_src: base.img, is_demo: false }; };
            const forceCloseBattle = () => { battle.value.active = false; isEnemyTurn.value = false; clearInterval(timerInterval); };
            const showFloatingText = (text, color='red', isEnemy=false) => { const arena = document.querySelector('.battle-arena'); if(!arena) return; const el = document.createElement('div'); el.className = 'floating-text'; el.innerText = text; el.style.color = color === 'gold' ? '#f1c40f' : (color === 'green' ? '#2ecc71' : (color === 'blue' ? '#3498db' : '#e74c3c')); el.style.left = isEnemy ? '60%' : '20%'; el.style.top = '30%'; arena.appendChild(el); setTimeout(() => el.remove(), 1500); };
            const getMonImage = (name) => { if (!name) return "https://via.placeholder.com/150"; const realName = normalizeName(name); const base = pokedexMap.value[realName]; if (base && base.img) return base.img; if (user.value && user.value.pokemon_name === name && user.value.pokemon_image) return user.value.pokemon_image; return "https://via.placeholder.com/150"; };

            const updateInfo = async () => { 
                try { 
                    const res = await safeFetch(`${API_URL}/auth/me`); 
                    if(res && res.ok) { 
                        user.value = await res.json(); 
                        if(selectedWildLevel.value > user.value.level) selectedWildLevel.value = user.value.level; 
                        // ğŸ”¥ è®€å– PVP è¨­å®š
                        if (user.value.inventory) {
                            try { const inv = JSON.parse(user.value.inventory); pvpBlocked.value = !!inv.block_pvp; } catch(e){}
                        }
                    } 
                } catch(e) {} 
            };

            const togglePvpSettings = async () => {
                const res = await safeFetch(`${API_URL.replace('/items','')}/shop/social/settings/toggle_pvp`, { method: 'POST' });
                if (res && res.ok) {
                    const d = await res.json();
                    pvpBlocked.value = d.block_pvp;
                    showToast("è¨­å®šæ›´æ–°", d.message);
                }
            };

            // ... (fetchPokedex, fetchPlayers, fetchQuests, fetchLeaderboard, fetchWildList, fetchSkillData, updateMySkills, releaseMon, checkRaid)
            const fetchPokedex = async () => { try { const res = await safeFetch(`${API_URL.replace('/items','')}/shop/pokedex/all`); if(res && res.ok) { const allMons = await res.json(); allMons.forEach(m => pokedexMap.value[m.name] = m); } const res2 = await safeFetch(`${API_URL.replace('/items','')}/shop/pokedex/collection`); if(res2 && res2.ok) { pokedexCollection.value = await res2.json(); const ownedCount = pokedexCollection.value.filter(x => x.is_owned).length; pokedexPercent.value = Math.floor((ownedCount / pokedexCollection.value.length) * 100); } } catch(e) {} };
            const fetchPlayers = async () => { const res = await safeFetch(`${API_URL.replace('/items','')}/shop/social/players`); if(res && res.ok) { const data = await res.json(); players.value = data.filter(p => p.id !== user.value.id); } };
            const fetchQuests = async () => { const res = await safeFetch(`${API_URL}/quests/`); if(res && res.ok) quests.value = await res.json(); updateInfo(); };
            const fetchLeaderboard = async () => { const res = await safeFetch(`${API_URL.replace('/items','')}/shop/leaderboard?type=${leaderboardType.value}`); if(res && res.ok) leaderboardData.value = await res.json(); };
            const fetchWildList = async () => { 
                wildList.value = []; 
                const res = await safeFetch(`${API_URL.replace('/items','')}/shop/wild/list?level=${selectedWildLevel.value}`); 
                if(res && res.ok) wildList.value = await res.json(); 
            };
            const fetchSkillData = async () => { const res = await fetch(`${API_URL.replace('/items','')}/shop/data/skills`); if(res.ok) skillData.value = await res.json(); };
            const updateMySkills = () => { if(!user.value || !box.value) return; const active = box.value.find(p => p.uid === user.value.active_pokemon_uid); if(active) mySkills.value = getMonSkills(active.name); };
            const releaseMon = async (uid) => { if(!confirm("ç¢ºå®šè¦æ”¾ç”Ÿé€™éš»å¯¶å¯å¤¢å—ï¼Ÿ")) return; const res = await safeFetch(`${API_URL.replace('/items','')}/shop/box/action/release/${uid}`, { method: 'POST' }); if(res && res.ok) { const d = await res.json(); showToast("ç³»çµ±", d.message); viewMon.value = null; updateInfo(); } else if(res) { const d = await res.json(); showToast("éŒ¯èª¤", d.detail); } };
            
            const checkRaid = async () => {
                const res = await safeFetch(`${API_URL.replace('/items','')}/shop/raid/status`);
                if(res && res.ok) {
                    const data = await res.json();
                    raidState.value = data;
                    if (battle.value.active && battle.value.mode === 'raid') {
                        battle.value.target.hp = data.hp; battle.value.target.max_hp = data.max_hp;
                        if (data.user_hp !== undefined) { if (data.user_hp < user.value.hp) { battle.value.shakeMe = true; showFloatingText(`-${user.value.hp - data.user_hp}`, 'red'); setTimeout(() => battle.value.shakeMe = false, 400); } user.value.hp = data.user_hp; }
                    }
                    if (data.status === 'ENDED' && data.my_status && !data.my_status.claimed && !raidVictory.value && data.is_participant) { raidVictory.value = true; }
                    if (data.my_status && data.my_status.dead_at) { if (!isRaidDead.value) { isRaidDead.value = true; raidDeadTimer.value = 5; deadInterval = setInterval(() => { raidDeadTimer.value--; if(raidDeadTimer.value <= 0) { clearInterval(deadInterval); showToast("ç³»çµ±", "ä½ å·²è¢«è¸¢å‡ºåœ˜é«”æˆ°"); isRaidDead.value = false; battle.value.active = false; } }, 1000); } } else { if (isRaidDead.value) { isRaidDead.value = false; clearInterval(deadInterval); } }
                }
            };

            const checkInvite = async () => {
                const res = await safeFetch(`${API_URL.replace('/items','')}/shop/social/check_invite`);
                if (res && res.ok) {
                    const d = await res.json();
                    if (d.has_invite) {
                        invite.value = d;
                    }
                }
            };

            const startWildBattle = (target) => { 
                shieldUses.value = 2; updateMySkills(); battle.value.atkBuff = 1.0; battle.value.shieldActive = false;
                let t = JSON.parse(JSON.stringify(target)); t.hp = Number(t.hp); t.max_hp = Number(t.max_hp); t.attack = Number(t.attack);
                if(Math.random() < 0.1) { t.is_powerful = true; t.raw_name = t.name; t.name = "ğŸ”¥ å¼·å¤§çš„ " + t.name; t.hp = Math.floor(t.hp * 1.2); t.max_hp = t.hp; t.attack = Math.floor(t.attack * 1.2); } else { t.is_powerful = false; t.raw_name = t.name; }
                battle.value = { active: true, mode: 'wild', target: t, shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false }; 
                turnTimer.value = 10; isEnemyTurn.value = false; startTurnTimer(); 
            };
            
            const startTurnTimer = () => { clearInterval(timerInterval); turnTimer.value = 10; if (battle.value.mode !== 'wild') return; timerInterval = setInterval(() => { turnTimer.value--; if(turnTimer.value <= 0) { clearInterval(timerInterval); isEnemyTurn.value = true; showFloatingText("é€¾æ™‚!", "red"); setTimeout(enemyAttackPhase, 1000); } }, 1000); };
            
            const enemyAttackPhase = () => { 
                if(battle.value.shieldActive) { 
                    const reflectDmg = Math.floor(battle.value.target.attack * 0.15 * (0.95 + Math.random() * 0.1)); 
                    battle.value.target.hp -= reflectDmg; showFloatingText(`åå‚· ${reflectDmg}`, 'gold'); 
                    if (battle.value.target.hp <= 0 && battle.value.mode === 'wild') { clearInterval(timerInterval); handleBattleWin(); return; }
                    battle.value.shieldActive = false; isEnemyTurn.value = false; startTurnTimer(); 
                } else { 
                    const rawDmg = Math.floor(battle.value.target.attack * 0.2); 
                    const enemyDmg = Math.floor(rawDmg * (0.95 + Math.random() * 0.1)); 
                    user.value.hp = Math.max(0, user.value.hp - enemyDmg); 
                    battle.value.shakeMe = true; setTimeout(() => battle.value.shakeMe = false, 400); showFloatingText(`-${enemyDmg}`, 'red'); 
                    if(user.value.hp <= 0) { showToast("æˆ°æ•—", "ä½ è¢«æ‰“æ•—äº†..."); battle.value.active = false; safeFetch(`${API_URL.replace('/items','')}/shop/wild/attack?is_win=false`, { method: 'POST' }); buyHeal(); } else { isEnemyTurn.value = false; startTurnTimer(); } 
                } 
            };
            
            const handleBattleWin = async () => {
                const safeName = encodeURIComponent(battle.value.target.raw_name);
                const tLv = battle.value.target.level; 
                const res = await safeFetch(`${API_URL.replace('/items','')}/shop/wild/attack?is_win=true&is_powerful=${battle.value.target.is_powerful||false}&target_name=${safeName}&target_level=${tLv}`, { method: 'POST' });
                if (res) {
                    const d = await res.json();
                    battleResultMsg.value = d.message; showBattleResult.value = true; battle.value.active = false; updateInfo(); setTimeout(fetchQuests, 500);
                }
            };

            const doSkillAttack = async (skillName) => { 
                if(isEnemyTurn.value) return; 
                if(!skillData.value[skillName]) return; 
                try { 
                    isEnemyTurn.value = true; clearInterval(timerInterval); 
                    const skill = skillData.value[skillName]; let healAmt = 0; 
                    let debuffFlag = 0;

                    if (skill.effect === 'buff_atk' && Math.random() < skill.prob) { battle.value.atkBuff *= (1 + skill.val); showFloatingText(`ATK UP!`, 'gold'); } 
                    else if (skill.effect === 'heal' && Math.random() < skill.prob) { 
                        healAmt = Math.floor(user.value.max_hp * skill.val); 
                        user.value.hp = Math.min(user.value.max_hp, user.value.hp + healAmt); 
                        showFloatingText(`+${healAmt}`, 'green'); 
                    } 
                    
                    // ğŸ”¥ ä¿®æ­£ï¼šDebuff é™ä½è‡ªå·±æ”»æ“Š (å‰¯ä½œç”¨)
                    else if (skill.effect === 'debuff_atk' && Math.random() < skill.prob) {
                        debuffFlag = 1; // å‘Šè¨´å¾Œç«¯è¦ debuff
                        
                        // é‡å¤–æˆ°ï¼šç›´æ¥é™ä½è‡ªå·±å‰ç«¯é¡¯ç¤ºçš„æ”»æ“Šå€ç‡
                        if (battle.value.mode === 'wild') {
                            battle.value.atkBuff *= (1 - skill.val);
                        }
                        // ğŸ”¥ åœ˜é«”æˆ°ï¼šä¹Ÿè¦é™ä½å‰ç«¯æ”»æ“Šå€ç‡
                        else if (battle.value.mode === 'raid') {
                             battle.value.atkBuff *= (1 - skill.val);
                             showFloatingText('My ATK â†˜', 'blue', false);
                        }

                        // é¡¯ç¤ºåœ¨è‡ªå·±é ­ä¸Š
                        if (battle.value.mode !== 'raid') showFloatingText('My ATK â†˜', 'blue', false);
                    }
                    else if (skill.effect === 'recoil' && Math.random() < skill.prob) {
                        const recoilAmt = Math.floor(user.value.max_hp * skill.val);
                        user.value.hp = Math.max(0, user.value.hp - recoilAmt);
                        showFloatingText(`-${recoilAmt}`, 'red');
                        if (user.value.hp <= 0) { 
                            showToast("æˆ°æ•—", "ä½ å—åˆ°åä½œç”¨åŠ›å€’ä¸‹äº†..."); 
                            battle.value.active = false; 
                            safeFetch(`${API_URL.replace('/items','')}/shop/wild/attack?is_win=false`, { method: 'POST' }); 
                            buyHeal();
                            return;
                        }
                    }

                    // è¨ˆç®—å‚·å®³æ™‚ï¼Œå› ç‚º atkBuff å·²ç¶“é™ä½äº†ï¼Œæ‰€ä»¥å‚·å®³æœƒè‡ªç„¶è®Šä½
                    let rawDmg = Math.floor((user.value.attack / 100) * skill.dmg * battle.value.atkBuff); 
                    let dmg = Math.floor(rawDmg * (0.95 + Math.random() * 0.1)); if (dmg < 1) dmg = 1; 
                    
                    battle.value.shakeTarget = true; setTimeout(() => battle.value.shakeTarget = false, 400); showFloatingText(`-${dmg}`, 'red', true); 
                    
                    if(battle.value.mode === 'wild') { 
                        battle.value.target.hp = Math.max(0, battle.value.target.hp - dmg); 
                        if(battle.value.target.hp <= 0) { handleBattleWin(); } else { setTimeout(enemyAttackPhase, 1200); } 
                    } else if (battle.value.mode === 'gym') {
                        // ğŸ”¥ å‚³é€ debuff åƒæ•¸çµ¦å¾Œç«¯ (å¾Œç«¯æœƒé™ä½ player_atk_mult)
                        const res = await safeFetch(`${API_URL.replace('/items','')}/shop/gym/battle/attack/${battleId}?damage=${dmg}&heal=${healAmt}&debuff=${debuffFlag}`, { method: 'POST' });
                        if(res && res.ok) {
                            const d = await res.json();
                            if(d.result === 'WIN_SELECT') { showToast("å‹åˆ©", d.reward); battle.value.active = false; pendingGymId.value = d.gym_id; showDefenderSelect.value = true; updateInfo(); fetchGymList(); }
                            else if(d.result === 'LOSE') { showToast("å¤±æ•—", d.reward); battle.value.active = false; updateInfo(); }
                            else { 
                                battle.value.target.hp = d.boss_hp; 
                                // ğŸ”¥ ä¿®æ­£ï¼šé€™è£¡ç§»é™¤é‡è¤‡åŠ è¡€é‚è¼¯ï¼Œåªé€²è¡Œæœ€çµ‚è¡€é‡åŒæ­¥
                                if (d.user_hp !== undefined) { user.value.hp = d.user_hp; }

                                setTimeout(() => {
                                    if(d.boss_dmg > 0) { showFloatingText(`-${d.boss_dmg}`, 'red'); battle.value.shakeMe = true; setTimeout(()=>battle.value.shakeMe=false, 400); user.value.hp = d.user_hp; }
                                    isEnemyTurn.value = false;
                                }, 600);
                            }
                        } else { console.error("Gym API Error"); battle.value.active = false; }
                    }
                    else if (battle.value.mode === 'raid') { 
                        const res = await safeFetch(`${API_URL.replace('/items','')}/shop/raid/attack?damage=${dmg}`, { method: 'POST' }); 
                        if(res) { const d = await res.json(); if(d.boss_hp !== undefined) battle.value.target.hp = d.boss_hp; }
                        setTimeout(() => { isEnemyTurn.value = false; startTurnTimer(); }, 800); 
                    } else if (battle.value.mode === 'pvp') {
                        // ğŸ”¥ PVP æ™‚ debuff=1 æœƒé™ä½æ”»æ“Šæ–¹è‡ªå·±çš„å€ç‡
                        const res = await safeFetch(`${API_URL.replace('/items','')}/shop/duel/attack?damage=${dmg}&heal=${healAmt}&debuff=${debuffFlag}`, { method: 'POST' });
                        if(res) { 
                            const d = await res.json(); 
                            if(d.result === 'WIN') { showToast("æˆ°é¬¥çµæŸ", d.reward); battle.value.active = false; updateInfo(); isBattleResultShown.value = false; } 
                        }
                    }
                } catch (e) { console.error(e); battle.value.active = false; } 
            };

            // ğŸ”¥ æ‰¹é‡æ“ä½œ UI
            const openBulkBuy = (type, name, price) => {
                bulkState.value = { show: true, type: 'buy', targetId: type, name: name, price: price };
            };
            
            const openBulkCandy = (uid) => {
                bulkState.value = { show: true, type: 'candy', targetId: uid, name: 'é¤µé£Ÿç³–æœ', price: 0 };
            };
            
            const confirmBulkAction = async (count) => {
                bulkState.value.show = false;
                if (bulkState.value.type === 'buy') {
                    const totalCost = bulkState.value.price * count;
                    if (!confirm(`ç¢ºå®šè³¼è²· ${count} å€‹ ${bulkState.value.name}ï¼Ÿ\nç¸½åƒ¹: ${totalCost} G`)) return;
                    const res = await safeFetch(`${API_URL.replace('/items','')}/shop/buy/${bulkState.value.targetId}?count=${count}`, { method: 'POST' });
                    if(res && res.ok) { const d = await res.json(); showToast("è³¼è²·æˆåŠŸ", d.message); if(d.user) user.value = d.user; }
                    else if(res) { const d = await res.json(); showToast("è³¼è²·å¤±æ•—", d.detail); }
                } else if (bulkState.value.type === 'candy') {
                    const res = await safeFetch(`${API_URL.replace('/items','')}/shop/box/action/candy/${bulkState.value.targetId}?count=${count}`, { method: 'POST' });
                    if(res) { const d = await res.json(); showToast("ç³»çµ±", d.message || d.detail); updateInfo(); }
                }
            };

            const playGacha = async (type) => { showGachaAnim.value = true; const res = await safeFetch(`${API_URL.replace('/items','')}/shop/gacha/${type}`, { method: 'POST' }); if(res && res.ok) { const d = await res.json(); setTimeout(() => { showGachaAnim.value = false; gachaResult.value = d; updateInfo(); }, 2000); } else { showGachaAnim.value = false; if(res) { const d = await res.json(); showToast("éŒ¯èª¤", d.detail); } } };
            const useShield = () => { if(shieldUses.value <= 0) return; shieldUses.value--; battle.value.shieldActive = true; isEnemyTurn.value = true; clearInterval(timerInterval); setTimeout(enemyAttackPhase, 1200); };
            
            const doHeal = async () => { 
                if (battle.value.mode === 'gym') {
                    isEnemyTurn.value = true;
                    const res = await safeFetch(`${API_URL.replace('/items','')}/shop/gym/battle/attack/${battleId}?damage=0&heal=1`, { method: 'POST' });
                    if (res && res.ok) {
                        const d = await res.json();
                        // ğŸ”¥ ä¿®æ­£ï¼šåªåŒæ­¥è¡€é‡ï¼Œä¸å†é‡è¤‡é¡¯ç¤º+HPå‹•ç•« (å› ç‚ºå‰ç«¯ä¸€é–‹å§‹å°±é¡¯ç¤ºäº†)
                        if (d.real_heal_amt > 0) { user.value.hp = Math.min(user.value.max_hp, user.value.hp + d.real_heal_amt); }
                        setTimeout(() => {
                            if (d.boss_dmg > 0) { showFloatingText(`-${d.boss_dmg}`, 'red'); battle.value.shakeMe = true; setTimeout(() => battle.value.shakeMe = false, 400); user.value.hp = d.user_hp; }
                            if (d.result === 'LOSE') { showToast("å¤±æ•—", d.reward); battle.value.active = false; updateInfo(); } else { isEnemyTurn.value = false; }
                        }, 600);
                    }
                } else {
                    const heal = Math.floor(user.value.max_hp * 0.2); 
                    user.value.hp = Math.min(user.value.max_hp, user.value.hp + heal); 
                    showToast("ç³»çµ±", `å›å¾©äº† ${heal} HP`); 
                    if (battle.value.mode === 'pvp') { await safeFetch(`${API_URL.replace('/items','')}/shop/duel/attack?damage=0&heal=${heal}`, { method: 'POST' }); isEnemyTurn.value = true; }
                }
            };
            
            const dailyCheckin = async () => { const res = await safeFetch(`${API_URL.replace('/items','')}/shop/social/daily_checkin`, { method: 'POST' }); if(res && res.ok) { const d = await res.json(); showToast("ç°½åˆ°", d.message || d.detail); updateInfo(); } else if(res) { const d = await res.json(); showToast("éŒ¯èª¤", d.detail || "ç°½åˆ°å¤±æ•—"); } };
            const swapMon = async (uid) => { await safeFetch(`${API_URL.replace('/items','')}/shop/box/swap/${uid}`, { method: 'POST' }); updateInfo(); };
            const useCandy = (uid) => { openBulkCandy(uid); };
            const doGamble = async () => { const res = await safeFetch(`${API_URL.replace('/items','')}/shop/gamble?amount=${gambleAmount.value}`, { method: 'POST' }); if(res) { const d = await res.json(); showToast("è³­å ´", d.message || d.detail); updateInfo(); } };
            const buyHeal = async () => { const res = await safeFetch(`${API_URL.replace('/items','')}/shop/heal`, { method: 'POST' }); if(res && res.ok) { showToast("ç³»çµ±", "è£œè¡€æˆåŠŸ"); updateInfo(); } else showToast("éŒ¯èª¤", "é‡‘å¹£ä¸è¶³"); };
            const redeemCode = async () => { const res = await safeFetch(`${API_URL.replace('/items','')}/shop/social/redeem?code=${promoCode.value}`, { method: 'POST' }); if(res) { const d = await res.json(); showToast("ç³»çµ±", d.message || d.detail); updateInfo(); } };
            const sendInvite = async (p) => { 
                const res = await safeFetch(`${API_URL.replace('/items','')}/shop/social/invite/${p.id}`, { method: 'POST' }); 
                if(res && res.ok) showToast("ç³»çµ±", "å·²ç™¼é€é‚€è«‹ï¼Œç­‰å¾…å°æ–¹å›æ‡‰..."); 
                else if (res) { const d = await res.json(); showToast("éŒ¯èª¤", d.detail); }
            };
            const acceptInvite = async () => { await safeFetch(`${API_URL.replace('/items','')}/shop/social/accept_invite/${invite.value.source_id}`, { method: 'POST' }); invite.value.has_invite = false; duelState.value.preparing = true; };
            const rejectInvite = async () => { await safeFetch(`${API_URL.replace('/items','')}/shop/social/reject_invite/${invite.value.source_id}`, { method: 'POST' }); invite.value.has_invite = false; };

            const checkDuelStatus = async () => {
                const res = await safeFetch(`${API_URL.replace('/items','')}/shop/duel/status`);
                if (res && res.ok) {
                    const d = await res.json();
                    if (d.status === 'PREPARING') { duelState.value.preparing = true; duelState.value.countdown = Math.ceil(d.remaining); } 
                    else if (d.status === 'FIGHTING') {
                        duelState.value.preparing = false;
                        if (!battle.value.active) {
                            battle.value = { active: true, mode: 'pvp', target: { ...d.opponent_data, image_url: d.opponent_data.img }, shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false };
                            user.value.hp = d.my_data.hp; user.value.max_hp = d.my_data.max_hp; mySkills.value = getMonSkills(d.my_data.pname);
                        }
                        user.value.hp = d.my_data.hp; battle.value.target.hp = d.opponent_data.hp; isEnemyTurn.value = !d.is_my_turn;
                    } 
                    else if (d.status === 'ENDED') { 
                        if (battle.value.active && battle.value.mode === 'pvp') { 
                            battle.value.active = false; 
                            if (!isBattleResultShown.value) {
                                if (d.my_data.hp <= 0) showToast("æˆ°æ•—", "ğŸ’€ ä½ è¼¸äº†..."); else showToast("å‹åˆ©", "ğŸ† æ­å–œå‹åˆ©ï¼"); 
                                isBattleResultShown.value = true;
                            }
                            updateInfo(); 
                        } 
                    }
                }
            };
            
            const isLegendary = (name) => ["æ€¥å‡é³¥", "ç«ç„°é³¥", "é–ƒé›»é³¥", "è¶…å¤¢", "å¤¢å¹»", "é³³ç‹", "æ´›å¥‡äº"].includes(normalizeName(name));
            const trainMon = async (uid) => { if (!confirm(`ç¢ºå®šç‰¹è¨“å—ï¼Ÿ`)) return; const res = await safeFetch(`${API_URL.replace('/items','')}/shop/box/action/train?pokemon_uid=${uid}&mode=${trainMode.value.type}`, { method: 'POST' }); if (res && res.ok) { const d = await res.json(); showToast("ç‰¹è¨“æˆåŠŸ", d.message); viewMon.value.iv = d.iv; if(d.user) user.value = d.user; trainMode.value.show = false; const stats = calcStats(viewMon.value); viewMon.value.hp_val = stats.hp; viewMon.value.atk_val = stats.atk; } else if (res) { const d = await res.json(); showToast("ç‰¹è¨“å¤±æ•—", d.detail); } };

            const fetchGymList = async () => { const res = await safeFetch(`${API_URL.replace('/items','')}/shop/gym/list`); if(res && res.ok) gymList.value = await res.json(); };
            
            const startGymBattle = async (gymId) => {
                const res = await safeFetch(`${API_URL.replace('/items','')}/shop/gym/battle/start/${gymId}`, { method: 'POST' });
                if(res && res.ok) {
                    const d = await res.json();
                    if(d.result === 'OCCUPIED' || d.result === 'COLLECTED') { showToast("ç³»çµ±", d.message); fetchGymList(); updateInfo(); }
                    else if(d.result === 'BATTLE_START') {
                        battleId = d.battle_id;
                        battle.value = { active: true, mode: 'gym', target: { ...d.opponent, image_url: d.opponent.img }, shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false };
                        shieldUses.value = 0; 
                        updateMySkills();
                        isEnemyTurn.value = false;
                    } 
                    else if(d.result === 'EMPTY') {
                        showToast("ç³»çµ±", d.message);
                        pendingGymId.value = gymId;
                        showDefenderSelect.value = true;
                    }
                    else if(d.result === 'WAIT') { showToast("ç³»çµ±", d.message); }
                } else if(res) { const d = await res.json(); showToast("éŒ¯èª¤", d.detail); }
            };

            const selectDefender = async (pokemon) => {
                if(!pendingGymId.value) return;
                try {
                    const res = await safeFetch(`${API_URL.replace('/items','')}/shop/gym/occupy/${pendingGymId.value}?pokemon_uid=${pokemon.uid}`, { method: 'POST' });
                    if(res && res.ok) {
                        const d = await res.json();
                        showToast("ç³»çµ±", d.message);
                        showDefenderSelect.value = false;
                        pendingGymId.value = null;
                        fetchGymList();
                    } else if(res) {
                        const d = await res.json();
                        showToast("éŒ¯èª¤", d.detail);
                    }
                } catch(e) { console.error(e); }
            };

            const joinRaid = async () => { if(confirm("æ”¯ä»˜ 1000G åŠ å…¥ï¼Ÿ")) { const res = await safeFetch(`${API_URL.replace('/items','')}/shop/raid/join`, { method: 'POST' }); if(res && res.ok) { battle.value = { active: true, mode: 'raid', target: { name: raidState.value.boss_name, hp: raidState.value.hp, max_hp: raidState.value.max_hp, image_url: raidState.value.image }, shakeMe: false, shakeTarget: false, atkBuff: 1.0, shieldActive: false }; shieldUses.value = 2; updateMySkills(); } else if(res) { const d = await res.json(); showToast("éŒ¯èª¤", d.detail); } } };
            const abandonQuest = async (qid) => { if(confirm("æ”¾æ£„éœ€æ¶ˆè€— 1000Gï¼Œç¢ºå®šå—ï¼Ÿ")) { await safeFetch(`${API_URL}/quests/abandon/${qid}`, { method: 'POST' }); fetchQuests(); } };
            const claimQuest = async (qid) => { const res = await safeFetch(`${API_URL}/quests/claim/${qid}`, { method: 'POST' }); if(res) { const d = await res.json(); showToast("ç³»çµ±", d.message); fetchQuests(); } };
            
            const reviveRaid = async () => { 
                const res = await safeFetch(`${API_URL.replace('/items','')}/shop/raid/revive`, { method: 'POST' }); 
                if (res && res.ok) { 
                    isRaidDead.value = false; 
                    raidDeadTimer.value = 0; 
                    clearInterval(deadInterval); 
                    updateInfo(); 
                } else if(res) { 
                    const d = await res.json(); 
                    showToast("éŒ¯èª¤", d.detail); 
                } 
            };
            
            const claimRaidReward = async (choice) => { const res = await safeFetch(`${API_URL.replace('/items','')}/shop/raid/claim?choice=${choice}`, { method: 'POST' }); if(res) { const d = await res.json(); showToast("ç³»çµ±", d.message); raidVictory.value = false; battle.value.active = false; tab.value = 'wild'; updateInfo(); } };
            const useMedKit = async () => { if(shieldUses.value <= 0) return; shieldUses.value--; const healAmt = Math.floor(user.value.max_hp * 0.2); user.value.hp = Math.min(user.value.max_hp, user.value.hp + healAmt); try { await safeFetch(`${API_URL.replace('/items','')}/shop/raid/recover`, { method: 'POST' }); showFloatingText(`+${healAmt}`, 'green'); } catch(e) { console.error("Heal sync failed", e); } };

            const canJoinLobby = computed(() => raidState.value.status === 'LOBBY');

            onUpdated(() => { const chatBox = document.getElementById('chat-box'); if(chatBox) chatBox.scrollTop = chatBox.scrollHeight; });
            onMounted(async () => { 
                document.getElementById('loading').style.display = 'none'; 
                if(!token) return window.location.href = 'login.html'; 
                if (!sessionStorage.getItem('seenNews_v21511')) newsState.value.show = true; 
                await fetchSkillData(); await fetchPokedex(); 
                await updateInfo(); 
                selectedWildLevel.value = 1;
                fetchWildList();

                updateMySkills(); fetchPlayers(); checkRaid(); fetchGymList();
                setInterval(checkRaid, 3000); 
                setInterval(fetchPlayers, 5000); 
                setInterval(checkInvite, 3000); 
                setInterval(checkDuelStatus, 1000); 
                setInterval(fetchGymList, 10000); 
                fetchQuests(); fetchLeaderboard();
            });

            return { 
                user, tab, box, players, viewMon, battle, raidState, inLobby, lobbyTimer, 
                dailyCheckin, logout, playGacha, swapMon, useCandy, gambleAmount, doGamble, chatInput, 
                doSkillAttack, useShield, doHeal, buyHeal, promoCode, redeemCode, joinRaid, 
                playerXpPercent, hpPercent, petXpPercent, currentAtkMe, quests, abandonQuest, claimQuest, 
                wildList, fetchWildList, startWildBattle, showRates, gachaRates, mySkills, shieldUses, 
                getSkillDesc, selectedWildLevel, calcStats, pokedexCollection, pokedexPercent, pokedexMap, getReqXp, 
                showGachaAnim, gachaResult, showBattleResult, battleResultMsg, inventory, 
                leaderboardData, leaderboardType, fetchLeaderboard, newsState, closeNews, 
                currentPetIV, acceptInvite, rejectInvite, sendInvite, canJoinLobby, turnTimer, isEnemyTurn, 
                viewBoxMon, viewPokedexEntry, getMonSkills, forceCloseBattle, 
                raidVictory, isRaidDead, raidDeadTimer, reviveRaid, claimRaidReward, useMedKit, releaseMon, getMonImage,
                invite, duelState, toast, showToast,
                trainMode, trainMon, isLegendary,
                gymList, startGymBattle,
                canJoinLobby, viewPokedexEntry,
                showDefenderSelect, selectDefender,
                bulkState, openBulkBuy, openBulkCandy, confirmBulkAction,
                showRaidRates, raidBossPoolDisplay, pvpBlocked, togglePvpSettings 
            };
        }
    }).mount('#app');
</script>
</body>
</html>